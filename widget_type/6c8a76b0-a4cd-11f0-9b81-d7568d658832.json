{
  "entityType" : "WIDGET_TYPE",
  "entity" : {
    "fqn" : "new_sld_diagram",
    "name" : "New sld diagram",
    "deprecated" : false,
    "image" : null,
    "description" : null,
    "descriptor" : {
      "type" : "latest",
      "sizeX" : 7.5,
      "sizeY" : 3,
      "resources" : [ ],
      "templateHtml" : "<div class=\"plant-tree\">\r\n  <div class=\"pt-bar\">\r\n    <div class=\"pt-title\">Asset & Related Devices</div>\r\n    <div class=\"pt-actions\">\r\n      <button class=\"pt-btn\" id=\"ptRefresh\">Refresh</button>\r\n    </div>\r\n  </div>\r\n\r\n  <div id=\"ptStatus\" class=\"pt-status\">Loading‚Ä¶</div>\r\n\r\n  <div class=\"pt-tree\" id=\"ptTree\" style=\"display:none\">\r\n    <div class=\"pt-assetcard\">\r\n      <div class=\"pt-assethead\">\r\n        <div class=\"pt-assetname\" id=\"ptAssetName\">PLANT A</div>\r\n        <div class=\"pt-assetid\" id=\"ptAssetId\"></div>\r\n      </div>\r\n      <div class=\"pt-connector\"></div>\r\n      <ul id=\"ptDeviceList\" class=\"pt-branch\"></ul>\r\n    </div>\r\n  </div>\r\n</div>\r\n",
      "templateCss" : ".plant-tree { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#0f172a; }\r\n.pt-bar { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }\r\n.pt-title { font-weight:700; font-size:14px; }\r\n.pt-actions { display:flex; gap:6px; }\r\n.pt-btn { font-size:12px; border:1px solid #e5e7eb; background:#fff; padding:6px 10px; border-radius:8px; cursor:pointer; }\r\n.pt-btn:hover { background:#f8fafc; }\r\n.pt-status { font-size:12px; color:#6b7280; padding:6px 0; }\r\n\r\n.pt-tree { background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:16px; }\r\n.pt-assetcard { background:#f8fafc; border:1px solid #e5e7eb; border-radius:14px; padding:12px 12px 6px 12px; }\r\n.pt-assethead { display:flex; align-items:center; justify-content:space-between; }\r\n.pt-assetname { font-weight:800; letter-spacing:.5px; }\r\n.pt-assetid { font-family: ui-monospace, Menlo, Consolas, \"Liberation Mono\", monospace; font-size:11px; color:#6b7280; }\r\n\r\n.pt-connector { height:14px; margin:8px 0 4px 10px; border-left:2px dashed #cbd5e1; }\r\n.pt-branch { list-style:none; margin:0 0 0 22px; padding:0; }\r\n.pt-branch > li { margin:0; padding:6px 0 6px 12px; position:relative; border-left:1px dashed #e2e8f0; }\r\n.pt-branch > li:last-child { border-left-color: transparent; }\r\n.pt-branch > li::before { content:\"\"; position:absolute; left:-1px; top:16px; width:12px; height:1px; background:#e2e8f0; }\r\n\r\n.pt-node { display:flex; align-items:center; gap:8px; }\r\n.pt-dot { width:8px; height:8px; border-radius:50%; background:#10b981; }\r\n.pt-name { font-weight:600; }\r\n.pt-id { margin-left:auto; font-family: ui-monospace, Menlo, Consolas, \"Liberation Mono\", monospace; font-size:11px; color:#6b7280; }\r\n.pt-empty { color:#6b7280; font-size:12px; margin-left:12px; }\r\n",
      "controllerScript" : "/* ThingsBoard widget ‚Äì Plant A tree\r\n   - Pulls relations (Contains) from the asset\r\n   - Resolves names via entity/device APIs (not attributes)\r\n   - Renders ‚Äútop card + dotted connector + device cards‚Äù like your sketch\r\n*/\r\n\r\nconst ASSET_ID = '4c5f3ed0-a4bd-11f0-83ea-d7568d658832';\r\n\r\nfunction $id(id){ return document.getElementById(id); }\r\nfunction esc(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('\"','&quot;').replaceAll(\"'\",'&#039;'); }\r\nfunction setStatus(msg){ const el=$id('sldStatus'); if(el){ el.textContent=msg; el.style.display='block'; } }\r\nfunction hideStatus(){ const el=$id('sldStatus'); if(el){ el.style.display='none'; } }\r\n\r\n// Angular services (ThingsBoard injects these)\r\nlet $inj, relationSvc, entitySvc, deviceSvc, assetSvc;\r\n\r\nself.onInit = function(){\r\n  $inj        = self.ctx.$scope.$injector;\r\n  relationSvc = $inj.get(self.ctx.servicesMap.get('entityRelationService'));\r\n  entitySvc   = $inj.get(self.ctx.servicesMap.get('entityService'));\r\n  deviceSvc   = $inj.get(self.ctx.servicesMap.get('deviceService'));\r\n  assetSvc    = $inj.get(self.ctx.servicesMap.get('assetService'));\r\n\r\n  const btn = $id('sldRefresh');\r\n  if (btn) btn.onclick = () => buildTree(true);\r\n\r\n  buildTree(false);\r\n};\r\n\r\nself.onDataUpdated = function(){};\r\nself.onDestroy = function(){};\r\n\r\n// RxJS Observable ‚Üí Promise\r\nfunction toPromise(obs){\r\n  return new Promise((resolve, reject)=>{\r\n    if(!obs || typeof obs.subscribe!=='function') return resolve(null);\r\n    const sub = obs.subscribe(resolve, reject, ()=>{ try{sub?.unsubscribe();}catch(_){} });\r\n  });\r\n}\r\n\r\n// Robust name lookup WITHOUT attributes\r\nasync function fetchNameById(idObj){\r\n  // Prefer generic entity info\r\n  try{\r\n    const info = await toPromise(entitySvc.getEntityInfo(idObj));\r\n    if (info && info.name) return String(info.name);\r\n  }catch(_){}\r\n  // Type fallbacks\r\n  try{\r\n    if (idObj.entityType === 'ASSET'){\r\n      const a = await toPromise(assetSvc.getAsset(idObj.id));\r\n      if (a && a.name) return String(a.name);\r\n    }else if (idObj.entityType === 'DEVICE'){\r\n      const d = await toPromise(deviceSvc.getDevice(idObj.id));\r\n      if (d && d.name) return String(d.name);\r\n    }\r\n  }catch(_){}\r\n  return idObj.id; // last resort\r\n}\r\n\r\nasync function buildTree(manual){\r\n  try{\r\n    setStatus(manual ? 'Refreshing‚Ä¶' : 'Loading‚Ä¶');\r\n\r\n    const asset = { entityType:'ASSET', id: ASSET_ID };\r\n\r\n    // 1) Asset name\r\n    const assetName = await fetchNameById(asset);\r\n\r\n    // 2) Relations FROM asset ‚Üí Contains ‚Üí DEVICE\r\n    const relInfos = await toPromise(relationSvc.findInfoByFrom(asset));\r\n    const deviceIds = (relInfos || [])\r\n      .filter(r => r?.type === 'Contains' && r?.to?.entityType === 'DEVICE')\r\n      .map(r => r.to);\r\n\r\n    // 3) Resolve device names in parallel\r\n    const devices = await Promise.all(deviceIds.map(async (idObj) => ({\r\n      idObj, name: await fetchNameById(idObj)\r\n    })));\r\n\r\n    // 4) Render\r\n    render(asset, assetName, devices);\r\n\r\n    hideStatus();\r\n    $id('sldCanvas').style.display = 'block';\r\n  }catch(err){\r\n    console.error('Tree load failed', err);\r\n    setStatus('Failed to load (permissions/relations?).');\r\n  }\r\n}\r\n\r\nfunction render(assetIdObj, assetName, deviceEntries){\r\n  // Top card\r\n  const nameEl = $id('sldAssetName');\r\n  const idEl   = $id('sldAssetId');\r\n  if (nameEl) nameEl.textContent = assetName || 'PLANT A';\r\n  if (idEl)   idEl.textContent   = `${assetIdObj.entityType}:${assetIdObj.id}`;\r\n\r\n  // Devices grid\r\n  const grid = $id('sldDevices');\r\n  if (!grid) return;\r\n\r\n  if (!deviceEntries || deviceEntries.length === 0){\r\n    grid.innerHTML = `<div class=\"sld-row\" style=\"grid-column:1/-1;justify-content:center;background:#fff\">\r\n      <span class=\"lab\">No related devices (Contains) found.</span></div>`;\r\n    return;\r\n  }\r\n\r\n  grid.innerHTML = deviceEntries.map(({idObj, name}) => deviceCardHtml(name, idObj)).join('');\r\n}\r\n\r\n// Single device ‚Äúarea‚Äù card (visual-only for now; metrics placeholders kept minimal)\r\nfunction deviceCardHtml(name, idObj){\r\n  const display = esc(name || idObj.id);\r\n  const idtext  = esc(`${idObj.entityType}:${idObj.id}`);\r\n  return `\r\n    <div class=\"sld-card\">\r\n      <div class=\"sld-card-head\">\r\n        <div class=\"sld-icon\">ü§ñ</div>\r\n        <div class=\"sld-name\">${display}</div>\r\n        <div class=\"sld-chip\">Device</div>\r\n      </div>\r\n      <div class=\"sld-row\"><span class=\"lab\">ID</span><span class=\"val\">${idtext}</span></div>\r\n    </div>`;\r\n}\r\n",
      "settingsForm" : [ ],
      "dataKeySettingsForm" : [ ],
      "defaultConfig" : "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{},\"title\":\"New sld diagram\",\"decimals\":null}"
    },
    "externalId" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "6c8a76b0-a4cd-11f0-9b81-d7568d658832"
    },
    "resources" : null,
    "id" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "6c8a76b0-a4cd-11f0-9b81-d7568d658832"
    },
    "scada" : false,
    "tags" : null
  },
  "relations" : [ ],
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}