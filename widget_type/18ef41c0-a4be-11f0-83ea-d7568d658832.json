{
  "entityType" : "WIDGET_TYPE",
  "entity" : {
    "fqn" : "tree_diagram_sld",
    "name" : "TREE DIAGRAM SLD",
    "deprecated" : false,
    "image" : null,
    "description" : null,
    "descriptor" : {
      "type" : "latest",
      "sizeX" : 7.5,
      "sizeY" : 3,
      "resources" : [ ],
      "templateHtml" : "<div class=\"dhw-shell\">\r\n  <div class=\"dhw-toolbar\">\r\n    <div class=\"dhw-left\">\r\n      <strong class=\"dhw-title\">Machines</strong>\r\n      <span class=\"dhw-count\" id=\"dhwCount\">0</span>\r\n    </div>\r\n    <div class=\"dhw-right\">\r\n      <button class=\"dhw-btn\" onclick=\"changeView('grid')\" title=\"Grid view\">Grid</button>\r\n      <button class=\"dhw-btn\" onclick=\"changeView('list')\" title=\"List view\">List</button>\r\n      <button class=\"dhw-btn dhw-refresh\" onclick=\"refreshData()\" title=\"Refresh\">Refresh</button>\r\n    </div>\r\n  </div>\r\n\r\n  <div id=\"gridView\" class=\"dhw-view\">\r\n    <div class=\"dhw-grid\" id=\"dhwGrid\"></div>\r\n  </div>\r\n\r\n  <div id=\"listView\" class=\"dhw-view\" style=\"display:none\">\r\n    <div class=\"dhw-list\" id=\"dhwList\"></div>\r\n  </div>\r\n\r\n  <!-- Simple modal -->\r\n  <div id=\"deviceModal\" class=\"dhw-modal\" style=\"display:none\">\r\n    <div class=\"dhw-modal-dialog\">\r\n      <button class=\"dhw-modal-close\" onclick=\"closeModal()\">√ó</button>\r\n      <div id=\"modalBody\"></div>\r\n    </div>\r\n  </div>\r\n\r\n  <!-- Empty state -->\r\n  <div id=\"emptyState\" class=\"dhw-empty\" style=\"display:none\">\r\n    <div class=\"dhw-empty-icon\">üì≠</div>\r\n    <div>No devices found for this alias.</div>\r\n  </div>\r\n</div>\r\n",
      "templateCss" : ".dhw-shell { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, \"Noto Sans\", \"Apple Color Emoji\", \"Segoe UI Emoji\"; color:#1f2937; }\r\n.dhw-toolbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; gap:8px; }\r\n.dhw-title { font-size:14px; color:#111827; }\r\n.dhw-count { background:#eef2ff; color:#3730a3; border-radius:10px; padding:2px 8px; font-size:12px; margin-left:6px; }\r\n.dhw-right { display:flex; gap:6px; }\r\n.dhw-btn { font-size:12px; border:1px solid #e5e7eb; padding:6px 10px; background:#fff; border-radius:8px; cursor:pointer; }\r\n.dhw-btn:hover { background:#f9fafb; }\r\n.dhw-refresh { border-color:#c7d2fe; }\r\n.dhw-view { width:100%; }\r\n.dhw-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:10px; }\r\n.dhw-list { display:flex; flex-direction:column; gap:10px; }\r\n\r\n.dhw-card { border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fff; cursor:pointer; transition: box-shadow .15s ease; }\r\n.dhw-card:hover { box-shadow:0 6px 18px rgba(0,0,0,0.06); }\r\n.dhw-card-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }\r\n.dhw-name { display:flex; align-items:center; gap:8px; font-weight:600; font-size:14px; color:#111827; }\r\n.dhw-name .dhw-ico { font-size:16px; }\r\n.dhw-badge { display:inline-flex; align-items:center; gap:6px; font-size:11px; border-radius:999px; padding:2px 8px; }\r\n.dhw-dot { width:8px; height:8px; border-radius:50%; }\r\n.dhw-badge.active { background:#ecfdf5; color:#065f46; }\r\n.dhw-badge.idle { background:#fffbeb; color:#92400e; }\r\n.dhw-badge.warning { background:#fff1f2; color:#9f1239; }\r\n.dhw-badge.inactive { background:#f3f4f6; color:#374151; }\r\n.dhw-dot.active { background:#10b981; }\r\n.dhw-dot.idle { background:#f59e0b; }\r\n.dhw-dot.warning { background:#ef4444; }\r\n.dhw-dot.inactive { background:#9ca3af; }\r\n\r\n.dhw-body { display:flex; flex-direction:column; gap:6px; }\r\n.dhw-row { display:flex; align-items:center; justify-content:space-between; font-size:12px; }\r\n.dhw-row .lab { display:flex; align-items:center; gap:6px; color:#4b5563; }\r\n.dhw-row .val { color:#111827; font-variant-numeric: tabular-nums; }\r\n.dhw-row .unit { color:#6b7280; margin-left:4px; }\r\n\r\n.dhw-eff { margin-top:8px; }\r\n.dhw-eff-head { display:flex; align-items:center; justify-content:space-between; font-size:12px; margin-bottom:6px; }\r\n.dhw-eff-bar { height:8px; background:#f3f4f6; border-radius:8px; overflow:hidden; }\r\n.dhw-eff-fill { height:100%; width:0%; background:#10b981; }\r\n.dhw-eff-fill.med { background:#f59e0b; }\r\n.dhw-eff-fill.low { background:#ef4444; }\r\n\r\n.dhw-empty { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; border:1px dashed #e5e7eb; border-radius:12px; padding:20px; color:#6b7280; }\r\n.dhw-empty-icon { font-size:26px; }\r\n\r\n.dhw-modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(15,23,42,0.4); z-index:9999; }\r\n.dhw-modal-dialog { background:#fff; border-radius:12px; padding:14px; width:min(680px, 92vw); position:relative; }\r\n.dhw-modal-close { position:absolute; right:10px; top:8px; border:none; background:transparent; font-size:20px; cursor:pointer; }\r\n.dhw-modal .dhw-card { cursor:default; box-shadow:none; }\r\n\r\n.dhw-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace; font-size:12px; color:#374151; }\r\n",
      "controllerScript" : "/* Multiple-device alias friendly widget\r\n * - Builds/upserts devices from BOTH ctx.datasources and ctx.data\r\n * - Renders all devices in Grid/List\r\n * - Safe if alias contains 0/1/N devices; updates live\r\n */\r\n\r\nvar currentView = 'grid';          // default to grid so you see many at once\r\nvar deviceMap = new Map();         // id -> { id, name, type, label, metrics:{} }\r\nvar selfRef = self;                // TB scope alias\r\n\r\nself.onInit = function () {\r\n  try {\r\n    bootstrap();\r\n  } catch (e) {\r\n    // swallow to avoid TB console noise\r\n    // console.error(e);\r\n  }\r\n};\r\n\r\nself.onDataUpdated = function () {\r\n  try {\r\n    upsertFromCtx();      // read new data and update devices\r\n    render();             // redraw current view\r\n  } catch (e) {\r\n    // console.error(e);\r\n  }\r\n};\r\n\r\nself.onResize = function () {\r\n  // optional: could reflow responsive grid; not needed here\r\n};\r\n\r\nself.onDestroy = function () {};\r\n\r\n/* ---------- Core: build/upsert devices ---------- */\r\n\r\nfunction bootstrap() {\r\n  // 1) Seed from datasources (may already be expanded per alias)\r\n  if (selfRef.ctx && Array.isArray(selfRef.ctx.datasources)) {\r\n    selfRef.ctx.datasources.forEach(function (ds) {\r\n      var id = ds?.entityId?.id;\r\n      if (!id) return;\r\n      ensureDevice({\r\n        id: id,\r\n        type: ds?.entityType || 'UNKNOWN',\r\n        name: ds?.entityName || ds?.name || ds?.entityLabel || ('Device ' + id.slice(-4)),\r\n        label: ds?.entityLabel || ds?.name || ds?.entityName || ''\r\n      });\r\n    });\r\n  }\r\n\r\n  // 2) Seed from current data payload (covers dynamic alias fan-out)\r\n  upsertFromCtx();\r\n\r\n  // 3) Initial render\r\n  render();\r\n}\r\n\r\nfunction upsertFromCtx() {\r\n  var data = (selfRef.ctx && Array.isArray(selfRef.ctx.data)) ? selfRef.ctx.data : [];\r\n\r\n  data.forEach(function (series) {\r\n    var ds = series.datasource || {};\r\n    var id = ds?.entityId?.id;\r\n    if (!id) return;\r\n\r\n    var dev = ensureDevice({\r\n      id: id,\r\n      type: ds?.entityType || 'UNKNOWN',\r\n      name: ds?.entityName || ds?.name || ds?.entityLabel || ('Device ' + id.slice(-4)),\r\n      label: ds?.entityLabel || ds?.name || ds?.entityName || ''\r\n    });\r\n\r\n    // Latest value for this key\r\n    var key = series.dataKey?.label || series.dataKey?.name || 'key';\r\n    var rows = Array.isArray(series.data) ? series.data : [];\r\n    var lastVal = rows.length ? rows[rows.length - 1][1] : null;\r\n\r\n    dev.metrics[key] = lastVal;\r\n  });\r\n\r\n  // Update count pill\r\n  var countEl = document.getElementById('dhwCount');\r\n  if (countEl) countEl.textContent = String(deviceMap.size);\r\n}\r\n\r\nfunction ensureDevice(meta) {\r\n  var id = meta.id;\r\n  var existing = deviceMap.get(id);\r\n  if (existing) {\r\n    // refresh name/label if better info comes later\r\n    existing.name = meta.name || existing.name;\r\n    existing.label = meta.label || existing.label;\r\n    existing.type = meta.type || existing.type;\r\n    return existing;\r\n  }\r\n  var dev = {\r\n    id: id,\r\n    name: meta.name || ('Device ' + id.slice(-4)),\r\n    type: meta.type || 'UNKNOWN',\r\n    label: meta.label || '',\r\n    metrics: {}\r\n  };\r\n  deviceMap.set(id, dev);\r\n  return dev;\r\n}\r\n\r\n/* ---------- View logic ---------- */\r\n\r\nfunction sortedDevices() {\r\n  // nice sort: by numeric suffix if present, then by name\r\n  var arr = Array.from(deviceMap.values());\r\n  arr.sort(function (a, b) {\r\n    var na = (a.name || '').match(/\\d+/);\r\n    var nb = (b.name || '').match(/\\d+/);\r\n    var an = na ? parseInt(na[0], 10) : Number.MAX_SAFE_INTEGER;\r\n    var bn = nb ? parseInt(nb[0], 10) : Number.MAX_SAFE_INTEGER;\r\n    if (an !== bn) return an - bn;\r\n    return (a.name || '').localeCompare(b.name || '');\r\n  });\r\n  return arr;\r\n}\r\n\r\nfunction render() {\r\n  var hasDevices = deviceMap.size > 0;\r\n  var empty = document.getElementById('emptyState');\r\n  if (empty) empty.style.display = hasDevices ? 'none' : 'flex';\r\n\r\n  // hide both, then show the chosen\r\n  var gridView = document.getElementById('gridView');\r\n  var listView = document.getElementById('listView');\r\n  if (!gridView || !listView) return;\r\n\r\n  gridView.style.display = (currentView === 'grid') ? 'block' : 'none';\r\n  listView.style.display = (currentView === 'list') ? 'block' : 'none';\r\n\r\n  if (currentView === 'grid') renderGrid();\r\n  else renderList();\r\n}\r\n\r\nfunction renderGrid() {\r\n  var host = document.getElementById('dhwGrid');\r\n  if (!host) return;\r\n  if (deviceMap.size === 0) { host.innerHTML = ''; return; }\r\n\r\n  var html = '';\r\n  sortedDevices().forEach(function (d) { html += deviceCard(d); });\r\n  host.innerHTML = html;\r\n}\r\n\r\nfunction renderList() {\r\n  var host = document.getElementById('dhwList');\r\n  if (!host) return;\r\n  if (deviceMap.size === 0) { host.innerHTML = ''; return; }\r\n\r\n  var html = '';\r\n  sortedDevices().forEach(function (d) { html += deviceCard(d); });\r\n  host.innerHTML = html;\r\n}\r\n\r\n/* ---------- Cards / metrics ---------- */\r\n\r\nfunction deviceIcon(dev) {\r\n  var n = (dev.name || '').toLowerCase();\r\n  if (n.includes('meter') || n.includes('lora')) return 'üì°';\r\n  if (n.includes('press') || n.includes('pump')) return 'üõ†Ô∏è';\r\n  if (n.includes('knit') || n.includes('loom') || n.includes('ck')) return 'üßµ';\r\n  if (n.includes('cut')) return '‚úÇÔ∏è';\r\n  return 'üü£';\r\n}\r\n\r\nfunction metricIcon(key) {\r\n  var k = (key || '').toLowerCase();\r\n  if (k.includes('kwh') || k.includes('energy')) return '‚ö°';\r\n  if (k.includes('current')) return '„Ä∞Ô∏è';\r\n  if (k.includes('voltage')) return 'üîå';\r\n  if (k.includes('power')) return 'üí°';\r\n  if (k.includes('production') || k.includes('count')) return 'üìà';\r\n  if (k.includes('runtime')) return '‚è±Ô∏è';\r\n  if (k.includes('stoptime') || k.includes('downtime')) return '‚è∏Ô∏è';\r\n  if (k.includes('eff')) return 'üìä';\r\n  if (k.includes('temp')) return 'üå°Ô∏è';\r\n  if (k.includes('freq')) return 'üì°';\r\n  return 'üè∑Ô∏è';\r\n}\r\n\r\nfunction formatVal(v, key) {\r\n  if (v === null || v === undefined || v === '' || v === '-') return '<span class=\"val\">-</span>';\r\n  var k = (key || '').toLowerCase(), unit = '', out = v;\r\n\r\n  var num = Number(v); // try numeric formatting when sensible\r\n  if (!isNaN(num)) {\r\n    if (k.includes('kwh') || k.includes('energy')) { out = num.toFixed(2); unit = 'kWh'; }\r\n    else if (k.includes('current')) { out = num.toFixed(2); unit = 'A'; }\r\n    else if (k.includes('voltage')) { out = num.toFixed(1); unit = 'V'; }\r\n    else if (k.includes('power') && !k.includes('active_p')) { out = num.toFixed(2); unit = 'W'; }\r\n    else if (k.includes('freq')) { out = num.toFixed(1); unit = 'Hz'; }\r\n    else if (k.includes('eff') || k.includes('percentage')) { out = num.toFixed(1); unit = '%'; }\r\n    else if (k.includes('prod') || k.includes('count')) { out = Math.floor(num).toLocaleString(); }\r\n    else if (k.includes('temp')) { out = num.toFixed(1); unit = '¬∞C'; }\r\n    else { out = num.toFixed(2); }\r\n  }\r\n  return '<span class=\"val\">' + out + (unit ? '<span class=\"unit\">' + ' ' + unit + '</span>' : '') + '</span>';\r\n}\r\n\r\nfunction deviceStatus(metrics) {\r\n  if (!metrics || !Object.keys(metrics).length) return 'inactive';\r\n  if (metrics.KWH !== undefined) {\r\n    var k = parseFloat(metrics.KWH) || 0;\r\n    return k > 0 ? 'active' : 'inactive';\r\n  }\r\n  if (metrics.Production !== undefined) {\r\n    var p = parseInt(metrics.Production) || 0;\r\n    var e = parseFloat(metrics.Efficiency) || 0;\r\n    if (p === 0) return 'inactive';\r\n    if (e >= 80) return 'active';\r\n    if (e >= 50) return 'idle';\r\n    return 'warning';\r\n  }\r\n  var any = Object.values(metrics).some(function (v) { return v !== null && v !== undefined && v !== '' && v !== '-' && v !== 0 && v !== '0'; });\r\n  return any ? 'active' : 'inactive';\r\n}\r\n\r\nfunction deviceCard(dev) {\r\n  var status = deviceStatus(dev.metrics);\r\n  var badge = '<span class=\"dhw-badge ' + status + '\"><span class=\"dhw-dot ' + status + '\"></span>' + status.charAt(0).toUpperCase() + status.slice(1) + '</span>';\r\n\r\n  // Pull out common metrics if present\r\n  var prod = (dev.metrics.Production !== undefined) ? ('<div class=\"dhw-row\"><span class=\"lab\">' + metricIcon('Production') + ' Production</span>' + formatVal(dev.metrics.Production, 'Production') + '</div>') : '';\r\n  var effHtml = '';\r\n  if (dev.metrics.Efficiency !== undefined) {\r\n    var eff = Math.max(0, Math.min(100, Number(dev.metrics.Efficiency) || 0));\r\n    var barCls = eff >= 80 ? '' : (eff >= 50 ? ' med' : ' low');\r\n    effHtml =\r\n      '<div class=\"dhw-eff\">' +\r\n        '<div class=\"dhw-eff-head\"><span>Efficiency</span><span><strong>' + eff.toFixed(1) + '%</strong></span></div>' +\r\n        '<div class=\"dhw-eff-bar\"><div class=\"dhw-eff-fill' + barCls + '\" style=\"width:' + eff + '%\"></div></div>' +\r\n      '</div>';\r\n  }\r\n\r\n  // Render remaining metrics except Production/Efficiency\r\n  var others = '';\r\n  Object.keys(dev.metrics).forEach(function (k) {\r\n    if (k === 'Production' || k === 'Efficiency') return;\r\n    others += '<div class=\"dhw-row\"><span class=\"lab\">' + metricIcon(k) + ' ' + escapeHtml(k) + '</span>' + formatVal(dev.metrics[k], k) + '</div>';\r\n  });\r\n  if (!prod && !others) {\r\n    others = '<div class=\"dhw-row\"><span class=\"lab\">No data</span><span class=\"val\">-</span></div>';\r\n  }\r\n\r\n  return (\r\n    '<div class=\"dhw-card\" onclick=\"openDeviceModal(\\'' + dev.id + '\\')\">' +\r\n      '<div class=\"dhw-card-head\">' +\r\n        '<div class=\"dhw-name\"><span class=\"dhw-ico\">' + deviceIcon(dev) + '</span>' + escapeHtml(dev.name) + '</div>' +\r\n        badge +\r\n      '</div>' +\r\n      '<div class=\"dhw-body\">' +\r\n        prod + others + effHtml +\r\n      '</div>' +\r\n    '</div>'\r\n  );\r\n}\r\n\r\nfunction escapeHtml(s) {\r\n  return (String(s || '')\r\n    .replaceAll('&', '&amp;')\r\n    .replaceAll('<', '&lt;')\r\n    .replaceAll('>', '&gt;')\r\n    .replaceAll('\"', '&quot;')\r\n    .replaceAll(\"'\", '&#039;'));\r\n}\r\n\r\n/* ---------- Public helpers for HTML buttons ---------- */\r\n\r\nwindow.changeView = function (view) {\r\n  currentView = (view === 'list') ? 'list' : 'grid';\r\n  render();\r\n};\r\n\r\nwindow.refreshData = function () {\r\n  try {\r\n    var btns = document.getElementsByClassName('dhw-refresh');\r\n    if (btns && btns[0]) { btns[0].disabled = true; btns[0].style.opacity = '0.6'; }\r\n    if (selfRef.ctx.subscriptionApi && typeof selfRef.ctx.subscriptionApi.subscribeForData === 'function') {\r\n      selfRef.ctx.subscriptionApi.subscribeForData();\r\n    }\r\n  } finally {\r\n    setTimeout(function () {\r\n      if (btns && btns[0]) { btns[0].disabled = false; btns[0].style.opacity = '1'; }\r\n    }, 900);\r\n  }\r\n};\r\n\r\n/* ---------- Modal ---------- */\r\n\r\nwindow.openDeviceModal = function (deviceId) {\r\n  var dev = deviceMap.get(deviceId);\r\n  if (!dev) return;\r\n  var modal = document.getElementById('deviceModal');\r\n  var body = document.getElementById('modalBody');\r\n\r\n  var status = deviceStatus(dev.metrics);\r\n  var badge = '<span class=\"dhw-badge ' + status + '\"><span class=\"dhw-dot ' + status + '\"></span>' + status.charAt(0).toUpperCase() + status.slice(1) + '</span>';\r\n\r\n  var rows = '';\r\n  Object.keys(dev.metrics).forEach(function (k) {\r\n    rows += '<div class=\"dhw-row\"><span class=\"lab\">' + metricIcon(k) + ' ' + escapeHtml(k) + '</span>' + formatVal(dev.metrics[k], k) + '</div>';\r\n  });\r\n  if (!rows) rows = '<div class=\"dhw-row\"><span class=\"lab\">No metrics</span><span class=\"val\">-</span></div>';\r\n\r\n  body.innerHTML =\r\n    '<div class=\"dhw-card\">' +\r\n      '<div class=\"dhw-card-head\">' +\r\n        '<div class=\"dhw-name\"><span class=\"dhw-ico\">' + deviceIcon(dev) + '</span>' + escapeHtml(dev.name) + '</div>' +\r\n        badge +\r\n      '</div>' +\r\n      '<div class=\"dhw-body\">' +\r\n        '<div class=\"dhw-row\"><span class=\"lab\">Device ID</span><span class=\"val dhw-mono\">' + escapeHtml(dev.id) + '</span></div>' +\r\n        '<div class=\"dhw-row\"><span class=\"lab\">Type</span><span class=\"val dhw-mono\">' + escapeHtml(dev.type) + '</span></div>' +\r\n        '<hr style=\"border:none;border-top:1px solid #f3f4f6;margin:8px 0\" />' +\r\n        rows +\r\n      '</div>' +\r\n    '</div>';\r\n\r\n  modal.style.display = 'flex';\r\n};\r\n\r\nwindow.closeModal = function () {\r\n  var modal = document.getElementById('deviceModal');\r\n  if (modal) modal.style.display = 'none';\r\n};\r\n\r\nwindow.addEventListener('click', function (ev) {\r\n  var modal = document.getElementById('deviceModal');\r\n  if (modal && ev.target === modal) { window.closeModal(); }\r\n});\r\n",
      "settingsForm" : [ ],
      "dataKeySettingsForm" : [ ],
      "defaultConfig" : "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":true,\"backgroundColor\":\"#fff\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{},\"title\":\"Attributes card\",\"decimals\":null}"
    },
    "externalId" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "18ef41c0-a4be-11f0-83ea-d7568d658832"
    },
    "resources" : null,
    "id" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "18ef41c0-a4be-11f0-83ea-d7568d658832"
    },
    "scada" : false,
    "tags" : null
  },
  "relations" : [ ],
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}