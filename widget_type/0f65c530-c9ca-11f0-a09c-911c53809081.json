{
  "entityType" : "WIDGET_TYPE",
  "entity" : {
    "fqn" : "plant_view",
    "name" : "PLANT VIEW",
    "deprecated" : false,
    "image" : null,
    "description" : null,
    "descriptor" : {
      "type" : "static",
      "sizeX" : 7.5,
      "sizeY" : 3,
      "resources" : [ ],
      "templateHtml" : "<div class=\"fp-root\">\r\n    <!-- Toolbar: view mode tabs -->\r\n    <div class=\"fp-toolbar\">\r\n        <div class=\"fp-toolbar-left\">\r\n            <button class=\"fp-tab\"\r\n                [class.fp-tab-active]=\"viewMode === 'floorplan'\"\r\n                (click)=\"setViewMode('floorplan')\">\r\n                Floorplan\r\n            </button>\r\n            <button class=\"fp-tab\"\r\n                [class.fp-tab-active]=\"viewMode === 'grid'\"\r\n                (click)=\"setViewMode('grid')\">\r\n                Grid\r\n            </button>\r\n            <button class=\"fp-tab\"\r\n                [class.fp-tab-active]=\"viewMode === 'list'\"\r\n                (click)=\"setViewMode('list')\">\r\n                List\r\n            </button>\r\n        </div>\r\n\r\n        <div class=\"fp-toolbar-right\"></div>\r\n    </div>\r\n\r\n    <div class=\"fp-main\">\r\n        <!-- FLOORPLAN VIEW -->\r\n        <div class=\"fp-wrap\"\r\n            *ngIf=\"viewMode === 'floorplan'\">\r\n            <!-- Background image: plant blueprint -->\r\n            <img class=\"fp-bg\" [src]=\"bgUrl | image | async\"\r\n                (load)=\"onBgLoad($event)\"\r\n                alt=\"plant-view\" />\r\n\r\n            <!-- Dim overlay on top of image, below chips -->\r\n            <div class=\"fp-dim-overlay\"></div>\r\n\r\n            <!-- Line chips -->\r\n            <div class=\"fp-label\"\r\n                *ngFor=\"let l of lines; trackBy: trackById\"\r\n                [style.left.px]=\"l.__pxLeft || 0\"\r\n                [style.top.px]=\"l.__pxTop || 0\"\r\n                (click)=\"clickLine(l)\"\r\n                [attr.title]=\"l?.name\">\r\n                <div class=\"fp-card\">\r\n                    <!-- Line chip (colored by health) -->\r\n                    <div class=\"fp-chip\"\r\n                        [ngStyle]=\"{ 'background-color': l.color || 'rgba(15,36,62,0.92)' }\">\r\n                        {{ l.label || l.name }}\r\n                    </div>\r\n\r\n                    <!-- Always-visible line health summary -->\r\n                    <div class=\"fp-line-summary\"\r\n                        *ngIf=\"l.health\">\r\n                        Active:\r\n                        {{ l.health.activeMachines || 0 }}\r\n                        /\r\n                        {{ l.health.totalMachines || 0 }}\r\n                    </div>\r\n\r\n\r\n                    <!-- Hover details: line OEE + line health metrics -->\r\n                    <div class=\"fp-telemetry\"\r\n                        *ngIf=\"l.health\">\r\n                        <div class=\"fp-data-row\">\r\n                            <span class=\"fp-data-label\">Line\r\n                                OEE:</span>\r\n                            <span class=\"fp-data-value\">\r\n                                {{\r\n                  l.health.lineOeePct != null\r\n                    ? (l.health.lineOeePct | number: '1.1-1') + ' %'\r\n                    : '--'\r\n                }}\r\n                            </span>\r\n                        </div>\r\n\r\n                        <div class=\"fp-data-row\">\r\n                            <span\r\n                                class=\"fp-data-label\">Planned:</span>\r\n                            <span class=\"fp-data-value\">\r\n                                {{ l.health.plannedMachines || 0 }}\r\n                                /\r\n                                {{ l.health.totalMachines || 0 }}\r\n                            </span>\r\n                        </div>\r\n\r\n                        <div class=\"fp-data-row\">\r\n                            <span\r\n                                class=\"fp-data-label\">Unplanned:</span>\r\n                            <span class=\"fp-data-value\">\r\n                                {{ l.health.unplannedMachines || 0 }}\r\n                            </span>\r\n                        </div>\r\n\r\n                        <div class=\"fp-data-row\">\r\n                            <span\r\n                                class=\"fp-data-label\">Inactive:</span>\r\n                            <span class=\"fp-data-value\">\r\n                                {{ l.health.inactiveMachines || 0 }}\r\n                            </span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <!-- /Line chips -->\r\n        </div>\r\n\r\n        <!-- GRID VIEW -->\r\n        <div class=\"fp-grid-container\"\r\n            *ngIf=\"viewMode === 'grid'\">\r\n            <div class=\"fp-grid-cards\">\r\n                <div class=\"fp-grid-card\"\r\n                    *ngFor=\"let l of lines; trackBy: trackById\"\r\n                    (click)=\"clickLine(l)\">\r\n                    <!-- status dot in top-left -->\r\n                    <span class=\"fp-grid-status-dot\"\r\n                        [ngStyle]=\"{\r\n              'background-color': l.color || 'rgba(158,158,158,0.95)'\r\n            }\"></span>\r\n\r\n                    <!-- chip -->\r\n                    <div class=\"fp-chip fp-grid-chip\"\r\n                        [ngStyle]=\"{ 'background-color': l.color || 'rgba(15,36,62,0.92)' }\">\r\n                        {{ l.label || l.name }}\r\n                    </div>\r\n\r\n                    <!-- body: line metrics -->\r\n                    <div class=\"fp-grid-body\"\r\n                        *ngIf=\"l.health\">\r\n                        <div class=\"fp-data-row\">\r\n                            <span\r\n                                class=\"fp-data-label\">Active\r\n                                / Total</span>\r\n                            <span class=\"fp-data-value\">\r\n                                {{ l.health.activePlannedMachines || 0 }}\r\n                                /\r\n                                {{ l.health.totalMachines || 0 }}\r\n                            </span>\r\n                        </div>\r\n\r\n                        <div class=\"fp-data-row\">\r\n                            <span\r\n                                class=\"fp-data-label\">Planned</span>\r\n                            <span class=\"fp-data-value\">\r\n                                {{ l.health.plannedMachines || 0 }}\r\n                            </span>\r\n                        </div>\r\n\r\n                        <div class=\"fp-data-row\">\r\n                            <span\r\n                                class=\"fp-data-label\">Unplanned</span>\r\n                            <span class=\"fp-data-value\">\r\n                                {{ l.health.unplannedMachines || 0 }}\r\n                            </span>\r\n                        </div>\r\n\r\n                        <div class=\"fp-data-row\">\r\n                            <span\r\n                                class=\"fp-data-label\">Inactive</span>\r\n                            <span class=\"fp-data-value\">\r\n                                {{ l.health.inactiveMachines || 0 }}\r\n                            </span>\r\n                        </div>\r\n\r\n                        <div class=\"fp-data-row\">\r\n                            <span class=\"fp-data-label\">Line\r\n                                OEE</span>\r\n                            <span class=\"fp-data-value\">\r\n                                {{\r\n                  l.health.lineOeePct != null\r\n                    ? (l.health.lineOeePct | number: '1.1-1') + ' %'\r\n                    : '--'\r\n                }}\r\n                            </span>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- LIST VIEW -->\r\n        <div class=\"fp-list-container\"\r\n            *ngIf=\"viewMode === 'list'\">\r\n            <div class=\"fp-table-wrap\"\r\n                *ngIf=\"lines.length > 0\">\r\n                <table class=\"fp-table\">\r\n                    <thead>\r\n                        <tr>\r\n                            <th>Line</th>\r\n                            <th>Active / Total</th>\r\n                            <th>Planned</th>\r\n                            <th>Unplanned</th>\r\n                            <th>Inactive</th>\r\n                            <th>Line OEE (%)</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        <tr *ngFor=\"let l of lines; trackBy: trackById\"\r\n                            (click)=\"clickLine(l)\">\r\n                            <td class=\"fp-table-line\">\r\n                                <span class=\"fp-table-dot\"\r\n                                    [ngStyle]=\"{\r\n                    'background-color': l.color || 'rgba(158,158,158,0.95)'\r\n                  }\"></span>\r\n                                {{ l.label || l.name }}\r\n                            </td>\r\n                            <td>\r\n                                {{\r\n                  (l.health?.activePlannedMachines || 0)\r\n                    + ' / ' +\r\n                  (l.health?.totalMachines || 0)\r\n                }}\r\n                            </td>\r\n                            <td>{{ l.health?.plannedMachines || 0 }}\r\n                            </td>\r\n                            <td>{{ l.health?.unplannedMachines || 0 }}\r\n                            </td>\r\n                            <td>{{ l.health?.inactiveMachines || 0 }}\r\n                            </td>\r\n                            <td>\r\n                                {{\r\n                  l.health?.lineOeePct != null\r\n                    ? (l.health.lineOeePct | number: '1.1-1')\r\n                    : '--'\r\n                }}\r\n                            </td>\r\n                        </tr>\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n            <div class=\"fp-no-data\"\r\n                *ngIf=\"lines.length === 0\">\r\n                No lines configured in settings.\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n<style>\r\n    .fp-root {\r\n        position: relative;\r\n        width: 100%;\r\n        height: 100%;\r\n        display: flex;\r\n        flex-direction: column;\r\n        font-family: Arial, Helvetica, sans-serif;\r\n    }\r\n\r\n    .fp-main {\r\n        flex: 1 1 auto;\r\n        position: relative;\r\n        width: 100%;\r\n        height: 100%;\r\n        overflow: hidden;\r\n        background: #eef1f6;\r\n    }\r\n\r\n    /* toolbar */\r\n    .fp-toolbar {\r\n        flex: 0 0 auto;\r\n        display: flex;\r\n        align-items: center;\r\n        justify-content: space-between;\r\n        padding: 4px 8px;\r\n        background: rgba(15, 36, 62, 0.04);\r\n        border-bottom: 1px solid rgba(15, 36, 62, 0.08);\r\n    }\r\n\r\n    .fp-toolbar-left {\r\n        display: inline-flex;\r\n        gap: 4px;\r\n        align-items: center;\r\n    }\r\n\r\n    .fp-toolbar-right {\r\n        min-width: 0;\r\n    }\r\n\r\n    .fp-tab {\r\n        border-radius: 999px;\r\n        padding: 4px 10px;\r\n        border: 1px solid transparent;\r\n        background: transparent;\r\n        font-size: 11px;\r\n        font-weight: 600;\r\n        cursor: pointer;\r\n        color: #3d4b63;\r\n        outline: none;\r\n        transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;\r\n    }\r\n\r\n    .fp-tab:hover {\r\n        background: rgba(15, 36, 62, 0.06);\r\n    }\r\n\r\n    .fp-tab-active {\r\n        background: #0f243e;\r\n        border-color: #0f243e;\r\n        color: #ffffff;\r\n    }\r\n\r\n    /* FLOORPLAN VIEW */\r\n    .fp-wrap {\r\n        position: relative;\r\n        width: 100%;\r\n        height: 100%;\r\n        overflow: hidden;\r\n        background: transparent;\r\n    }\r\n\r\n    .fp-bg {\r\n        position: absolute;\r\n        inset: 0;\r\n        width: 100%;\r\n        height: 100%;\r\n        object-fit: contain;\r\n        user-select: none;\r\n        pointer-events: none;\r\n        opacity: 0.7;\r\n        filter: grayscale(1) contrast(0.85);\r\n    }\r\n\r\n    .fp-dim-overlay {\r\n        position: absolute;\r\n        inset: 0;\r\n        background: rgba(255, 255, 255, 0.22);\r\n        pointer-events: none;\r\n        z-index: 1;\r\n    }\r\n\r\n    .fp-label {\r\n        position: absolute;\r\n        transform: translate(-50%, -50%);\r\n        cursor: pointer;\r\n        z-index: 2;\r\n    }\r\n\r\n    .fp-card {\r\n        background: rgba(255, 255, 255, 0.96);\r\n        border-radius: 8px;\r\n        padding: 6px 8px 6px 8px;\r\n        box-shadow:\r\n            0 6px 20px rgba(0, 0, 0, 0.4),\r\n            0 3px 8px rgba(0, 0, 0, 0.3);\r\n        backdrop-filter: blur(4px);\r\n        border: 1px solid rgba(255, 255, 255, 0.8);\r\n        transition:\r\n            transform 0.2s ease,\r\n            box-shadow 0.2s ease;\r\n        overflow: hidden;\r\n        min-width: 150px;\r\n    }\r\n\r\n    .fp-card:hover {\r\n        transform: scale(1.05);\r\n        box-shadow:\r\n            0 8px 24px rgba(0, 0, 0, 0.5),\r\n            0 4px 10px rgba(0, 0, 0, 0.35);\r\n    }\r\n\r\n    .fp-chip {\r\n        padding: 6px 10px;\r\n        border-radius: 6px;\r\n        color: #fff;\r\n        box-shadow:\r\n            0 4px 10px rgba(0, 0, 0, 0.35),\r\n            0 2px 4px rgba(0, 0, 0, 0.2);\r\n        font-size: 12px;\r\n        font-weight: 600;\r\n        line-height: 1.2;\r\n        white-space: nowrap;\r\n        user-select: none;\r\n        text-align: center;\r\n        margin-bottom: 4px;\r\n    }\r\n\r\n    .fp-line-summary {\r\n        font-size: 11px;\r\n        font-weight: 600;\r\n        color: #233348;\r\n        text-align: center;\r\n        margin-bottom: 2px;\r\n    }\r\n\r\n    .fp-telemetry {\r\n        max-height: 0;\r\n        opacity: 0;\r\n        overflow: hidden;\r\n        margin-top: 0;\r\n        padding-top: 0;\r\n        border-top: 1px solid transparent;\r\n        transition:\r\n            max-height 0.3s ease,\r\n            opacity 0.3s ease,\r\n            margin-top 0.3s ease,\r\n            padding-top 0.3s ease,\r\n            border-top-color 0.3s ease;\r\n    }\r\n\r\n    .fp-card:hover .fp-telemetry {\r\n        max-height: 500px;\r\n        opacity: 1;\r\n        margin-top: 6px;\r\n        padding-top: 6px;\r\n        border-top-color: rgba(0, 0, 0, 0.1);\r\n    }\r\n\r\n    .fp-data-row {\r\n        font-size: 11px;\r\n        color: #333;\r\n        background: rgba(240, 245, 250, 0.95);\r\n        border-radius: 4px;\r\n        padding: 4px 8px;\r\n        margin-bottom: 3px;\r\n        white-space: nowrap;\r\n        display: flex;\r\n        justify-content: space-between;\r\n        align-items: center;\r\n    }\r\n\r\n    .fp-data-row:last-child {\r\n        margin-bottom: 0;\r\n    }\r\n\r\n    .fp-data-label {\r\n        font-weight: 600;\r\n        margin-right: 8px;\r\n        color: #555;\r\n    }\r\n\r\n    .fp-data-value {\r\n        font-weight: 500;\r\n        color: #0f243e;\r\n    }\r\n\r\n    /* GRID VIEW */\r\n    .fp-grid-container {\r\n        position: relative;\r\n        width: 100%;\r\n        height: 100%;\r\n        padding: 8px 10px;\r\n        box-sizing: border-box;\r\n        background: #f4f6fb;\r\n        overflow: auto;\r\n    }\r\n\r\n    .fp-grid-cards {\r\n        display: flex;\r\n        flex-wrap: nowrap;\r\n        gap: 8px;\r\n        align-items: stretch;\r\n    }\r\n\r\n    .fp-grid-card {\r\n        position: relative;\r\n        flex: 0 0 220px;\r\n        background: #ffffff;\r\n        border-radius: 10px;\r\n        border: 1px solid #cfd7ea;\r\n        padding: 8px 8px 8px 8px;\r\n        box-shadow: 0 8px 22px rgba(15, 36, 62, 0.28);\r\n        cursor: pointer;\r\n        display: flex;\r\n        flex-direction: column;\r\n        min-height: 120px;\r\n        transition: box-shadow 0.15s ease, transform 0.15s ease;\r\n    }\r\n\r\n    .fp-grid-card:hover {\r\n        box-shadow: 0 12px 30px rgba(15, 36, 62, 0.34);\r\n        transform: translateY(-2px);\r\n    }\r\n\r\n    .fp-grid-chip {\r\n        padding-left: 20px;\r\n        font-size: 12px;\r\n    }\r\n\r\n    .fp-grid-body {\r\n        margin-top: 4px;\r\n    }\r\n\r\n    .fp-grid-status-dot {\r\n        position: absolute;\r\n        top: 11px;\r\n        left: 10px;\r\n        width: 8px;\r\n        height: 8px;\r\n        border-radius: 50%;\r\n        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);\r\n    }\r\n\r\n    /* LIST VIEW */\r\n    .fp-list-container {\r\n        position: relative;\r\n        width: 100%;\r\n        height: 100%;\r\n        padding: 8px;\r\n        box-sizing: border-box;\r\n        background: #eef1f8;\r\n        overflow: auto;\r\n    }\r\n\r\n    .fp-table-wrap {\r\n        width: 100%;\r\n        height: 100%;\r\n        overflow: auto;\r\n    }\r\n\r\n    .fp-table {\r\n        width: 100%;\r\n        border-collapse: collapse;\r\n        font-size: 11px;\r\n        background: #ffffff;\r\n        border-radius: 8px;\r\n        overflow: hidden;\r\n        box-shadow: 0 3px 10px rgba(15, 36, 62, 0.18);\r\n    }\r\n\r\n    .fp-table th,\r\n    .fp-table td {\r\n        padding: 7px 10px;\r\n        border-bottom: 1px solid #c2cbe2;\r\n        text-align: left;\r\n        white-space: nowrap;\r\n    }\r\n\r\n    .fp-table th {\r\n        background: #dde4f7;\r\n        font-weight: 700;\r\n        font-size: 11px;\r\n        color: #1f2b45;\r\n        border-bottom: 1px solid #b3bedc;\r\n    }\r\n\r\n    .fp-table tr:nth-child(even) td {\r\n        background: #f7f8ff;\r\n    }\r\n\r\n    .fp-table tr:hover td {\r\n        background: #eaefff;\r\n    }\r\n\r\n    .fp-table tr:last-child td {\r\n        border-bottom: none;\r\n    }\r\n\r\n    .fp-table-line {\r\n        display: flex;\r\n        align-items: center;\r\n        gap: 6px;\r\n        font-weight: 600;\r\n        color: #233348;\r\n    }\r\n\r\n    .fp-table-dot {\r\n        width: 9px;\r\n        height: 9px;\r\n        border-radius: 50%;\r\n        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.35);\r\n    }\r\n\r\n    .fp-no-data {\r\n        font-size: 12px;\r\n        color: #6b768c;\r\n        text-align: center;\r\n        margin-top: 16px;\r\n    }\r\n</style>",
      "templateCss" : "",
      "controllerScript" : "/*\r\n * Lines floorplan + Grid + List widget for ThingsBoard PE (plant view)\r\n *\r\n * - Floorplan view: lines as chips on a plant background image\r\n * - Grid view: one card per line with health metrics\r\n * - List view: table of all lines + health metrics\r\n * - Each line represents a DEVICE entity group (groupId)\r\n * - Always shows: \"Active: X / Y\" under the chip\r\n * - On hover: shows Line OEE + line health metrics\r\n * - Line color based on active & planned machines:\r\n *    - 0 active planned    -> red\r\n *    - some active planned -> yellow\r\n *    - all active planned  -> green\r\n */\r\n\r\nself.onInit = function () {\r\n  var ctx = self.ctx;\r\n  var settings = ctx.settings || {};\r\n\r\n  // ---------- SETTINGS HELPERS ----------\r\n\r\n  function parseLinesConfig(value) {\r\n    if (Array.isArray(value)) {\r\n      console.log('[LinesFP] linesConfig provided as array:', value);\r\n      return value;\r\n    } else if (typeof value === 'string' && value.trim()) {\r\n      try {\r\n        var parsed = JSON.parse(value);\r\n        console.log('[LinesFP] linesConfig parsed from JSON string:', parsed);\r\n        return parsed;\r\n      } catch (err) {\r\n        console.warn('[LinesFP] Failed to parse linesConfig JSON from settings:', err);\r\n        return [];\r\n      }\r\n    }\r\n    return [];\r\n  }\r\n\r\n  var CONFIG = {\r\n    imageUrl: settings.imageUrl || '',\r\n    lines: parseLinesConfig(settings.linesConfig),\r\n    targetStateId: settings.targetStateId || 'line_view',\r\n    stateParamName: settings.stateParamName || 'entityGroupId',\r\n    pollInterval:\r\n      typeof settings.pollInterval === 'number'\r\n        ? settings.pollInterval\r\n        : 10000 // 10s default for line-level health\r\n  };\r\n\r\n  console.log('[LinesFP] Resolved CONFIG:', CONFIG);\r\n\r\n  // ---------- THINGSBOARD SERVICES ----------\r\n\r\n  var $scope = ctx.$scope;\r\n  var $injector = $scope.$injector;\r\n\r\n  var entityService = $injector.get(ctx.servicesMap.get('entityService'));\r\n  var relationService = $injector.get(ctx.servicesMap.get('entityRelationService'));\r\n  var attributeService = $injector.get(ctx.servicesMap.get('attributeService'));\r\n\r\n  // ---------- SCOPE BINDINGS ----------\r\n\r\n  $scope.bgUrl = normalizeImageUrl(CONFIG.imageUrl);\r\n  $scope.lines = [];\r\n\r\n  // view mode: 'floorplan' | 'grid' | 'list'\r\n  $scope.viewMode =\r\n    settings.defaultView &&\r\n    ['floorplan', 'grid', 'list'].indexOf(settings.defaultView) >= 0\r\n      ? settings.defaultView\r\n      : 'floorplan';\r\n\r\n  $scope.setViewMode = function (mode) {\r\n    $scope.viewMode = mode;\r\n    ctx.detectChanges();\r\n  };\r\n\r\n  $scope.trackById = function (_i, item) {\r\n    return (item && item.id) || _i;\r\n  };\r\n\r\n  $scope.onBgLoad = onBgLoad;\r\n  $scope.clickLine = clickLine;\r\n\r\n  // ---------- LAYOUT STATE ----------\r\n\r\n  var layout = {\r\n    natW: 0,\r\n    natH: 0,\r\n    boxL: 0,\r\n    boxT: 0,\r\n    boxW: 0,\r\n    boxH: 0\r\n  };\r\n\r\n  var lineTimers = new Map(); // per-line polling timers\r\n\r\n  // ---------- INIT ----------\r\n\r\n  console.log('[LinesFP] Widget init with settings:', settings);\r\n  buildLinesFromConfig();\r\n  recomputePixelPositions();\r\n  ctx.detectChanges();\r\n\r\n  self.onDestroy = function () {\r\n    lineTimers.forEach(function (tId) {\r\n      clearInterval(tId);\r\n    });\r\n    lineTimers.clear();\r\n    console.log('[LinesFP] Widget destroyed');\r\n  };\r\n\r\n  // ---------- IMAGE & LAYOUT HELPERS ----------\r\n\r\n  function normalizeImageUrl(url) {\r\n    return url ? url.toString().replace(/^tb-image[:;]\\s*/i, '').trim() : '';\r\n  }\r\n\r\n  function onBgLoad(ev) {\r\n    try {\r\n      var img = ev && ev.target ? ev.target : null;\r\n      layout.natW = (img && img.naturalWidth) || 0;\r\n      layout.natH = (img && img.naturalHeight) || 0;\r\n      recomputePixelPositions();\r\n      ctx.detectChanges();\r\n      console.log(\r\n        '[LinesFP] onBgLoad: natural size =',\r\n        layout.natW,\r\n        'x',\r\n        layout.natH\r\n      );\r\n    } catch (e) {\r\n      console.warn('[LinesFP] onBgLoad error:', e);\r\n    }\r\n  }\r\n\r\n  function getHostRect() {\r\n    var host = ctx.$container\r\n      ? ctx.$container[0]\r\n      : ctx.$scope && ctx.$scope.$element && ctx.$scope.$element[0];\r\n\r\n    if (!host || !host.getBoundingClientRect) {\r\n      return {\r\n        left: 0,\r\n        top: 0,\r\n        width: 0,\r\n        height: 0\r\n      };\r\n    }\r\n    var r = host.getBoundingClientRect();\r\n    return {\r\n      left: r.left,\r\n      top: r.top,\r\n      width: r.width,\r\n      height: r.height\r\n    };\r\n  }\r\n\r\n  function clamp01(v) {\r\n    return v < 0 ? 0 : v > 1 ? 1 : v;\r\n  }\r\n\r\n  function recomputePixelPositions() {\r\n    var r = getHostRect();\r\n    if (!r.width || !r.height || !layout.natW || !layout.natH) return;\r\n\r\n    var s = Math.min(r.width / layout.natW, r.height / layout.natH);\r\n    layout.boxW = layout.natW * s;\r\n    layout.boxH = layout.natH * s;\r\n    layout.boxL = (r.width - layout.boxW) * 0.5;\r\n    layout.boxT = (r.height - layout.boxH) * 0.5;\r\n\r\n    ($scope.lines || []).forEach(function (line) {\r\n      var px = clamp01(+line.x / 100);\r\n      var py = clamp01(+line.y / 100);\r\n      line.__pxLeft = Math.round(layout.boxL + px * layout.boxW);\r\n      line.__pxTop = Math.round(layout.boxT + py * layout.boxH);\r\n    });\r\n  }\r\n\r\n  // ---------- BUILD LINES FROM CONFIG ----------\r\n\r\n  function buildLinesFromConfig() {\r\n    var src = CONFIG.lines || [];\r\n    var out = [];\r\n\r\n    src.forEach(function (cfg, idx) {\r\n      if (!cfg || !cfg.groupId) return;\r\n\r\n      var id = cfg.id || cfg.groupId || ('line_' + idx);\r\n      var name = cfg.label || cfg.name || ('Line ' + (idx + 1));\r\n      var x = +cfg.x || 0;\r\n      var y = +cfg.y || 0;\r\n\r\n      out.push({\r\n        id: id,\r\n        internalId: cfg.internalId || ('line_' + (idx + 1)),\r\n        name: name,\r\n        label: name,\r\n        groupId: cfg.groupId,\r\n        x: x,\r\n        y: y,\r\n        color: 'rgba(96,125,139,0.95)', // default bluish-grey\r\n        health: {\r\n          totalMachines: 0,\r\n          activeMachines: 0,\r\n          activePlannedMachines: 0, // active & planned\r\n          plannedMachines: 0,\r\n          unplannedMachines: 0,\r\n          inactiveMachines: 0,\r\n          lineOeePct: null\r\n        },\r\n        __pxLeft: 0,\r\n        __pxTop: 0\r\n      });\r\n    });\r\n\r\n    $scope.lines = out;\r\n\r\n    console.log(\r\n      '[LinesFP] Labels built (lines):',\r\n      out.map(function (l) {\r\n        return l.name + ' -> ' + l.groupId;\r\n      })\r\n    );\r\n\r\n    recomputePixelPositions();\r\n    ctx.detectChanges();\r\n\r\n    // Start health polling per line\r\n    $scope.lines.forEach(initLineHealthPolling);\r\n  }\r\n\r\n  // ---------- LINE HEALTH POLLING ----------\r\n\r\n  function initLineHealthPolling(line) {\r\n    stopLineHealthPolling(line);\r\n\r\n    function tick() {\r\n      refreshLineHealth(line);\r\n    }\r\n\r\n    tick(); // immediate\r\n    var tId = setInterval(tick, CONFIG.pollInterval);\r\n    lineTimers.set(line.id, tId);\r\n  }\r\n\r\n  function stopLineHealthPolling(line) {\r\n    var tId = lineTimers.get(line.id);\r\n    if (tId) {\r\n      clearInterval(tId);\r\n      lineTimers.delete(line.id);\r\n    }\r\n  }\r\n\r\n  function refreshLineHealth(line) {\r\n    if (!line.groupId) {\r\n      return;\r\n    }\r\n\r\n    var filter = {\r\n      type: 'entityGroup',\r\n      groupType: 'DEVICE',\r\n      entityGroup: line.groupId\r\n    };\r\n\r\n    entityService.findEntityInfosByFilterAndName(filter, '').subscribe(\r\n      function (pageData) {\r\n        var rows = pageData && pageData.data ? pageData.data : [];\r\n        if (!rows.length) {\r\n          line.health = {\r\n            totalMachines: 0,\r\n            activeMachines: 0,\r\n            activePlannedMachines: 0,\r\n            plannedMachines: 0,\r\n            unplannedMachines: 0,\r\n            inactiveMachines: 0,\r\n            lineOeePct: null\r\n          };\r\n          line.color = 'rgba(158,158,158,0.95)'; // grey\r\n          ctx.detectChanges();\r\n          return;\r\n        }\r\n\r\n        // counters\r\n        var total = rows.length;\r\n        var activeCount = 0;\r\n        var plannedCount = 0;\r\n        var activePlannedCount = 0;\r\n        var unplannedCount = 0;\r\n        var inactiveCount = 0;\r\n        var oeeValues = [];\r\n\r\n        var pending = total;\r\n\r\n        function finalizeOne() {\r\n          pending -= 1;\r\n          if (pending > 0) return;\r\n\r\n          var avgOee = null;\r\n          if (oeeValues.length) {\r\n            var sum = 0;\r\n            for (var i = 0; i < oeeValues.length; i++) {\r\n              sum += oeeValues[i];\r\n            }\r\n            avgOee = sum / oeeValues.length;\r\n          }\r\n\r\n          line.health = {\r\n            totalMachines: total,\r\n            activeMachines: activeCount,\r\n            activePlannedMachines: activePlannedCount,\r\n            plannedMachines: plannedCount,\r\n            unplannedMachines: unplannedCount,\r\n            inactiveMachines: inactiveCount,\r\n            lineOeePct: avgOee\r\n          };\r\n\r\n          applyLineColor(line);\r\n          ctx.detectChanges();\r\n        }\r\n\r\n        rows.forEach(function (e) {\r\n          var idObj = e.id || e.entityId || {};\r\n          var deviceEntityId = {\r\n            entityType: idObj.entityType || 'DEVICE',\r\n            id: idObj.id || (typeof idObj === 'string' ? idObj : null)\r\n          };\r\n\r\n          if (!deviceEntityId.id) {\r\n            finalizeOne();\r\n            return;\r\n          }\r\n\r\n          // Step 1: read device \"active\" attribute\r\n          attributeService\r\n            .getEntityAttributes(deviceEntityId, 'SERVER_SCOPE', ['active'])\r\n            .subscribe(\r\n              function (attrs) {\r\n                var isActive = false;\r\n                if (attrs && attrs.length) {\r\n                  var a = attrs.find(function (x) {\r\n                    return x.key === 'active';\r\n                  });\r\n                  var v = a ? a.value : null;\r\n                  if (typeof v === 'boolean') isActive = v;\r\n                  else if (typeof v === 'string')\r\n                    isActive = v.toLowerCase() === 'true';\r\n                  else if (typeof v === 'number') isActive = v === 1;\r\n                }\r\n\r\n                if (isActive) {\r\n                  activeCount++;\r\n                } else {\r\n                  inactiveCount++;\r\n                }\r\n\r\n                // Step 2: find ACTIVE_JOB relation to know \"planned\" + OEE\r\n                relationService\r\n                  .findByFromAndType(deviceEntityId, 'ACTIVE_JOB')\r\n                  .subscribe(\r\n                    function (relations) {\r\n                      if (!relations || !relations.length) {\r\n                        // no job = unplanned\r\n                        unplannedCount++;\r\n                        finalizeOne();\r\n                        return;\r\n                      }\r\n\r\n                      var rels = relations.slice();\r\n\r\n                      function checkRel(idx) {\r\n                        if (idx >= rels.length) {\r\n                          // no active job among them\r\n                          unplannedCount++;\r\n                          finalizeOne();\r\n                          return;\r\n                        }\r\n\r\n                        var rel = rels[idx];\r\n                        var to = rel && rel.to ? rel.to : null;\r\n                        if (!to || !to.id) {\r\n                          checkRel(idx + 1);\r\n                          return;\r\n                        }\r\n\r\n                        var assetEntityId = {\r\n                          entityType: to.entityType,\r\n                          id: to.id\r\n                        };\r\n\r\n                        attributeService\r\n                          .getEntityAttributes(\r\n                            assetEntityId,\r\n                            'SERVER_SCOPE',\r\n                            ['job_status', 'oee_pct']\r\n                          )\r\n                          .subscribe(\r\n                            function (attrs2) {\r\n                              var status = null;\r\n                              var oee = null;\r\n\r\n                              if (attrs2 && attrs2.length) {\r\n                                var sAttr = attrs2.find(function (x) {\r\n                                  return x.key === 'job_status';\r\n                                });\r\n                                var oAttr = attrs2.find(function (x) {\r\n                                  return x.key === 'oee_pct';\r\n                                });\r\n\r\n                                status = sAttr\r\n                                  ? String(sAttr.value).toLowerCase()\r\n                                  : null;\r\n\r\n                                if (\r\n                                  oAttr &&\r\n                                  oAttr.value != null &&\r\n                                  oAttr.value !== ''\r\n                                ) {\r\n                                  var num = Number(oAttr.value);\r\n                                  if (!isNaN(num)) {\r\n                                    oee = num;\r\n                                  }\r\n                                }\r\n                              }\r\n\r\n                              if (status === 'active') {\r\n                                plannedCount++;\r\n                                if (isActive) {\r\n                                  activePlannedCount++;\r\n                                }\r\n                                if (typeof oee === 'number') {\r\n                                  oeeValues.push(oee);\r\n                                }\r\n                                finalizeOne();\r\n                              } else {\r\n                                // not active job, try next relation\r\n                                checkRel(idx + 1);\r\n                              }\r\n                            },\r\n                            function (_err2) {\r\n                              // try next relation\r\n                              checkRel(idx + 1);\r\n                            }\r\n                          );\r\n                      }\r\n\r\n                      checkRel(0);\r\n                    },\r\n                    function (_err) {\r\n                      // treat as unplanned if relation fetch fails\r\n                      unplannedCount++;\r\n                      finalizeOne();\r\n                    }\r\n                  );\r\n              },\r\n              function (_err) {\r\n                // failed to read active; count as inactive & unplanned\r\n                inactiveCount++;\r\n                unplannedCount++;\r\n                finalizeOne();\r\n              }\r\n            );\r\n        });\r\n      },\r\n      function (err) {\r\n        console.error(\r\n          '[LinesFP] Device fetch failed for line',\r\n          line.name,\r\n          err\r\n        );\r\n      }\r\n    );\r\n  }\r\n\r\n  function applyLineColor(line) {\r\n    var h = line.health || {};\r\n    var total = h.totalMachines || 0;\r\n    var activePlanned = h.activePlannedMachines || 0;\r\n\r\n    if (!total) {\r\n      line.color = 'rgba(158,158,158,0.95)'; // grey\r\n      return;\r\n    }\r\n\r\n    var ratio = activePlanned / total;\r\n\r\n    if (ratio === 0) {\r\n      // 0 active + planned\r\n      line.color = 'rgba(244,67,54,0.95)'; // red\r\n    } else if (ratio === 1) {\r\n      // all active + planned\r\n      line.color = 'rgba(76,175,80,0.95)'; // green\r\n    } else {\r\n      line.color = 'rgba(255,193,7,0.95)'; // yellow\r\n    }\r\n  }\r\n\r\n  // ---------- CLICK HANDLING (NAVIGATION TO LINE VIEW) ----------\r\n\r\n  function clickLine(line) {\r\n    var sc = ctx.stateController;\r\n    if (!sc) {\r\n      console.warn('[LinesFP] State controller not available; cannot update state.');\r\n      return;\r\n    }\r\n\r\n    if (!line || !line.groupId) {\r\n      console.warn('[LinesFP] clickLine: missing groupId for line', line);\r\n      return;\r\n    }\r\n\r\n    console.log(\r\n      '[LinesFP] clickLine:',\r\n      line.name,\r\n      'groupId =',\r\n      line.groupId\r\n    );\r\n\r\n    var params = {};\r\n    // main param used by line_view / SLD widget\r\n    params[CONFIG.stateParamName] = line.groupId;\r\n    // extras for display / breadcrumbs / aliases\r\n    params.entityGroupLabel = line.name;\r\n    params.entityGroupInternalId = line.internalId || line.id;\r\n    params.lineName = line.name;\r\n\r\n    var currentStateId = sc.getStateId && sc.getStateId();\r\n    var nextStateId = CONFIG.targetStateId || null;\r\n\r\n    console.log(\r\n      '[LinesFP] Updating state. currentStateId =',\r\n      currentStateId,\r\n      ', nextStateId =',\r\n      nextStateId,\r\n      ', params =',\r\n      params\r\n    );\r\n\r\n    if (nextStateId) {\r\n      sc.updateState(nextStateId, params, false);\r\n    } else {\r\n      sc.updateState(null, params, false);\r\n    }\r\n  }\r\n};\r\n",
      "settingsForm" : [ {
        "id" : "imageUrl",
        "name" : "Background Image",
        "type" : "image",
        "default" : "tb-image;/api/images/tenant/floorplan.webp"
      }, {
        "id" : "linesConfig",
        "name" : "Lines (Entity Groups JSON)",
        "type" : "json",
        "default" : "[\n  {\n    \"id\": \"line_1\",\n    \"label\": \"Line 1\",\n    \"groupId\": \"5a89ea50-c9ca-11f0-a09c-911c53809081\",\n    \"x\": 30,\n    \"y\": 30\n  },\n  {\n    \"id\": \"line_2\",\n    \"label\": \"Line 2\",\n    \"groupId\": \"221d3090-9168-11f0-84d5-efc64010e13c\",\n    \"x\": 60,\n    \"y\": 50\n  }\n]"
      }, {
        "id" : "targetStateId",
        "name" : "Target State ID",
        "type" : "text",
        "default" : "machine_sld_view"
      }, {
        "id" : "stateParamName",
        "name" : "State Parameter Name (extra key)",
        "type" : "text",
        "default" : "entityGroupId"
      } ],
      "settingsDirective" : "",
      "defaultConfig" : "{\"datasources\":[{\"type\":\"static\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"rgb(255, 255, 255)\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{\"imageUrl\":\"tb-image;/api/images/tenant/plant_blueprint.jpg\",\"linesConfig\":\"[\\n  {\\n    \\\"id\\\": \\\"line_1\\\",\\n    \\\"label\\\": \\\"Line 1\\\",\\n    \\\"groupId\\\": \\\"5a89ea50-c9ca-11f0-a09c-911c53809081\\\",\\n    \\\"x\\\": 30,\\n    \\\"y\\\": 30\\n  },\\n  {\\n    \\\"id\\\": \\\"line_2\\\",\\n    \\\"label\\\": \\\"Line 2\\\",\\n    \\\"groupId\\\": \\\"221d3090-9168-11f0-84d5-efc64010e13c\\\",\\n    \\\"x\\\": 60,\\n    \\\"y\\\": 50\\n  }\\n]\",\"targetStateId\":\"machine_sld_view\",\"stateParamName\":\"entityGroupId\"},\"title\":\"HTML Card\",\"dropShadow\":true}"
    },
    "externalId" : null,
    "resources" : null,
    "id" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "0f65c530-c9ca-11f0-a09c-911c53809081"
    },
    "scada" : false,
    "tags" : null
  },
  "relations" : [ ],
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}