{
  "entityType" : "WIDGET_TYPE",
  "entity" : {
    "fqn" : "sld_diagram",
    "name" : "LINE VIEW",
    "deprecated" : false,
    "image" : "tb-image;/api/images/tenant/SLD Diagram Preview.png",
    "description" : "A Interactive SLD diagram widget that shows a plant's floorplan with all the machines placed on top of it",
    "descriptor" : {
      "type" : "static",
      "sizeX" : 7.5,
      "sizeY" : 3,
      "resources" : [ ],
      "templateHtml" : "<div class=\"fp-root\">\r\n  <!-- Toolbar: view mode tabs on the left -->\r\n  <div class=\"fp-toolbar\">\r\n    <div class=\"fp-toolbar-left\">\r\n      <button\r\n        class=\"fp-tab\"\r\n        [class.fp-tab-active]=\"viewMode === 'floorplan'\"\r\n        (click)=\"setViewMode('floorplan')\"\r\n      >\r\n        Floorplan\r\n      </button>\r\n      <button\r\n        class=\"fp-tab\"\r\n        [class.fp-tab-active]=\"viewMode === 'grid'\"\r\n        (click)=\"setViewMode('grid')\"\r\n      >\r\n        Grid\r\n      </button>\r\n      <button\r\n        class=\"fp-tab\"\r\n        [class.fp-tab-active]=\"viewMode === 'list'\"\r\n        (click)=\"setViewMode('list')\"\r\n      >\r\n        List\r\n      </button>\r\n    </div>\r\n\r\n    <div class=\"fp-toolbar-right\"></div>\r\n  </div>\r\n\r\n  <div class=\"fp-main\">\r\n    <!-- FLOORPLAN VIEW -->\r\n    <div class=\"fp-wrap\" *ngIf=\"viewMode === 'floorplan'\">\r\n      <img\r\n        class=\"fp-bg\"\r\n        [src]=\"bgUrl | image | async\"\r\n        (load)=\"onBgLoad($event)\"\r\n        alt=\"floorplan\"\r\n      />\r\n\r\n      <div\r\n        class=\"fp-label\"\r\n        *ngFor=\"let d of labels; trackBy: trackById\"\r\n        [style.left.px]=\"d.__pxLeft || 0\"\r\n        [style.top.px]=\"d.__pxTop || 0\"\r\n        (click)=\"clickDevice(d)\"\r\n        [attr.title]=\"d?.name\"\r\n      >\r\n        <div class=\"fp-card\">\r\n          <div\r\n            class=\"fp-chip\"\r\n            [ngStyle]=\"{ 'background-color': d.color || 'rgba(15,36,62,0.92)' }\"\r\n          >\r\n            {{ d?.label || d?.name }}\r\n          </div>\r\n          <div class=\"fp-telemetry\" *ngIf=\"getTelemetryKeys(d).length > 0\">\r\n            <div class=\"fp-data-row\" *ngFor=\"let key of getTelemetryKeys(d)\">\r\n              <span class=\"fp-data-label\">{{ key.label }}:</span>\r\n              <span class=\"fp-data-value\">{{ key.displayValue }}</span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"fp-legend\">\r\n        <span class=\"dot dot-on\"></span> Active\r\n        <span class=\"dot dot-off\"></span> Inactive\r\n      </div>\r\n    </div>\r\n\r\n    <!-- GRID VIEW (cards styled like popup) -->\r\n    <div class=\"fp-grid-container\" *ngIf=\"viewMode === 'grid'\">\r\n      <div class=\"fp-grid-cards\">\r\n        <div\r\n          class=\"fp-grid-card\"\r\n          *ngFor=\"let d of labels; trackBy: trackById\"\r\n          (click)=\"clickDevice(d)\"\r\n        >\r\n          <!-- status dot in top-left -->\r\n          <span\r\n            class=\"fp-grid-status-dot\"\r\n            [ngStyle]=\"{\r\n              'background-color':\r\n                d.color ||\r\n                (d.isActive\r\n                  ? 'rgba(76,175,80,0.95)'\r\n                  : 'rgba(244,67,54,0.95)')\r\n            }\"\r\n          ></span>\r\n\r\n          <!-- chip like screenshot -->\r\n          <div\r\n            class=\"fp-chip fp-grid-chip\"\r\n            [ngStyle]=\"{ 'background-color': d.color || 'rgba(15,36,62,0.92)' }\"\r\n          >\r\n            {{ d?.label || d?.name }}\r\n          </div>\r\n\r\n          <!-- KPIs always visible -->\r\n          <div class=\"fp-grid-body\" *ngIf=\"getTelemetryKeys(d).length > 0\">\r\n            <div class=\"fp-data-row\" *ngFor=\"let key of getTelemetryKeys(d)\">\r\n              <span class=\"fp-data-label\">{{ key.label }}:</span>\r\n              <span class=\"fp-data-value\">{{ key.displayValue }}</span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- LIST VIEW -->\r\n    <div class=\"fp-list-container\" *ngIf=\"viewMode === 'list'\">\r\n      <div class=\"fp-table-wrap\" *ngIf=\"labels.length > 0\">\r\n        <table class=\"fp-table\">\r\n          <thead>\r\n            <tr>\r\n              <th>Machine</th>\r\n              <th *ngFor=\"let dk of dataKeysConfig\">\r\n                {{ dk.label || dk.key }}\r\n              </th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            <tr\r\n              *ngFor=\"let d of labels; trackBy: trackById\"\r\n              (click)=\"clickDevice(d)\"\r\n            >\r\n              <td class=\"fp-table-machine\">\r\n                <span\r\n                  class=\"fp-table-dot\"\r\n                  [ngStyle]=\"{\r\n                    'background-color':\r\n                      d.color ||\r\n                      (d.isActive\r\n                        ? 'rgba(76,175,80,0.95)'\r\n                        : 'rgba(244,67,54,0.95)')\r\n                  }\"\r\n                ></span>\r\n                {{ d?.label || d?.name }}\r\n              </td>\r\n              <td *ngFor=\"let dk of dataKeysConfig\">\r\n                {{\r\n                  d.telemetry[dk.key] != null\r\n                    ? (d.telemetry[dk.key] + (dk.unit || ''))\r\n                    : '--'\r\n                }}\r\n              </td>\r\n            </tr>\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n      <div class=\"fp-no-data\" *ngIf=\"labels.length === 0\">\r\n        No machines in the configured group.\r\n      </div>\r\n    </div>\r\n  </div>\r\n</div>\r\n\r\n<style>\r\n  .fp-root {\r\n    position: relative;\r\n    width: 100%;\r\n    height: 100%;\r\n    display: flex;\r\n    flex-direction: column;\r\n    font-family: Arial, Helvetica, sans-serif;\r\n  }\r\n\r\n  .fp-main {\r\n    flex: 1 1 auto;\r\n    position: relative;\r\n    width: 100%;\r\n    height: 100%;\r\n    overflow: hidden;\r\n  }\r\n\r\n  .fp-toolbar {\r\n    flex: 0 0 auto;\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: space-between;\r\n    padding: 4px 8px;\r\n    background: rgba(15, 36, 62, 0.04);\r\n    border-bottom: 1px solid rgba(15, 36, 62, 0.08);\r\n  }\r\n\r\n  .fp-toolbar-left {\r\n    display: inline-flex;\r\n    gap: 4px;\r\n    align-items: center;\r\n  }\r\n\r\n  .fp-toolbar-right {\r\n    min-width: 0;\r\n  }\r\n\r\n  .fp-tab {\r\n    border-radius: 999px;\r\n    padding: 4px 10px;\r\n    border: 1px solid transparent;\r\n    background: transparent;\r\n    font-size: 11px;\r\n    font-weight: 600;\r\n    cursor: pointer;\r\n    color: #3d4b63;\r\n    outline: none;\r\n    transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;\r\n  }\r\n\r\n  .fp-tab:hover {\r\n    background: rgba(15, 36, 62, 0.06);\r\n  }\r\n\r\n  .fp-tab-active {\r\n    background: #0f243e;\r\n    border-color: #0f243e;\r\n    color: #ffffff;\r\n  }\r\n\r\n  /* FLOORPLAN VIEW */\r\n  .fp-wrap {\r\n    position: relative;\r\n    width: 100%;\r\n    height: 100%;\r\n    overflow: hidden;\r\n    background: #0f243e08;\r\n  }\r\n\r\n  .fp-bg {\r\n    position: absolute;\r\n    inset: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    object-fit: contain;\r\n    user-select: none;\r\n    pointer-events: none;\r\n  }\r\n\r\n  .fp-label {\r\n    position: absolute;\r\n    transform: translate(-50%, -50%);\r\n    cursor: pointer;\r\n    z-index: 10;\r\n  }\r\n\r\n  .fp-card {\r\n    background: rgba(255, 255, 255, 0.95);\r\n    border-radius: 8px;\r\n    padding: 6px;\r\n    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4),\r\n      0 3px 8px rgba(0, 0, 0, 0.3);\r\n    backdrop-filter: blur(4px);\r\n    border: 1px solid rgba(255, 255, 255, 0.8);\r\n    transition: transform 0.2s ease, box-shadow 0.2s ease;\r\n    overflow: hidden;\r\n  }\r\n\r\n  .fp-card:hover {\r\n    transform: scale(1.05);\r\n    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5),\r\n      0 4px 10px rgba(0, 0, 0, 0.35);\r\n  }\r\n\r\n  .fp-chip {\r\n    padding: 6px 10px;\r\n    border-radius: 6px;\r\n    color: #fff;\r\n    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.35),\r\n      0 2px 4px rgba(0, 0, 0, 0.2);\r\n    font-size: 12px;\r\n    font-weight: 600;\r\n    line-height: 1.2;\r\n    white-space: nowrap;\r\n    user-select: none;\r\n    text-align: center;\r\n    margin-bottom: 4px;\r\n  }\r\n\r\n  .fp-telemetry {\r\n    max-height: 0;\r\n    opacity: 0;\r\n    overflow: hidden;\r\n    margin-top: 0;\r\n    padding-top: 0;\r\n    border-top: 1px solid transparent;\r\n    transition:\r\n      max-height 0.3s ease,\r\n      opacity 0.3s ease,\r\n      margin-top 0.3s ease,\r\n      padding-top 0.3s ease,\r\n      border-top-color 0.3s ease;\r\n  }\r\n\r\n  .fp-card:hover .fp-telemetry {\r\n    max-height: 500px;\r\n    opacity: 1;\r\n    margin-top: 6px;\r\n    padding-top: 6px;\r\n    border-top-color: rgba(0, 0, 0, 0.1);\r\n  }\r\n\r\n  .fp-data-row {\r\n    font-size: 11px;\r\n    color: #333;\r\n    background: rgba(240, 245, 250, 0.9);\r\n    border-radius: 4px;\r\n    padding: 4px 8px;\r\n    margin-bottom: 3px;\r\n    white-space: nowrap;\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n  }\r\n\r\n  .fp-data-row:last-child {\r\n    margin-bottom: 0;\r\n  }\r\n\r\n  .fp-data-label {\r\n    font-weight: 600;\r\n    margin-right: 8px;\r\n    color: #555;\r\n  }\r\n\r\n  .fp-data-value {\r\n    font-weight: 500;\r\n    color: #0f243e;\r\n  }\r\n\r\n  .fp-legend {\r\n    position: absolute;\r\n    right: 8px;\r\n    bottom: 8px;\r\n    background: rgba(15, 36, 62, 0.85);\r\n    color: #fff;\r\n    font-size: 11px;\r\n    padding: 8px 12px;\r\n    border-radius: 6px;\r\n    display: flex;\r\n    gap: 12px;\r\n    align-items: center;\r\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);\r\n  }\r\n\r\n  .dot {\r\n    display: inline-block;\r\n    width: 10px;\r\n    height: 10px;\r\n    border-radius: 50%;\r\n    margin-right: 4px;\r\n    vertical-align: middle;\r\n    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.35);\r\n  }\r\n\r\n  .dot-on {\r\n    background: rgba(76, 175, 80, 0.9);\r\n  }\r\n\r\n  .dot-off {\r\n    background: rgba(244, 67, 54, 0.9);\r\n  }\r\n\r\n  /* GRID VIEW */\r\n  .fp-grid-container {\r\n    position: relative;\r\n    width: 100%;\r\n    height: 100%;\r\n    padding: 8px 10px;\r\n    box-sizing: border-box;\r\n    background: #f4f6fb;\r\n    overflow: auto;\r\n  }\r\n\r\n  .fp-grid-cards {\r\n    display: flex;\r\n    flex-wrap: nowrap;\r\n    gap: 8px;\r\n    align-items: stretch;\r\n  }\r\n\r\n  .fp-grid-card {\r\n    position: relative;\r\n    flex: 0 0 220px;\r\n    background: #ffffff;\r\n    border-radius: 10px;\r\n    border: 1px solid #cfd7ea;\r\n    padding: 8px 8px 8px 8px;\r\n    box-shadow: 0 8px 22px rgba(15, 36, 62, 0.28);\r\n    cursor: pointer;\r\n    display: flex;\r\n    flex-direction: column;\r\n    min-height: 120px;\r\n    transition: box-shadow 0.15s ease, transform 0.15s ease;\r\n  }\r\n\r\n  .fp-grid-card:hover {\r\n    box-shadow: 0 12px 30px rgba(15, 36, 62, 0.34);\r\n    transform: translateY(-2px);\r\n  }\r\n\r\n  .fp-grid-chip {\r\n    padding-left: 20px; /* room for status dot */\r\n    font-size: 12px;\r\n  }\r\n\r\n  .fp-grid-body {\r\n    margin-top: 4px;\r\n  }\r\n\r\n  .fp-grid-status-dot {\r\n    position: absolute;\r\n    top: 11px;\r\n    left: 10px;\r\n    width: 8px;\r\n    height: 8px;\r\n    border-radius: 50%;\r\n    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);\r\n  }\r\n\r\n  /* LIST VIEW */\r\n  .fp-list-container {\r\n    position: relative;\r\n    width: 100%;\r\n    height: 100%;\r\n    padding: 8px;\r\n    box-sizing: border-box;\r\n    background: #eef1f8;\r\n    overflow: auto;\r\n  }\r\n\r\n  .fp-table-wrap {\r\n    width: 100%;\r\n    height: 100%;\r\n    overflow: auto;\r\n  }\r\n\r\n  .fp-table {\r\n    width: 100%;\r\n    border-collapse: collapse;\r\n    font-size: 11px;\r\n    background: #ffffff;\r\n    border-radius: 8px;\r\n    overflow: hidden;\r\n    box-shadow: 0 3px 10px rgba(15, 36, 62, 0.18);\r\n  }\r\n\r\n  .fp-table th,\r\n  .fp-table td {\r\n    padding: 7px 10px;\r\n    border-bottom: 1px solid #c2cbe2;\r\n    text-align: left;\r\n    white-space: nowrap;\r\n  }\r\n\r\n  .fp-table th {\r\n    background: #dde4f7;\r\n    font-weight: 700;\r\n    font-size: 11px;\r\n    color: #1f2b45;\r\n    border-bottom: 1px solid #b3bedc;\r\n  }\r\n\r\n  .fp-table tr:nth-child(even) td {\r\n    background: #f7f8ff;\r\n  }\r\n\r\n  .fp-table tr:hover td {\r\n    background: #eaefff;\r\n  }\r\n\r\n  .fp-table tr:last-child td {\r\n    border-bottom: none;\r\n  }\r\n\r\n  .fp-table-machine {\r\n    display: flex;\r\n    align-items: center;\r\n    gap: 6px;\r\n    font-weight: 600;\r\n    color: #233348;\r\n  }\r\n\r\n  .fp-table-dot {\r\n    width: 9px;\r\n    height: 9px;\r\n    border-radius: 50%;\r\n    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.35);\r\n  }\r\n\r\n  .fp-no-data {\r\n    font-size: 12px;\r\n    color: #6b768c;\r\n    text-align: center;\r\n    margin-top: 16px;\r\n  }\r\n</style>\r\n",
      "templateCss" : "",
      "controllerScript" : "/* \r\n * Floorplan + Grid + List widget for ThingsBoard PE (runtime display)\r\n *\r\n * - Floorplan view: shows background image with machine chips\r\n * - Grid view: cards styled like floorplan popups (chip + KPI rows)\r\n * - List view: table of all machines + KPIs\r\n * - Status colors are driven by statusRules (settings.statusRules, JSON array)\r\n */\r\n\r\nself.onInit = function () {\r\n  var ctx = self.ctx;\r\n  var settings = ctx.settings || {};\r\n\r\n  // this must match what the parent (LinesFP) sends\r\n  var GROUP_PARAM_KEY = 'entityGroupId';\r\n\r\n  // ---------- STATE PARAM → groupId OVERRIDE (CORE FIX) ----------\r\n\r\n  function resolveGroupIdFromState() {\r\n    var sc = ctx.stateController;\r\n    var params = null;\r\n\r\n    // Preferred: getStateParams from stateController\r\n    if (sc && typeof sc.getStateParams === 'function') {\r\n      try {\r\n        params = sc.getStateParams();\r\n      } catch (e) {\r\n        console.warn('[FP] getStateParams() threw:', e);\r\n      }\r\n    }\r\n\r\n    // Fallback: ctx.stateParams if TB puts it there\r\n    if (!params && ctx.stateParams && typeof ctx.stateParams === 'object') {\r\n      params = ctx.stateParams;\r\n    }\r\n\r\n    console.log('[FP] raw state params =', params);\r\n\r\n    if (!params || !Object.prototype.hasOwnProperty.call(params, GROUP_PARAM_KEY)) {\r\n      return null;\r\n    }\r\n\r\n    var val = params[GROUP_PARAM_KEY];\r\n\r\n    if (typeof val === 'string') {\r\n      return val;\r\n    }\r\n\r\n    if (val && typeof val === 'object') {\r\n      // just in case someone decides to send a whole object later\r\n      return val.id || val.groupId || val.entityGroupId || null;\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  var stateGroupId = resolveGroupIdFromState();\r\n  if (stateGroupId) {\r\n    console.log(\r\n      '[FP] Overriding settings.groupId from state',\r\n      GROUP_PARAM_KEY,\r\n      '=',\r\n      stateGroupId,\r\n      '(was',\r\n      settings.groupId,\r\n      ')'\r\n    );\r\n    settings.groupId = stateGroupId;\r\n  } else {\r\n    console.log(\r\n      '[FP] No',\r\n      GROUP_PARAM_KEY,\r\n      'in state; using settings.groupId =',\r\n      settings.groupId\r\n    );\r\n  }\r\n\r\n  // ---------- SETTINGS HELPERS ----------\r\n\r\n  function parsePositions(value) {\r\n    if (Array.isArray(value)) {\r\n      console.log('[FP] parsePositions: positions provided as array:', value);\r\n      return value;\r\n    } else if (typeof value === 'string' && value.trim()) {\r\n      try {\r\n        var parsed = JSON.parse(value);\r\n        console.log('[FP] parsePositions: parsed positions from JSON string:', parsed);\r\n        return parsed;\r\n      } catch (err) {\r\n        console.warn('[FP] Failed to parse positions JSON from settings:', err);\r\n        return [];\r\n      }\r\n    }\r\n    return [];\r\n  }\r\n\r\n  function parseDataKeys(value) {\r\n    if (Array.isArray(value)) {\r\n      console.log('[FP] parseDataKeys: dataKeys provided as array:', value);\r\n      return value;\r\n    } else if (typeof value === 'string' && value.trim()) {\r\n      try {\r\n        var parsed = JSON.parse(value);\r\n        console.log('[FP] parseDataKeys: parsed dataKeys from JSON string:', parsed);\r\n        return parsed;\r\n      } catch (err) {\r\n        console.warn('[FP] Failed to parse dataKeys JSON from settings:', err);\r\n        return [];\r\n      }\r\n    }\r\n    return [];\r\n  }\r\n\r\n  function parseStatusRules(value) {\r\n    if (Array.isArray(value)) {\r\n      console.log('[FP] parseStatusRules: rules provided as array:', value);\r\n      return value;\r\n    } else if (typeof value === 'string' && value.trim()) {\r\n      try {\r\n        var parsed = JSON.parse(value);\r\n        console.log('[FP] parseStatusRules: parsed rules from JSON string:', parsed);\r\n        return parsed;\r\n      } catch (err) {\r\n        console.warn('[FP] Failed to parse statusRules JSON from settings:', err);\r\n        return [];\r\n      }\r\n    }\r\n    return [];\r\n  }\r\n\r\n  var CONFIG = {\r\n    imageUrl: settings.imageUrl || '',\r\n    groupId: settings.groupId || '',\r\n    positions: parsePositions(settings.positions),\r\n    dataKeys: parseDataKeys(settings.dataKeys),\r\n    statusRules: parseStatusRules(settings.statusRules),\r\n    targetStateId: settings.targetStateId || '',\r\n    stateParamName: settings.stateParamName || '',\r\n    pollInterval:\r\n      typeof settings.pollInterval === 'number'\r\n        ? settings.pollInterval\r\n        : 5000\r\n  };\r\n\r\n  console.log('[FP] Resolved CONFIG (after state override):', CONFIG);\r\n\r\n  // ---------- CENTER OVERLAY (Machine not planned) ----------\r\n\r\n  var centerMessageOverlay = null;\r\n\r\n  function ensureCenterMessageOverlay() {\r\n    if (centerMessageOverlay) return centerMessageOverlay;\r\n\r\n    var root =\r\n      ctx.$container && ctx.$container[0]\r\n        ? ctx.$container[0]\r\n        : document.body;\r\n\r\n    var computedPos = window.getComputedStyle(root).position;\r\n    if (computedPos === 'static' || !computedPos) {\r\n      root.style.position = 'relative';\r\n    }\r\n\r\n    var overlay = document.createElement('div');\r\n    overlay.style.position = 'absolute';\r\n    overlay.style.left = '0';\r\n    overlay.style.top = '0';\r\n    overlay.style.width = '100%';\r\n    overlay.style.height = '100%';\r\n    overlay.style.display = 'none';\r\n    overlay.style.alignItems = 'center';\r\n    overlay.style.justifyContent = 'center';\r\n    overlay.style.zIndex = '9999';\r\n    overlay.style.pointerEvents = 'none';\r\n    overlay.style.background = 'rgba(0, 0, 0, 0.25)';\r\n\r\n    var box = document.createElement('div');\r\n    box.style.minWidth = '260px';\r\n    box.style.maxWidth = '420px';\r\n    box.style.padding = '18px 28px';\r\n    box.style.borderRadius = '12px';\r\n    box.style.background = 'rgba(8,22,43,0.98)';\r\n    box.style.color = '#e5edf7';\r\n    box.style.boxShadow = '0 12px 28px rgba(0,0,0,0.6)';\r\n    box.style.pointerEvents = 'auto';\r\n\r\n    var msg = document.createElement('div');\r\n    msg.style.fontSize = '18px';\r\n    msg.style.lineHeight = '1.4';\r\n    msg.style.fontWeight = '700';\r\n    msg.style.textAlign = 'center';\r\n    msg.style.marginBottom = '14px';\r\n    box.appendChild(msg);\r\n\r\n    var btn = document.createElement('button');\r\n    btn.textContent = 'Open Job Card Panel';\r\n    btn.style.marginTop = '4px';\r\n    btn.style.padding = '8px 16px';\r\n    btn.style.borderRadius = '999px';\r\n    btn.style.border = '1px solid #e5edf7';\r\n    btn.style.background = '#e5edf7';\r\n    btn.style.color = '#0f243e';\r\n    btn.style.fontSize = '13px';\r\n    btn.style.fontWeight = '600';\r\n    btn.style.cursor = 'pointer';\r\n    btn.style.outline = 'none';\r\n    btn.style.boxShadow = '0 2px 6px rgba(0,0,0,0.45)';\r\n    btn.style.display = 'inline-block';\r\n\r\n    btn.addEventListener('click', function (e) {\r\n      e.stopPropagation();\r\n      var sc = ctx.stateController;\r\n      if (sc && typeof sc.updateState === 'function') {\r\n        sc.updateState('job_card', {}, false);\r\n      } else if (sc && typeof sc.openState === 'function') {\r\n        sc.openState('job_card', {}, false);\r\n      }\r\n      overlay.style.display = 'none';\r\n    });\r\n\r\n    box.appendChild(btn);\r\n    overlay.appendChild(box);\r\n    root.appendChild(overlay);\r\n\r\n    overlay._msg = msg;\r\n    overlay._btn = btn;\r\n\r\n    centerMessageOverlay = overlay;\r\n    return overlay;\r\n  }\r\n\r\n  function showCenteredMessage(text, timeoutMs, showButton) {\r\n    var overlay = ensureCenterMessageOverlay();\r\n\r\n    if (overlay._hideTimeout) {\r\n      clearTimeout(overlay._hideTimeout);\r\n      overlay._hideTimeout = null;\r\n    }\r\n\r\n    overlay._msg.textContent = text || '';\r\n    overlay._btn.style.display = showButton === false ? 'none' : 'inline-block';\r\n    overlay.style.display = 'flex';\r\n\r\n    var delay = typeof timeoutMs === 'number' ? timeoutMs : 2000;\r\n\r\n    if (delay > 0) {\r\n      overlay._hideTimeout = setTimeout(function () {\r\n        overlay.style.display = 'none';\r\n        overlay._hideTimeout = null;\r\n      }, delay);\r\n    }\r\n  }\r\n\r\n  // ---------- THINGSBOARD SERVICES ----------\r\n\r\n  var $scope = ctx.$scope;\r\n  var $injector = $scope.$injector;\r\n\r\n  var entityService = $injector.get(ctx.servicesMap.get('entityService'));\r\n  var relationService = $injector.get(ctx.servicesMap.get('entityRelationService'));\r\n  var attributeService = $injector.get(ctx.servicesMap.get('attributeService'));\r\n\r\n  // ---------- SCOPE BINDINGS ----------\r\n\r\n  $scope.bgUrl = '';\r\n  $scope.labels = [];\r\n\r\n  $scope.trackById = function (_i, item) {\r\n    return (item && item.id) || _i;\r\n  };\r\n\r\n  $scope.onBgLoad = onBgLoad;\r\n  $scope.clickDevice = clickDevice;\r\n\r\n  $scope.getTelemetryKeys = function (label) {\r\n    if (!CONFIG.dataKeys || !label || !label.telemetry) {\r\n      return [];\r\n    }\r\n    return CONFIG.dataKeys.map(function (dk) {\r\n      var value = label.telemetry[dk.key];\r\n      var displayValue = value != null ? value + (dk.unit || '') : '--';\r\n      return {\r\n        key: dk.key,\r\n        label: dk.label || dk.key,\r\n        displayValue: displayValue\r\n      };\r\n    });\r\n  };\r\n\r\n  // view mode: 'floorplan' | 'grid' | 'list'\r\n  $scope.viewMode =\r\n    settings.defaultView &&\r\n    ['floorplan', 'grid', 'list'].indexOf(settings.defaultView) >= 0\r\n      ? settings.defaultView\r\n      : 'floorplan';\r\n\r\n  $scope.setViewMode = function (mode) {\r\n    $scope.viewMode = mode;\r\n    ctx.detectChanges();\r\n  };\r\n\r\n  // used by list view header\r\n  $scope.dataKeysConfig = CONFIG.dataKeys || [];\r\n\r\n  // ---------- LAYOUT STATE ----------\r\n\r\n  var layout = {\r\n    natW: 0,\r\n    natH: 0,\r\n    boxL: 0,\r\n    boxT: 0,\r\n    boxW: 0,\r\n    boxH: 0\r\n  };\r\n\r\n  var timers = new Map();\r\n\r\n  // ---------- STATUS RULE ENGINE ----------\r\n\r\n  function getStatusFlags(label) {\r\n    return {\r\n      deviceActive: !!label.isActive,\r\n      hasActiveJob: !!label.hasActiveJob,\r\n      oee_pct: typeof label.oee_pct === 'number' ? label.oee_pct : null\r\n    };\r\n  }\r\n\r\n  function ruleMatches(rule, flags) {\r\n    if (!rule) return false;\r\n    var cond = rule.match;\r\n    if (!cond || typeof cond !== 'object') {\r\n      // no match object = always true\r\n      return true;\r\n    }\r\n\r\n    // device active / inactive\r\n    if (typeof cond.deviceActive === 'boolean') {\r\n      if (!!flags.deviceActive !== cond.deviceActive) return false;\r\n    }\r\n\r\n    // has active job\r\n    if (typeof cond.hasActiveJob === 'boolean') {\r\n      if (!!flags.hasActiveJob !== cond.hasActiveJob) return false;\r\n    }\r\n\r\n    // OEE conditions\r\n    if (typeof cond.oee_pct_lt === 'number') {\r\n      if (typeof flags.oee_pct !== 'number' || !(flags.oee_pct < cond.oee_pct_lt)) {\r\n        return false;\r\n      }\r\n    }\r\n    if (typeof cond.oee_pct_lte === 'number') {\r\n      if (typeof flags.oee_pct !== 'number' || !(flags.oee_pct <= cond.oee_pct_lte)) {\r\n        return false;\r\n      }\r\n    }\r\n    if (typeof cond.oee_pct_gt === 'number') {\r\n      if (typeof flags.oee_pct !== 'number' || !(flags.oee_pct > cond.oee_pct_gt)) {\r\n        return false;\r\n      }\r\n    }\r\n    if (typeof cond.oee_pct_gte === 'number') {\r\n      if (typeof flags.oee_pct !== 'number' || !(flags.oee_pct >= cond.oee_pct_gte)) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  function applyStatusRules(label) {\r\n    var rules = CONFIG.statusRules || [];\r\n\r\n    // fallback to simple active/inactive colors if no rules configured\r\n    if (!rules.length) {\r\n      label.color = label.isActive\r\n        ? 'rgba(76,175,80,0.9)'\r\n        : 'rgba(244,67,54,0.9)';\r\n      return;\r\n    }\r\n\r\n    var flags = getStatusFlags(label);\r\n    var chosenColor = null;\r\n\r\n    for (var i = 0; i < rules.length; i++) {\r\n      var r = rules[i];\r\n      if (!r || !ruleMatches(r, flags)) continue;\r\n      if (r.color && typeof r.color === 'string') {\r\n        chosenColor = r.color;\r\n        break; // first match wins\r\n      }\r\n    }\r\n\r\n    if (chosenColor) {\r\n      label.color = chosenColor;\r\n    } else {\r\n      // last fallback\r\n      label.color = label.isActive\r\n        ? 'rgba(76,175,80,0.9)'\r\n        : 'rgba(244,67,54,0.9)';\r\n    }\r\n  }\r\n\r\n  console.log('[FP] Widget init with settings:', settings);\r\n\r\n  applyConfig();\r\n  loadGroupDevices();\r\n\r\n  self.onDestroy = function () {\r\n    timers.forEach(function (t) {\r\n      clearInterval(t);\r\n    });\r\n    timers.clear();\r\n    console.log('[FP] Widget destroyed, timers cleared');\r\n  };\r\n\r\n  // ---------- CONFIG & IMAGE HELPERS ----------\r\n\r\n  function applyConfig() {\r\n    if (!CONFIG.imageUrl) {\r\n      console.warn('[FP] imageUrl setting is empty.');\r\n    }\r\n    if (!CONFIG.groupId) {\r\n      console.warn('[FP] groupId setting is empty (check entityGroupId state param).');\r\n    }\r\n    if (!CONFIG.targetStateId) {\r\n      console.warn('[FP] targetStateId setting is empty. Navigation on click will be disabled.');\r\n    }\r\n    if (!CONFIG.stateParamName) {\r\n      console.warn('[FP] stateParamName setting is empty. Navigation on click will be disabled.');\r\n    }\r\n    if (!CONFIG.dataKeys || CONFIG.dataKeys.length === 0) {\r\n      console.warn('[FP] dataKeys setting is empty. No telemetry data will be displayed.');\r\n    }\r\n\r\n    var normImg = normalizeImageUrl(CONFIG.imageUrl);\r\n    console.log('[FP] applyConfig: imageUrl setting =', CONFIG.imageUrl, ', normalized =', normImg);\r\n    $scope.bgUrl = normImg;\r\n    ctx.detectChanges();\r\n  }\r\n\r\n  function normalizeImageUrl(url) {\r\n    return url ? url.toString().replace(/^tb-image[:;]\\s*/i, '').trim() : '';\r\n  }\r\n\r\n  function onBgLoad(ev) {\r\n    try {\r\n      var img = ev && ev.target ? ev.target : null;\r\n      layout.natW = (img && img.naturalWidth) || 0;\r\n      layout.natH = (img && img.naturalHeight) || 0;\r\n      recomputePixelPositions();\r\n      ctx.detectChanges();\r\n      console.log('[FP] onBgLoad: natural size =', layout.natW, 'x', layout.natH);\r\n    } catch (e) {\r\n      console.warn('[FP] onBgLoad error:', e);\r\n    }\r\n  }\r\n\r\n  function getHostRect() {\r\n    var host = ctx.$container\r\n      ? ctx.$container[0]\r\n      : ctx.$scope && ctx.$scope.$element && ctx.$scope.$element[0];\r\n\r\n    if (!host || !host.getBoundingClientRect) {\r\n      return {\r\n        left: 0,\r\n        top: 0,\r\n        width: 0,\r\n        height: 0\r\n      };\r\n    }\r\n    var r = host.getBoundingClientRect();\r\n    return {\r\n      left: r.left,\r\n      top: r.top,\r\n      width: r.width,\r\n      height: r.height\r\n    };\r\n  }\r\n\r\n  function clamp01(v) {\r\n    return v < 0 ? 0 : v > 1 ? 1 : v;\r\n  }\r\n\r\n  function recomputePixelPositions() {\r\n    var r = getHostRect();\r\n    if (!r.width || !r.height || !layout.natW || !layout.natH) return;\r\n\r\n    var s = Math.min(r.width / layout.natW, r.height / layout.natH);\r\n    layout.boxW = layout.natW * s;\r\n    layout.boxH = layout.natH * s;\r\n    layout.boxL = (r.width - layout.boxW) * 0.5;\r\n    layout.boxT = (r.height - layout.boxH) * 0.5;\r\n\r\n    ($scope.labels || []).forEach(function (d) {\r\n      var px = clamp01(+d.x / 100);\r\n      var py = clamp01(+d.y / 100);\r\n      d.__pxLeft = Math.round(layout.boxL + px * layout.boxW);\r\n      d.__pxTop = Math.round(layout.boxT + py * layout.boxH);\r\n    });\r\n  }\r\n\r\n  // ---------- DEVICE & TELEMETRY LOADING ----------\r\n\r\n  function loadGroupDevices() {\r\n    if (!CONFIG.groupId) {\r\n      console.warn('[FP] loadGroupDevices: CONFIG.groupId is empty; nothing to load.');\r\n      $scope.labels = [];\r\n      ctx.detectChanges();\r\n      return;\r\n    }\r\n\r\n    var filter = {\r\n      type: 'entityGroup',\r\n      groupType: 'DEVICE',\r\n      entityGroup: CONFIG.groupId\r\n    };\r\n\r\n    console.log('[FP] Loading devices for group:', CONFIG.groupId);\r\n\r\n    entityService.findEntityInfosByFilterAndName(filter, '').subscribe(\r\n      function (pageData) {\r\n        var rows = pageData && pageData.data ? pageData.data : [];\r\n        console.log('[FP] Devices fetched:', rows.length);\r\n        buildLabels(rows);\r\n        recomputePixelPositions();\r\n        ctx.detectChanges();\r\n        $scope.labels.forEach(initTelemetryPolling);\r\n      },\r\n      function (err) {\r\n        console.error('[FP] Device fetch failed:', err);\r\n        $scope.labels = [];\r\n        ctx.detectChanges();\r\n      }\r\n    );\r\n  }\r\n\r\n  function buildLabels(entities) {\r\n    var byName = {};\r\n    var byId = {};\r\n\r\n    CONFIG.positions.forEach(function (p) {\r\n      if (!p || typeof p.match === 'undefined') return;\r\n      if ((p.by || 'name') === 'id') byId[p.match] = p;\r\n      else byName[p.match] = p;\r\n    });\r\n\r\n    var out = [];\r\n\r\n    entities.forEach(function (e) {\r\n      if (!e) return;\r\n\r\n      var idObj = e.id || e.entityId || {};\r\n      var id = idObj.id || (typeof idObj === 'string' ? idObj : null);\r\n      if (!id) return;\r\n\r\n      var etype = idObj.entityType || 'DEVICE';\r\n      var name = e.name || e.entityName || e.title || id;\r\n      var pos = byId[id] || byName[name];\r\n      if (!pos) return;\r\n\r\n      var telemetryData = {};\r\n      CONFIG.dataKeys.forEach(function (dk) {\r\n        telemetryData[dk.key] = null;\r\n      });\r\n\r\n      out.push({\r\n        id: id,\r\n        entityType: etype,\r\n        name: name,\r\n        x: +pos.x,\r\n        y: +pos.y,\r\n        label: pos.label || name,\r\n        color: 'rgba(15,36,62,0.92)',\r\n        telemetry: telemetryData,\r\n        __pxLeft: 0,\r\n        __pxTop: 0,\r\n        isActive: false,\r\n        hasActiveJob: false,\r\n        oee_pct: null\r\n      });\r\n    });\r\n\r\n    $scope.labels = out;\r\n\r\n    console.log(\r\n      '[FP] Labels built:',\r\n      out.map(function (l) {\r\n        return l.name;\r\n      })\r\n    );\r\n\r\n    // read \"active\" attribute to set isActive and apply status rules\r\n    out.forEach(function (label) {\r\n      var deviceEntityId = {\r\n        entityType: label.entityType,\r\n        id: label.id\r\n      };\r\n\r\n      attributeService\r\n        .getEntityAttributes(deviceEntityId, 'SERVER_SCOPE', ['active'])\r\n        .subscribe(\r\n          function (attrs) {\r\n            var isActive = false;\r\n            if (attrs && attrs.length) {\r\n              var a = attrs.find(function (x) {\r\n                return x.key === 'active';\r\n              });\r\n              var v = a ? a.value : null;\r\n              if (typeof v === 'boolean') isActive = v;\r\n              else if (typeof v === 'string') isActive = v.toLowerCase() === 'true';\r\n              else if (typeof v === 'number') isActive = v === 1;\r\n            }\r\n\r\n            label.isActive = !!isActive;\r\n            applyStatusRules(label);\r\n            ctx.detectChanges();\r\n          },\r\n          function (err) {\r\n            console.error('[FP] Failed to read active for', deviceEntityId, err);\r\n          }\r\n        );\r\n    });\r\n  }\r\n\r\n  function applyFormula(rawValue, formula) {\r\n    if (!formula || formula.trim() === '') {\r\n      return rawValue;\r\n    }\r\n    try {\r\n      var value = rawValue;\r\n      var result = eval(formula);\r\n      return result;\r\n    } catch (err) {\r\n      console.error('[FP] Formula evaluation error:', err, 'Formula:', formula);\r\n      return rawValue;\r\n    }\r\n  }\r\n\r\n  function initTelemetryPolling(label) {\r\n    stopTelemetryPolling(label);\r\n\r\n    function updateTelemetry() {\r\n      findActiveJobAsset(label, function (assetEntityId) {\r\n        if (assetEntityId) {\r\n          label.hasActiveJob = true;\r\n\r\n          if (CONFIG.dataKeys && CONFIG.dataKeys.length > 0) {\r\n            var keys = CONFIG.dataKeys.map(function (dk) {\r\n              return dk.key;\r\n            });\r\n            var now = Date.now();\r\n\r\n            attributeService\r\n              .getEntityTimeseries(\r\n                assetEntityId,\r\n                keys,\r\n                0,\r\n                now,\r\n                1,\r\n                'NONE',\r\n                0,\r\n                'DESC',\r\n                false\r\n              )\r\n              .subscribe(\r\n                function (data) {\r\n                  CONFIG.dataKeys.forEach(function (dataKey) {\r\n                    var arr = data && data[dataKey.key];\r\n                    if (arr && arr.length) {\r\n                      var rawValue = arr[0].value;\r\n                      var processedValue = applyFormula(rawValue, dataKey.formula);\r\n                      var decimals =\r\n                        typeof dataKey.decimals === 'number' ? dataKey.decimals : 1;\r\n\r\n                      label.telemetry[dataKey.key] =\r\n                        processedValue != null\r\n                          ? Number(processedValue).toFixed(decimals)\r\n                          : null;\r\n\r\n                      if (dataKey.key === 'oee_pct') {\r\n                        var num = processedValue != null ? Number(processedValue) : NaN;\r\n                        label.oee_pct = isNaN(num) ? null : num;\r\n                      }\r\n\r\n                      console.log(\r\n                        '[FP]',\r\n                        dataKey.key + ':',\r\n                        rawValue,\r\n                        '=> Processed:',\r\n                        label.telemetry[dataKey.key],\r\n                        'for device',\r\n                        label.name\r\n                      );\r\n                    } else {\r\n                      label.telemetry[dataKey.key] = null;\r\n                      if (dataKey.key === 'oee_pct') {\r\n                        label.oee_pct = null;\r\n                      }\r\n                      console.log(\r\n                        '[FP] No',\r\n                        dataKey.key,\r\n                        'data for asset',\r\n                        assetEntityId.id\r\n                      );\r\n                    }\r\n                  });\r\n\r\n                  applyStatusRules(label);\r\n                  ctx.detectChanges();\r\n                },\r\n                function (err) {\r\n                  console.error('[FP] Telemetry fetch error for', assetEntityId, err);\r\n                  CONFIG.dataKeys.forEach(function (dataKey) {\r\n                    label.telemetry[dataKey.key] = null;\r\n                  });\r\n                  label.oee_pct = null;\r\n                  applyStatusRules(label);\r\n                  ctx.detectChanges();\r\n                }\r\n              );\r\n          }\r\n        } else {\r\n          CONFIG.dataKeys.forEach(function (dataKey) {\r\n            label.telemetry[dataKey.key] = null;\r\n          });\r\n          label.hasActiveJob = false;\r\n          label.oee_pct = null;\r\n          applyStatusRules(label);\r\n          ctx.detectChanges();\r\n          console.log('[FP] No active job found for device', label.name);\r\n        }\r\n      });\r\n    }\r\n\r\n    updateTelemetry();\r\n    var timerId = setInterval(updateTelemetry, CONFIG.pollInterval);\r\n    timers.set(label.id, timerId);\r\n    console.log('[FP] Started telemetry polling for device', label.name);\r\n  }\r\n\r\n  function stopTelemetryPolling(label) {\r\n    var tId = timers.get(label.id);\r\n    if (tId) {\r\n      clearInterval(tId);\r\n      timers.delete(label.id);\r\n    }\r\n  }\r\n\r\n  function findActiveJobAsset(label) {\r\n    var fromEntity = {\r\n      entityType: label.entityType || 'DEVICE',\r\n      id: label.id\r\n    };\r\n\r\n    return relationService.findByFromAndType(fromEntity, 'ACTIVE_JOB').pipe(\r\n      // This is for reference; you're already using callbacks below.\r\n    );\r\n  }\r\n\r\n  function findActiveJobAsset(label, callback) {\r\n    var fromEntity = {\r\n      entityType: label.entityType || 'DEVICE',\r\n      id: label.id\r\n    };\r\n\r\n    relationService.findByFromAndType(fromEntity, 'ACTIVE_JOB').subscribe(\r\n      function (relations) {\r\n        console.log(\r\n          '[FP] findActiveJobAsset: relations for device',\r\n          label.name,\r\n          '=',\r\n          relations\r\n        );\r\n        if (!relations || relations.length === 0) {\r\n          callback(null);\r\n          return;\r\n        }\r\n\r\n        function checkRel(i) {\r\n          if (i >= relations.length) {\r\n            callback(null);\r\n            return;\r\n          }\r\n\r\n          var rel = relations[i];\r\n          var to = rel && rel.to ? rel.to : null;\r\n          if (!to || !to.id) {\r\n            checkRel(i + 1);\r\n            return;\r\n          }\r\n\r\n          var assetEntityId = {\r\n            entityType: to.entityType,\r\n            id: to.id\r\n          };\r\n\r\n          attributeService\r\n            .getEntityAttributes(assetEntityId, 'SERVER_SCOPE', ['job_status'])\r\n            .subscribe(\r\n              function (attrs) {\r\n                var status = null;\r\n                if (attrs && attrs.length) {\r\n                  var a = attrs.find(function (x) {\r\n                    return x.key === 'job_status';\r\n                  });\r\n                  status = a ? String(a.value).toLowerCase() : null;\r\n                }\r\n\r\n                console.log(\r\n                  '[FP] findActiveJobAsset: job_status for asset',\r\n                  assetEntityId.id,\r\n                  '=',\r\n                  status\r\n                );\r\n\r\n                if (status === 'active') {\r\n                  console.log(\r\n                    '[FP] Found active job asset',\r\n                    assetEntityId.id,\r\n                    'for device',\r\n                    label.name\r\n                  );\r\n                  callback(assetEntityId);\r\n                } else {\r\n                  checkRel(i + 1);\r\n                }\r\n              },\r\n              function (err) {\r\n                console.error('[FP] job_status read error for', assetEntityId, err);\r\n                checkRel(i + 1);\r\n              }\r\n            );\r\n        }\r\n\r\n        checkRel(0);\r\n      },\r\n      function (err) {\r\n        console.error('[FP] relation fetch error for device', label.id, err);\r\n        callback(null);\r\n      }\r\n    );\r\n  }\r\n\r\n  function clickDevice(label) {\r\n    var sc = ctx.stateController;\r\n    if (!sc) {\r\n      console.warn('[FP] State controller not available; cannot update state.');\r\n      return;\r\n    }\r\n\r\n    console.log('[FP] clickDevice: clicked', label.name);\r\n\r\n    findActiveJobAsset(label, function (assetEntityId) {\r\n      if (assetEntityId) {\r\n        var params = {};\r\n        params[CONFIG.stateParamName] = {\r\n          entityId: {\r\n            entityType: assetEntityId.entityType,\r\n            id: assetEntityId.id\r\n          },\r\n          entityName: label.name,\r\n          entityLabel: label.id\r\n        };\r\n        params.targetEntityParamName = CONFIG.stateParamName;\r\n\r\n        var currentStateId = sc.getStateId && sc.getStateId();\r\n        var nextStateId = CONFIG.targetStateId || null;\r\n\r\n        console.log(\r\n          '[FP] Updating state. currentStateId =',\r\n          currentStateId,\r\n          ', nextStateId =',\r\n          nextStateId,\r\n          ', params =',\r\n          params\r\n        );\r\n\r\n        if (nextStateId) {\r\n          sc.updateState(nextStateId, params, false);\r\n        } else {\r\n          sc.updateState(null, params, false);\r\n        }\r\n      } else {\r\n        console.warn('[FP] No active job found; state update cancelled for', label.name);\r\n        showCenteredMessage('Machine not planned', 1700, true);\r\n      }\r\n    });\r\n  }\r\n};\r\n",
      "settingsForm" : [ {
        "id" : "imageUrl",
        "name" : "Background Image",
        "type" : "image",
        "default" : "tb-image;/api/images/tenant/floorplan.webp"
      }, {
        "id" : "groupId",
        "name" : "Device Group ID",
        "type" : "text",
        "default" : "45504450-ae8f-11f0-a60f-a7f9e67d958a"
      }, {
        "id" : "targetStateId",
        "name" : "Target State ID",
        "type" : "text",
        "default" : "machine_dashboard"
      }, {
        "id" : "stateParamName",
        "name" : "State Parameter Name",
        "type" : "text",
        "default" : "jobcard"
      }, {
        "id" : "positions",
        "name" : "Label Positions (JSON Array)",
        "type" : "json",
        "default" : "[\n    {\n        \"by\": \"name\",\n        \"match\": \"MACHINE #1\",\n        \"x\": 40,\n        \"y\": 20,\n        \"label\": \"MACHINE #1\"\n    }, {\n        \"by\": \"name\",\n        \"match\": \"MACHINE #2\",\n        \"x\": 40,\n        \"y\": 50,\n        \"label\": \"MACHINE #2\"\n    }, {\n        \"by\": \"name\",\n        \"match\": \"MACHINE #3\",\n        \"x\": 70,\n        \"y\": 50,\n        \"label\": \"MACHINE #3\"\n    }, {\n        \"by\": \"name\",\n        \"match\": \"__ingestion_fastapi__\",\n        \"x\": 60,\n        \"y\": 40,\n        \"label\": \"__ingestion_fastapi__\"\n    }\n]"
      }, {
        "id" : "dataKeys",
        "name" : "Telemetry Data Keys (JSON Array)",
        "type" : "json",
        "default" : "[\r\n  {\r\n    \"key\": \"runtime_s\",\r\n    \"label\": \"Runtime\",\r\n    \"formula\": \"value/60\",\r\n    \"decimals\": 1,\r\n    \"unit\": \" min\"\r\n  },\r\n  {\r\n    \"key\": \"uptime_s\",\r\n    \"label\": \"Uptime\",\r\n    \"formula\": \"value/60\",\r\n    \"decimals\": 1,\r\n    \"unit\": \" min\"\r\n  },\r\n  {\r\n    \"key\": \"downtime_s\",\r\n    \"label\": \"Downtime\",\r\n    \"formula\": \"value/60\",\r\n    \"decimals\": 1,\r\n    \"unit\": \" min\"\r\n  },\r\n  {\r\n    \"key\": \"act_qty_pcs\",\r\n    \"label\": \"Produced\",\r\n    \"formula\": \"\",\r\n    \"decimals\": 0,\r\n    \"unit\": \" pcs.\"\r\n  },\r\n  {\r\n    \"key\": \"oee_pct\",\r\n    \"label\": \"OEE\",\r\n    \"formula\": \"\",\r\n    \"decimals\": 1,\r\n    \"unit\": \" %\"\r\n  }\r\n]"
      }, {
        "id" : "statusRules",
        "name" : "Status Color Rules (JSON Array)",
        "type" : "json",
        "default" : "[\r\n    {\r\n        \"id\": \"inactive\",\r\n        \"label\": \"Device inactive → grey\",\r\n        \"match\": {\r\n            \"deviceActive\": false\r\n        },\r\n        \"color\": \"#9e9e9e\"\r\n    },\r\n    {\r\n        \"id\": \"unplanned\",\r\n        \"label\": \"No ACTIVE_JOB (unplanned) → yellow\",\r\n        \"match\": {\r\n            \"hasActiveJob\": false\r\n        },\r\n        \"color\": \"#ffd740\"\r\n    },\r\n    {\r\n        \"id\": \"low_oee\",\r\n        \"label\": \"OEE < 70% → orange\",\r\n        \"match\": {\r\n            \"deviceActive\": true,\r\n            \"hasActiveJob\": true,\r\n            \"oee_pct_lt\": 70\r\n        },\r\n        \"color\": \"#ff9800\"\r\n    },\r\n    {\r\n        \"id\": \"default_active\",\r\n        \"label\": \"Active fallback → green\",\r\n        \"match\": {\r\n            \"deviceActive\": true\r\n        },\r\n        \"color\": \"#4caf50\"\r\n    },\r\n    {\r\n        \"id\": \"default_other\",\r\n        \"label\": \"Fallback → bluish grey\",\r\n        \"match\": {},\r\n        \"color\": \"#b0bec5\"\r\n    }\r\n]"
      }, {
        "id" : "pollInterval",
        "name" : "Polling Interval (ms)",
        "type" : "number",
        "default" : 5000
      } ],
      "dataKeySettingsForm" : [ ],
      "settingsDirective" : "",
      "hasBasicMode" : false,
      "defaultConfig" : "{\"datasources\":[{\"type\":\"static\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"rgb(255, 255, 255)\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{\"cardHtml\":\"<div class='card'>HTML code here</div>\",\"cardCss\":\".card {\\n    font-weight: bold;\\n    font-size: 32px;\\n    color: #999;\\n    width: 100%;\\n    height: 100%;\\n    display: flex;\\n    align-items: center;\\n    justify-content: center;\\n}\"},\"title\":\"HTML Card\",\"dropShadow\":true}"
    },
    "externalId" : null,
    "resources" : null,
    "id" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "3e5ab600-b252-11f0-ba19-01c0db8b26bf"
    },
    "scada" : false,
    "tags" : null
  },
  "relations" : [ ],
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}