{
  "entityType" : "WIDGET_TYPE",
  "entity" : {
    "fqn" : "sld_diagram",
    "name" : "SLD Diagram",
    "deprecated" : false,
    "image" : "tb-image;/api/images/tenant/SLD Diagram Preview.png",
    "description" : "A Interactive SLD diagram widget that shows a plant's floorplan with all the machines placed on top of it",
    "descriptor" : {
      "type" : "static",
      "sizeX" : 7.5,
      "sizeY" : 3,
      "resources" : [ ],
      "templateHtml" : "<div class=\"fp-wrap\" #wrap>\r\n  <img class=\"fp-bg\" [src]=\"bgUrl | image | async\" (load)=\"onBgLoad($event)\" alt=\"floorplan\"/>\r\n  <div\r\n    class=\"fp-label\"\r\n    *ngFor=\"let d of labels; trackBy: trackById\"\r\n    [style.left.px]=\"d.__pxLeft || 0\"\r\n    [style.top.px]=\"d.__pxTop || 0\"\r\n    (click)=\"clickDevice(d)\"\r\n    [attr.title]=\"d?.name\"\r\n  >\r\n    <!-- Machine Details Card -->\r\n    <div class=\"fp-card\">\r\n      <!-- Machine chip -->\r\n      <div\r\n        class=\"fp-chip\"\r\n        [ngStyle]=\"{ 'background-color': d.color || 'rgba(15,36,62,0.92)' }\"\r\n      >\r\n        {{ d?.label || d?.name }}\r\n      </div>\r\n      <!-- Dynamic telemetry data display -->\r\n      <div class=\"fp-telemetry\" *ngIf=\"getTelemetryKeys(d).length > 0\">\r\n        <div class=\"fp-data-row\" *ngFor=\"let key of getTelemetryKeys(d)\">\r\n          <span class=\"fp-data-label\">{{ key.label }}:</span>\r\n          <span class=\"fp-data-value\">{{ key.displayValue }}</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n  <!-- Legend (optional) -->\r\n  <div class=\"fp-legend\">\r\n    <span class=\"dot dot-on\"></span> Active\r\n    <span class=\"dot dot-off\"></span> Inactive\r\n  </div>\r\n</div>\r\n<style>\r\n  .fp-wrap {\r\n    position: relative;\r\n    width: 100%;\r\n    height: 100%;\r\n    overflow: hidden;\r\n    background: #0f243e08;\r\n  }\r\n  .fp-bg {\r\n    position: absolute;\r\n    inset: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    object-fit: contain;\r\n    user-select: none;\r\n    pointer-events: none;\r\n  }\r\n  .fp-label {\r\n    position: absolute;\r\n    transform: translate(-50%, -50%);\r\n    cursor: pointer;\r\n    z-index: 10;\r\n  }\r\n  .fp-card {\r\n    background: rgba(255, 255, 255, 0.95);\r\n    border-radius: 8px;\r\n    padding: 6px;\r\n    box-shadow: 0 6px 20px rgba(0,0,0,.4), 0 3px 8px rgba(0,0,0,.3);\r\n    backdrop-filter: blur(4px);\r\n    border: 1px solid rgba(255, 255, 255, 0.8);\r\n    transition: transform 0.2s ease, box-shadow 0.2s ease;\r\n    overflow: hidden;\r\n  }\r\n  .fp-card:hover {\r\n    transform: scale(1.05);\r\n    box-shadow: 0 8px 24px rgba(0,0,0,.5), 0 4px 10px rgba(0,0,0,.35);\r\n  }\r\n  .fp-chip {\r\n    padding: 6px 10px;\r\n    border-radius: 6px;\r\n    color: #fff;\r\n    box-shadow: 0 4px 10px rgba(0,0,0,.35), 0 2px 4px rgba(0,0,0,.2);\r\n    font-size: 12px;\r\n    font-weight: 600;\r\n    line-height: 1.2;\r\n    white-space: nowrap;\r\n    user-select: none;\r\n    text-align: center;\r\n    margin-bottom: 2px;\r\n  }\r\n  .fp-telemetry {\r\n    max-height: 0;\r\n    opacity: 0;\r\n    overflow: hidden;\r\n    margin-top: 0;\r\n    padding-top: 0;\r\n    border-top: 1px solid transparent;\r\n    transition: max-height 0.3s ease, opacity 0.3s ease, margin-top 0.3s ease, padding-top 0.3s ease, border-top-color 0.3s ease;\r\n  }\r\n  .fp-card:hover .fp-telemetry {\r\n    max-height: 500px;\r\n    opacity: 1;\r\n    margin-top: 6px;\r\n    padding-top: 6px;\r\n    border-top-color: rgba(0,0,0,.1);\r\n  }\r\n  .fp-data-row {\r\n    font-size: 11px;\r\n    color: #333;\r\n    background: rgba(240, 245, 250, 0.8);\r\n    border-radius: 4px;\r\n    padding: 4px 8px;\r\n    margin-bottom: 3px;\r\n    white-space: nowrap;\r\n    display: flex;\r\n    justify-content: space-between;\r\n    align-items: center;\r\n    transition: background 0.2s ease;\r\n  }\r\n  .fp-data-row:hover {\r\n    background: rgba(230, 240, 250, 1);\r\n  }\r\n  .fp-data-row:last-child {\r\n    margin-bottom: 0;\r\n  }\r\n  .fp-data-label {\r\n    font-weight: 600;\r\n    margin-right: 8px;\r\n    color: #555;\r\n  }\r\n  .fp-data-value {\r\n    font-weight: 500;\r\n    color: #0f243e;\r\n  }\r\n  .fp-legend {\r\n    position: absolute;\r\n    right: 8px;\r\n    bottom: 8px;\r\n    background: rgba(15,36,62,.85);\r\n    color: #fff;\r\n    font-size: 11px;\r\n    padding: 8px 12px;\r\n    border-radius: 6px;\r\n    display: flex;\r\n    gap: 12px;\r\n    align-items: center;\r\n    box-shadow: 0 2px 8px rgba(0,0,0,.3);\r\n  }\r\n  .dot {\r\n    display: inline-block;\r\n    width: 10px;\r\n    height: 10px;\r\n    border-radius: 50%;\r\n    margin-right: 4px;\r\n    vertical-align: middle;\r\n    box-shadow: 0 1px 3px rgba(0,0,0,.35);\r\n  }\r\n  .dot-on  { background: rgba(76,175,80,0.9); }\r\n  .dot-off { background: rgba(244,67,54,0.9); }\r\n</style>",
      "templateCss" : "",
      "controllerScript" : "/*\r\n * Floorplan widget for ThingsBoard PE (runtime display)\r\n *\r\n * This JavaScript code implements a static widget that renders a floorplan\r\n * image, places chips for each device from a configured device group, and\r\n * displays dynamic telemetry data (e.g., runtime in minutes) of an active \r\n * job card related to each device. All configuration comes from the widget's \r\n * Settings form (see the corresponding settings schema).  When a chip is \r\n * clicked, the widget navigates to a target dashboard state with the active \r\n * job card as a state parameter.\r\n */\r\n\r\nself.onInit = function() {\r\n    // Pull the settings object injected by ThingsBoard.  The settings form\r\n    // schema defines the properties available here.  See the schema in\r\n    // floorplan_settings_schema.json for details.\r\n    var settings = self.ctx.settings || {};\r\n\r\n    // Parse the positions field.  The settings form stores it as a JSON\r\n    // string.  If the user edits the field, it may not parse, so wrap in\r\n    // try/catch and fall back to an empty array.\r\n    function parsePositions(value) {\r\n        if (Array.isArray(value)) {\r\n            console.log(\r\n                '[FP] parsePositions: positions provided as array:',\r\n                value);\r\n            return value;\r\n        } else if (typeof value === 'string' && value\r\n            .trim()) {\r\n            try {\r\n                var parsed = JSON.parse(value);\r\n                console.log(\r\n                    '[FP] parsePositions: parsed positions from JSON string:',\r\n                    parsed);\r\n                return parsed;\r\n            } catch (err) {\r\n                console.warn(\r\n                    '[FP] Failed to parse positions JSON from settings:',\r\n                    err);\r\n                return [];\r\n            }\r\n        }\r\n        return [];\r\n    }\r\n\r\n    // Parse the data keys field. Same approach as positions.\r\n    function parseDataKeys(value) {\r\n        if (Array.isArray(value)) {\r\n            console.log(\r\n                '[FP] parseDataKeys: dataKeys provided as array:',\r\n                value);\r\n            return value;\r\n        } else if (typeof value === 'string' && value\r\n            .trim()) {\r\n            try {\r\n                var parsed = JSON.parse(value);\r\n                console.log(\r\n                    '[FP] parseDataKeys: parsed dataKeys from JSON string:',\r\n                    parsed);\r\n                return parsed;\r\n            } catch (err) {\r\n                console.warn(\r\n                    '[FP] Failed to parse dataKeys JSON from settings:',\r\n                    err);\r\n                return [];\r\n            }\r\n        }\r\n        return [];\r\n    }\r\n\r\n    // Construct a configuration object using settings and sensible defaults.\r\n    var CONFIG = {\r\n        imageUrl: settings.imageUrl || '',\r\n        groupId: settings.groupId || '',\r\n        positions: parsePositions(settings\r\n            .positions),\r\n        dataKeys: parseDataKeys(settings.dataKeys),\r\n        targetStateId: settings.targetStateId || '',\r\n        stateParamName: settings.stateParamName ||\r\n            '',\r\n        pollInterval: typeof settings\r\n            .pollInterval === 'number' ? settings\r\n            .pollInterval : 5000\r\n    };\r\n\r\n    // Log resolved configuration for debugging.  This helps identify\r\n    // whether values were correctly passed from the settings form.\r\n    console.log('[FP] Resolved CONFIG:', CONFIG);\r\n\r\n    // Centered in-widget message overlay (for \"Machine not planned\" etc.)\r\n    var centerMessageOverlay = null;\r\n\r\n    function ensureCenterMessageOverlay() {\r\n      if (centerMessageOverlay) return centerMessageOverlay;\r\n    \r\n      var root = ctx.$container && ctx.$container[0]\r\n        ? ctx.$container[0]\r\n        : document.body;\r\n    \r\n      // Ensure widget root can host absolutely-positioned overlay\r\n      var computedPos = window.getComputedStyle(root).position;\r\n      if (computedPos === 'static' || !computedPos) {\r\n        root.style.position = 'relative';\r\n      }\r\n    \r\n      var overlay = document.createElement('div');\r\n      overlay.style.position       = 'absolute';\r\n      overlay.style.left           = '0';\r\n      overlay.style.top            = '0';\r\n      overlay.style.width          = '100%';\r\n      overlay.style.height         = '100%';\r\n      overlay.style.display        = 'none';\r\n      overlay.style.alignItems     = 'center';\r\n      overlay.style.justifyContent = 'center';\r\n      overlay.style.zIndex         = '9999';\r\n      overlay.style.pointerEvents  = 'none'; // don't block floorplan clicks\r\n      // Dimmed background veil\r\n      overlay.style.background     = 'rgba(0, 0, 0, 0.25)';\r\n    \r\n      var box = document.createElement('div');\r\n      // Bigger box\r\n      box.style.minWidth       = '260px';\r\n      box.style.maxWidth       = '420px';\r\n      box.style.padding        = '18px 28px';\r\n      box.style.borderRadius   = '12px';\r\n      box.style.background     = 'rgba(8,22,43,0.98)';\r\n      box.style.color          = '#e5edf7';\r\n      box.style.boxShadow      = '0 12px 28px rgba(0,0,0,0.6)';\r\n      box.style.pointerEvents  = 'auto'; // allow button clicks\r\n    \r\n      // Message text\r\n      var msg = document.createElement('div');\r\n      msg.style.fontSize   = '18px';\r\n      msg.style.lineHeight = '1.4';\r\n      msg.style.fontWeight = '700';\r\n      msg.style.textAlign  = 'center';\r\n      msg.style.marginBottom = '14px';\r\n      box.appendChild(msg);\r\n    \r\n      // Action button: open \"job_card\" state\r\n      var btn = document.createElement('button');\r\n      btn.textContent = 'Open Job Card';\r\n      btn.style.marginTop      = '4px';\r\n      btn.style.padding        = '8px 16px';\r\n      btn.style.borderRadius   = '999px';\r\n      btn.style.border         = '1px solid #e5edf7';\r\n      btn.style.background     = '#e5edf7';\r\n      btn.style.color          = '#0f243e';\r\n      btn.style.fontSize       = '13px';\r\n      btn.style.fontWeight     = '600';\r\n      btn.style.cursor         = 'pointer';\r\n      btn.style.outline        = 'none';\r\n      btn.style.boxShadow      = '0 2px 6px rgba(0,0,0,0.45)';\r\n      btn.style.display        = 'inline-block';\r\n    \r\n      btn.addEventListener('click', function (e) {\r\n        e.stopPropagation();\r\n        var sc = ctx.stateController;\r\n        if (sc && typeof sc.updateState === 'function') {\r\n          // Navigate to job_card, no extra params\r\n          sc.updateState('job_card', {}, false);\r\n        } else if (sc && typeof sc.openState === 'function') {\r\n          sc.openState('job_card', {}, false);\r\n        }\r\n        overlay.style.display = 'none';\r\n      });\r\n    \r\n      box.appendChild(btn);\r\n    \r\n      overlay.appendChild(box);\r\n      root.appendChild(overlay);\r\n    \r\n      overlay._msg = msg;\r\n      overlay._btn = btn;\r\n    \r\n      centerMessageOverlay = overlay;\r\n      return overlay;\r\n    }\r\n\r\n    \r\n    function showCenteredMessage(text, timeoutMs, showButton) {\r\n      var overlay = ensureCenterMessageOverlay();\r\n    \r\n      // Clear any previous hide timer\r\n      if (overlay._hideTimeout) {\r\n        clearTimeout(overlay._hideTimeout);\r\n        overlay._hideTimeout = null;\r\n      }\r\n    \r\n      overlay._msg.textContent = text || '';\r\n      overlay._btn.style.display = showButton === false ? 'none' : 'inline-block';\r\n      overlay.style.display = 'flex';\r\n    \r\n      // Default to 2000 ms if not provided\r\n      var delay = (typeof timeoutMs === 'number') ? timeoutMs : 2000;\r\n    \r\n      if (delay > 0) {\r\n        overlay._hideTimeout = setTimeout(function () {\r\n          overlay.style.display = 'none';\r\n          overlay._hideTimeout = null;\r\n        }, delay);\r\n      }\r\n    }\r\n\r\n\r\n\r\n\r\n    var ctx = self.ctx;\r\n    var $scope = ctx.$scope;\r\n    var $injector = $scope.$injector;\r\n\r\n    // Obtain ThingsBoard services via injector.  These services are\r\n    // documented in the ThingsBoard widget API and allow querying\r\n    // entities, relations and telemetry.\r\n    var entityService = $injector.get(ctx.servicesMap\r\n        .get('entityService'));\r\n    var relationService = $injector.get(ctx.servicesMap\r\n        .get('entityRelationService'));\r\n    var attributeService = $injector.get(ctx.servicesMap\r\n        .get('attributeService'));\r\n\r\n    // Bindings used in the HTML template.  They are attached to $scope so\r\n    // that Angular can access them in the HTML.  Do not rename these\r\n    // properties without updating the HTML.\r\n    $scope.bgUrl = '';\r\n    $scope.labels = [];\r\n    $scope.trackById = function(_i, item) {\r\n        return (item && item.id) || _i;\r\n    };\r\n    $scope.onBgLoad = onBgLoad;\r\n    $scope.clickDevice = clickDevice;\r\n    $scope.getTelemetryKeys = function(label) {\r\n        if (!CONFIG.dataKeys || !label || !label\r\n            .telemetry) {\r\n            return [];\r\n        }\r\n        return CONFIG.dataKeys.map(function(dk) {\r\n            var value = label.telemetry[dk\r\n                .key];\r\n            var displayValue = value !=\r\n                null ? value + (dk.unit ||\r\n                    '') : '--';\r\n            return {\r\n                key: dk.key,\r\n                label: dk.label || dk.key,\r\n                displayValue: displayValue\r\n            };\r\n        });\r\n    };\r\n\r\n    // Internal state for image layout and polling timers.\r\n    var layout = {\r\n        natW: 0,\r\n        natH: 0,\r\n        boxL: 0,\r\n        boxT: 0,\r\n        boxW: 0,\r\n        boxH: 0\r\n    };\r\n    var timers = new Map();\r\n\r\n    console.log('[FP] Widget init with settings:',\r\n        settings);\r\n    applyConfig();\r\n    loadGroupDevices();\r\n\r\n    // Clean up timers on destroy to avoid memory leaks.\r\n    self.onDestroy = function() {\r\n        timers.forEach(function(t) {\r\n            clearInterval(t);\r\n        });\r\n        timers.clear();\r\n        console.log(\r\n            '[FP] Widget destroyed, timers cleared'\r\n            );\r\n    };\r\n\r\n    /**\r\n     * Apply configuration from settings.  Warn if essential values are\r\n     * missing so that the user knows to configure them.  Assign\r\n     * background image URL.\r\n     */\r\n    function applyConfig() {\r\n        if (!CONFIG.imageUrl) {\r\n            console.warn(\r\n                '[FP] imageUrl setting is empty. Please configure a background image in the settings.'\r\n                );\r\n        }\r\n        if (!CONFIG.groupId) {\r\n            console.warn(\r\n                '[FP] groupId setting is empty. Please configure a Device Group ID in the settings.'\r\n                );\r\n        }\r\n        if (!CONFIG.targetStateId) {\r\n            console.warn(\r\n                '[FP] targetStateId setting is empty. Navigation on click will be disabled.'\r\n                );\r\n        }\r\n        if (!CONFIG.stateParamName) {\r\n            console.warn(\r\n                '[FP] stateParamName setting is empty. Navigation on click will be disabled.'\r\n                );\r\n        }\r\n        if (!CONFIG.dataKeys || CONFIG.dataKeys\r\n            .length === 0) {\r\n            console.warn(\r\n                '[FP] dataKeys setting is empty. No telemetry data will be displayed.'\r\n                );\r\n        }\r\n        var normImg = normalizeImageUrl(CONFIG\r\n        .imageUrl);\r\n        console.log(\r\n            '[FP] applyConfig: imageUrl setting =',\r\n            CONFIG.imageUrl, ', normalized =',\r\n            normImg);\r\n        $scope.bgUrl = normImg;\r\n        ctx.detectChanges();\r\n    }\r\n\r\n    /**\r\n     * Normalize tenant image URLs by stripping the tb-image prefix.\r\n     */\r\n    function normalizeImageUrl(url) {\r\n        return url ? url.toString().replace(\r\n            /^tb-image[:;]\\s*/i, '').trim() : '';\r\n    }\r\n\r\n    /**\r\n     * Handler for <img> load event.  Records natural dimensions and\r\n     * recomputes positions so chips stay aligned with the image.\r\n     */\r\n    function onBgLoad(ev) {\r\n        try {\r\n            var img = ev && ev.target ? ev.target :\r\n            null;\r\n            layout.natW = (img && img.naturalWidth) ||\r\n            0;\r\n            layout.natH = (img && img.naturalHeight) ||\r\n                0;\r\n            recomputePixelPositions();\r\n            ctx.detectChanges();\r\n            console.log('[FP] onBgLoad: natural size =',\r\n                layout.natW, 'x', layout.natH);\r\n        } catch (e) {\r\n            console.warn('[FP] onBgLoad error:', e);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Compute the bounding rectangle of the widget container.  This is\r\n     * used to calculate where to place chips relative to the floorplan.\r\n     */\r\n    function getHostRect() {\r\n        var host = ctx.$container ? ctx.$container[0] :\r\n            (ctx.$scope && ctx.$scope.$element && ctx\r\n                .$scope.$element[0]);\r\n        if (!host || !host.getBoundingClientRect)\r\n        return {\r\n            left: 0,\r\n            top: 0,\r\n            width: 0,\r\n            height: 0\r\n        };\r\n        var r = host.getBoundingClientRect();\r\n        return {\r\n            left: r.left,\r\n            top: r.top,\r\n            width: r.width,\r\n            height: r.height\r\n        };\r\n    }\r\n\r\n    function clamp01(v) {\r\n        return v < 0 ? 0 : (v > 1 ? 1 : v);\r\n    }\r\n\r\n    /**\r\n     * Convert percentage coordinates to pixel offsets based on the\r\n     * object-fit: contain layout.  Called whenever the image loads or\r\n     * the widget is resized.\r\n     */\r\n    function recomputePixelPositions() {\r\n        var r = getHostRect();\r\n        if (!r.width || !r.height || !layout.natW || !\r\n            layout.natH) return;\r\n        var s = Math.min(r.width / layout.natW, r\r\n            .height / layout.natH);\r\n        layout.boxW = layout.natW * s;\r\n        layout.boxH = layout.natH * s;\r\n        layout.boxL = (r.width - layout.boxW) * 0.5;\r\n        layout.boxT = (r.height - layout.boxH) * 0.5;\r\n        ($scope.labels || []).forEach(function(d) {\r\n            var px = clamp01((+d.x) / 100);\r\n            var py = clamp01((+d.y) / 100);\r\n            d.__pxLeft = Math.round(layout\r\n                .boxL + px * layout.boxW);\r\n            d.__pxTop = Math.round(layout.boxT +\r\n                py * layout.boxH);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Load all devices from the configured group and build label objects.\r\n     * Each label corresponds to a device and is placed at the configured\r\n     * coordinates.  After building labels, runtime polling begins.\r\n     */\r\n    function loadGroupDevices() {\r\n        if (!CONFIG.groupId) {\r\n            $scope.labels = [];\r\n            ctx.detectChanges();\r\n            return;\r\n        }\r\n        var filter = {\r\n            type: 'entityGroup',\r\n            groupType: 'DEVICE',\r\n            entityGroup: CONFIG.groupId\r\n        };\r\n        console.log('[FP] Loading devices for group:',\r\n            CONFIG.groupId);\r\n        entityService.findEntityInfosByFilterAndName(\r\n            filter, '').subscribe(\r\n            function(pageData) {\r\n                var rows = pageData && pageData\r\n                    .data ? pageData.data : [];\r\n                console.log('[FP] Devices fetched:',\r\n                    rows.length);\r\n                buildLabels(rows);\r\n                recomputePixelPositions();\r\n                ctx.detectChanges();\r\n                // Start polling telemetry for each device\r\n                $scope.labels.forEach(\r\n                    initTelemetryPolling);\r\n            },\r\n            function(err) {\r\n                console.error(\r\n                    '[FP] Device fetch failed:',\r\n                    err);\r\n                $scope.labels = [];\r\n                ctx.detectChanges();\r\n            }\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Create label objects from devices using the configured positions.  The\r\n     * positions array contains objects with keys: by (name or id), match,\r\n     * x, y and label.  Devices without a matching position are ignored.\r\n     */\r\n    function buildLabels(entities) {\r\n        var byName = {},\r\n            byId = {};\r\n        CONFIG.positions.forEach(function(p) {\r\n            if (!p || typeof p.match ===\r\n                'undefined') return;\r\n            if ((p.by || 'name') === 'id') byId[\r\n                p.match] = p;\r\n            else byName[p.match] = p;\r\n        });\r\n        var out = [];\r\n        entities.forEach(function(e) {\r\n            if (!e) return;\r\n            var idObj = e.id || e.entityId ||\r\n            {};\r\n            var id = idObj.id || (\r\n                typeof idObj === 'string' ?\r\n                idObj : null);\r\n            if (!id) return;\r\n            var etype = idObj.entityType ||\r\n                'DEVICE';\r\n            var name = e.name || e.entityName ||\r\n                e.title || id;\r\n            var pos = byId[id] || byName[name];\r\n            if (!pos) return;\r\n\r\n            // Initialize telemetry data object for all configured data keys\r\n            var telemetryData = {};\r\n            CONFIG.dataKeys.forEach(function(\r\n            dk) {\r\n                telemetryData[dk.key] =\r\n                    null;\r\n            });\r\n\r\n            out.push({\r\n                id: id,\r\n                entityType: etype,\r\n                name: name,\r\n                x: +pos.x,\r\n                y: +pos.y,\r\n                label: pos.label ||\r\n                    name,\r\n                color: 'rgba(15,36,62,0.92)',\r\n                telemetry: telemetryData,\r\n                __pxLeft: 0,\r\n                __pxTop: 0\r\n            });\r\n        });\r\n        $scope.labels = out;\r\n        console.log('[FP] Labels built:', out.map(\r\n            function(l) {\r\n                return l.name;\r\n            }));\r\n        // Colour chips based on the device's \"active\" attribute\r\n        out.forEach(function(label) {\r\n            var deviceEntityId = {\r\n                entityType: label\r\n                    .entityType,\r\n                id: label.id\r\n            };\r\n            attributeService\r\n                .getEntityAttributes(\r\n                    deviceEntityId,\r\n                    'SERVER_SCOPE', ['active'])\r\n                .subscribe(\r\n                    function(attrs) {\r\n                        var isActive = false;\r\n                        if (attrs && attrs\r\n                            .length) {\r\n                            var a = attrs.find(\r\n                                function(\r\n                                x) {\r\n                                    return x\r\n                                        .key ===\r\n                                        'active';\r\n                                });\r\n                            var v = a ? a\r\n                                .value : null;\r\n                            if (typeof v ===\r\n                                'boolean')\r\n                                isActive = v;\r\n                            else if (\r\n                                typeof v ===\r\n                                'string')\r\n                                isActive = v\r\n                                .toLowerCase() ===\r\n                                'true';\r\n                            else if (\r\n                                typeof v ===\r\n                                'number')\r\n                                isActive = v ===\r\n                                1;\r\n                        }\r\n                        label.color = isActive ?\r\n                            'rgba(76,175,80,0.9)' :\r\n                            'rgba(244,67,54,0.9)';\r\n                        ctx.detectChanges();\r\n                    },\r\n                    function(err) {\r\n                        console.error(\r\n                            '[FP] Failed to read active for',\r\n                            deviceEntityId,\r\n                            err);\r\n                    }\r\n                );\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Apply post-processing formula to a raw value.\r\n     * The formula is a string expression where 'value' represents the raw data.\r\n     * Example: \"value/60\" converts seconds to minutes.\r\n     */\r\n    function applyFormula(rawValue, formula) {\r\n        if (!formula || formula.trim() === '') {\r\n            return rawValue;\r\n        }\r\n        try {\r\n            // Create a safe evaluation context\r\n            var value = rawValue;\r\n            var result = eval(formula);\r\n            return result;\r\n        } catch (err) {\r\n            console.error(\r\n                '[FP] Formula evaluation error:',\r\n                err, 'Formula:', formula);\r\n            return rawValue;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Start polling telemetry data for all configured data keys for a label's \r\n     * active job asset. Polling runs at the configured interval. If no active\r\n     * job exists, telemetry values are set to null.\r\n     */\r\n    function initTelemetryPolling(label) {\r\n        stopTelemetryPolling(label);\r\n\r\n        function updateTelemetry() {\r\n            findActiveJobAsset(label, function(\r\n                assetEntityId) {\r\n                if (assetEntityId) {\r\n                    // Fetch all configured data keys\r\n                    if (CONFIG.dataKeys &&\r\n                        CONFIG.dataKeys.length >\r\n                        0) {\r\n                        var keys = CONFIG\r\n                            .dataKeys.map(\r\n                                function(dk) {\r\n                                    return dk\r\n                                        .key;\r\n                                });\r\n                        var now = Date.now();\r\n\r\n                        attributeService\r\n                            .getEntityTimeseries(\r\n                                assetEntityId,\r\n                                keys,\r\n                                0,\r\n                                now,\r\n                                1,\r\n                                'NONE',\r\n                                0,\r\n                                'DESC',\r\n                                false\r\n                            ).subscribe(\r\n                                function(data) {\r\n                                    CONFIG\r\n                                        .dataKeys\r\n                                        .forEach(\r\n                                            function(\r\n                                                dataKey\r\n                                                ) {\r\n                                                var arr =\r\n                                                    data &&\r\n                                                    data[\r\n                                                        dataKey\r\n                                                        .key\r\n                                                        ];\r\n                                                if (arr &&\r\n                                                    arr\r\n                                                    .length\r\n                                                    ) {\r\n                                                    var rawValue =\r\n                                                        arr[\r\n                                                            0]\r\n                                                        .value;\r\n                                                    var processedValue =\r\n                                                        applyFormula(\r\n                                                            rawValue,\r\n                                                            dataKey\r\n                                                            .formula\r\n                                                            );\r\n\r\n                                                    // Format the value based on decimals setting\r\n                                                    var decimals =\r\n                                                        typeof dataKey\r\n                                                        .decimals ===\r\n                                                        'number' ?\r\n                                                        dataKey\r\n                                                        .decimals :\r\n                                                        1;\r\n                                                    label\r\n                                                        .telemetry[\r\n                                                            dataKey\r\n                                                            .key\r\n                                                            ] =\r\n                                                        processedValue !=\r\n                                                        null ?\r\n                                                        Number(\r\n                                                            processedValue\r\n                                                            )\r\n                                                        .toFixed(\r\n                                                            decimals\r\n                                                            ) :\r\n                                                        null;\r\n\r\n                                                    console\r\n                                                        .log(\r\n                                                            '[FP]',\r\n                                                            dataKey\r\n                                                            .key +\r\n                                                            ':',\r\n                                                            rawValue,\r\n                                                            '=> Processed:',\r\n                                                            label\r\n                                                            .telemetry[\r\n                                                                dataKey\r\n                                                                .key\r\n                                                                ],\r\n                                                            'for device',\r\n                                                            label\r\n                                                            .name\r\n                                                            );\r\n                                                } else {\r\n                                                    label\r\n                                                        .telemetry[\r\n                                                            dataKey\r\n                                                            .key\r\n                                                            ] =\r\n                                                        null;\r\n                                                    console\r\n                                                        .log(\r\n                                                            '[FP] No',\r\n                                                            dataKey\r\n                                                            .key,\r\n                                                            'data for asset',\r\n                                                            assetEntityId\r\n                                                            .id\r\n                                                            );\r\n                                                }\r\n                                            });\r\n                                    ctx\r\n                                .detectChanges();\r\n                                },\r\n                                function(err) {\r\n                                    console\r\n                                        .error(\r\n                                            '[FP] Telemetry fetch error for',\r\n                                            assetEntityId,\r\n                                            err\r\n                                            );\r\n                                    CONFIG\r\n                                        .dataKeys\r\n                                        .forEach(\r\n                                            function(\r\n                                                dataKey\r\n                                                ) {\r\n                                                label\r\n                                                    .telemetry[\r\n                                                        dataKey\r\n                                                        .key\r\n                                                        ] =\r\n                                                    null;\r\n                                            });\r\n                                    ctx\r\n                                .detectChanges();\r\n                                }\r\n                            );\r\n                    }\r\n                } else {\r\n                    // No active job, reset all telemetry values\r\n                    CONFIG.dataKeys.forEach(\r\n                        function(dataKey) {\r\n                            label.telemetry[\r\n                                    dataKey\r\n                                    .key] =\r\n                                null;\r\n                        });\r\n                    ctx.detectChanges();\r\n                    console.log(\r\n                        '[FP] No active job found for device',\r\n                        label.name);\r\n                }\r\n            });\r\n        }\r\n\r\n        updateTelemetry();\r\n        var timerId = setInterval(updateTelemetry,\r\n            CONFIG.pollInterval);\r\n        timers.set(label.id, timerId);\r\n        console.log(\r\n            '[FP] Started telemetry polling for device',\r\n            label.name);\r\n    }\r\n\r\n    function stopTelemetryPolling(label) {\r\n        var tId = timers.get(label.id);\r\n        if (tId) {\r\n            clearInterval(tId);\r\n            timers.delete(label.id);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Find the asset related to the device with job_status = 'active'.  The\r\n     * callback is invoked with the EntityId of the asset or null if no\r\n     * active job is found.\r\n     */\r\n    function findActiveJobAsset(label, callback) {\r\n        var fromEntity = {\r\n            entityType: label.entityType ||\r\n                'DEVICE',\r\n            id: label.id\r\n        };\r\n        relationService.findByFromAndType(fromEntity,\r\n            'ACTIVE_JOB').subscribe(\r\n            function(relations) {\r\n                console.log(\r\n                    '[FP] findActiveJobAsset: relations for device',\r\n                    label.name, '=', relations);\r\n                if (!relations || relations\r\n                    .length === 0) {\r\n                    callback(null);\r\n                    return;\r\n                }\r\n\r\n                function checkRel(i) {\r\n                    if (i >= relations.length) {\r\n                        callback(null);\r\n                        return;\r\n                    }\r\n                    var rel = relations[i];\r\n                    var to = rel && rel.to ? rel\r\n                        .to : null;\r\n                    if (!to || !to.id) {\r\n                        checkRel(i + 1);\r\n                        return;\r\n                    }\r\n                    var assetEntityId = {\r\n                        entityType: to\r\n                            .entityType,\r\n                        id: to.id\r\n                    };\r\n                    attributeService\r\n                        .getEntityAttributes(\r\n                            assetEntityId,\r\n                            'SERVER_SCOPE', [\r\n                                'job_status'\r\n                            ]).subscribe(\r\n                            function(attrs) {\r\n                                var status = null;\r\n                                if (attrs && attrs\r\n                                    .length) {\r\n                                    var a = attrs\r\n                                        .find(\r\n                                            function(\r\n                                                x) {\r\n                                                return x\r\n                                                    .key ===\r\n                                                    'job_status';\r\n                                            });\r\n                                    status = a ?\r\n                                        String(a\r\n                                            .value)\r\n                                        .toLowerCase() :\r\n                                        null;\r\n                                }\r\n                                console.log(\r\n                                    '[FP] findActiveJobAsset: job_status for asset',\r\n                                    assetEntityId\r\n                                    .id, '=',\r\n                                    status);\r\n                                if (status ===\r\n                                    'active') {\r\n                                    console.log(\r\n                                        '[FP] Found active job asset',\r\n                                        assetEntityId\r\n                                        .id,\r\n                                        'for device',\r\n                                        label\r\n                                        .name);\r\n                                    callback(\r\n                                        assetEntityId\r\n                                        );\r\n                                } else {\r\n                                    checkRel(i + 1);\r\n                                }\r\n                            },\r\n                            function(err) {\r\n                                console.error(\r\n                                    '[FP] job_status read error for',\r\n                                    assetEntityId,\r\n                                    err);\r\n                                checkRel(i + 1);\r\n                            }\r\n                        );\r\n                }\r\n                checkRel(0);\r\n            },\r\n            function(err) {\r\n                console.error(\r\n                    '[FP] relation fetch error for device',\r\n                    label.id, err);\r\n                callback(null);\r\n            }\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Get telemetry keys with their display values for a specific label.\r\n     * This function is called by the HTML template to render telemetry data.\r\n     */\r\n    function getTelemetryKeys(label) {\r\n        if (!CONFIG.dataKeys || !label || !label\r\n            .telemetry) {\r\n            return [];\r\n        }\r\n        return CONFIG.dataKeys.map(function(dk) {\r\n            var value = label.telemetry[dk.key];\r\n            var displayValue = value != null ?\r\n                value + (dk.unit || '') : '--';\r\n            return {\r\n                key: dk.key,\r\n                label: dk.label || dk.key,\r\n                displayValue: displayValue\r\n            };\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Click handler for the machine chip.\r\n     * Instead of pushing a new state (openState), we REPLACE/UPDATE\r\n     * the current state so the URL doesn't accumulate nested states.\r\n     */\r\n    function clickDevice(label) {\r\n        var sc = ctx.stateController;\r\n        if (!sc) {\r\n            console.warn(\r\n                '[FP] State controller not available; cannot update state.'\r\n                );\r\n            return;\r\n        }\r\n        console.log('[FP] clickDevice: clicked', label\r\n            .name);\r\n\r\n        findActiveJobAsset(label, function(\r\n            assetEntityId) {\r\n            if (assetEntityId) {\r\n                var params = {};\r\n                params[CONFIG\r\n                .stateParamName] = {\r\n                    entityId: {\r\n                        entityType: assetEntityId\r\n                            .entityType,\r\n                        id: assetEntityId.id\r\n                    },\r\n                    entityName: label.name,\r\n                    entityLabel: label.id\r\n                };\r\n                params.targetEntityParamName =\r\n                    CONFIG.stateParamName;\r\n\r\n                var currentStateId = sc\r\n                    .getStateId && sc\r\n                    .getStateId();\r\n                var nextStateId = CONFIG\r\n                    .targetStateId || null;\r\n\r\n                console.log(\r\n                    '[FP] Updating state. currentStateId =',\r\n                    currentStateId,\r\n                    ', nextStateId =',\r\n                    nextStateId,\r\n                    ', params =', params);\r\n\r\n                if (nextStateId) {\r\n                    sc.updateState(nextStateId,\r\n                        params, false);\r\n                } else {\r\n                    sc.updateState(null, params,\r\n                        false);\r\n                }\r\n            } else {\r\n                  console.warn('[FP] No active job found; state update cancelled for', label.name);\r\n                  // Hide after 2 seconds, button visible\r\n                  showCenteredMessage('Machine not planned', 1700, true);\r\n                }\r\n        });\r\n    }\r\n};",
      "settingsForm" : [ {
        "id" : "imageUrl",
        "name" : "Background Image",
        "type" : "image",
        "default" : "tb-image;/api/images/tenant/480c9266064172a4f50c40fc682092b5.jpg"
      }, {
        "id" : "groupId",
        "name" : "Device Group ID",
        "type" : "text",
        "defaultValue" : "45504450-ae8f-11f0-a60f-a7f9e67d958a"
      }, {
        "id" : "targetStateId",
        "name" : "Target State ID",
        "type" : "text",
        "defaultValue" : "job_dashboard"
      }, {
        "id" : "stateParamName",
        "name" : "State Parameter Name",
        "type" : "text",
        "defaultValue" : "jobcard"
      }, {
        "id" : "positions",
        "name" : "Label Positions (JSON Array)",
        "type" : "json",
        "defaultValue" : [ {
          "by" : "name",
          "match" : "RUT200-1",
          "x" : 20,
          "y" : 30,
          "label" : "RUT200-1"
        }, {
          "by" : "name",
          "match" : "MACHINE #1",
          "x" : 40,
          "y" : 50,
          "label" : "MACHINE #1"
        }, {
          "by" : "name",
          "match" : "ITL ECU",
          "x" : 60,
          "y" : 70,
          "label" : "ITL ECU"
        } ]
      }, {
        "id" : "dataKeys",
        "name" : "Telemetry Data Keys (JSON Array)",
        "type" : "json",
        "defaultValue" : [ {
          "key" : "runtime_s",
          "label" : "Runtime",
          "formula" : "value/60",
          "decimals" : 1,
          "unit" : " min"
        } ]
      }, {
        "id" : "pollInterval",
        "name" : "Polling Interval (ms)",
        "type" : "number",
        "defaultValue" : 5000
      } ],
      "dataKeySettingsForm" : [ ],
      "settingsDirective" : "",
      "hasBasicMode" : false,
      "defaultConfig" : "{\"datasources\":[{\"type\":\"static\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"rgb(255, 255, 255)\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{\"cardHtml\":\"<div class='card'>HTML code here</div>\",\"cardCss\":\".card {\\n    font-weight: bold;\\n    font-size: 32px;\\n    color: #999;\\n    width: 100%;\\n    height: 100%;\\n    display: flex;\\n    align-items: center;\\n    justify-content: center;\\n}\"},\"title\":\"HTML Card\",\"dropShadow\":true}"
    },
    "externalId" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "3e5ab600-b252-11f0-ba19-01c0db8b26bf"
    },
    "resources" : null,
    "id" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "3e5ab600-b252-11f0-ba19-01c0db8b26bf"
    },
    "scada" : false,
    "tags" : null
  },
  "relations" : [ ],
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}