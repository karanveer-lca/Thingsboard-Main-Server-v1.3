{
  "entityType" : "WIDGET_TYPE",
  "entity" : {
    "fqn" : "ai_summary",
    "name" : "AI Summary",
    "deprecated" : false,
    "image" : null,
    "description" : null,
    "descriptor" : {
      "type" : "static",
      "sizeX" : 7.5,
      "sizeY" : 3,
      "resources" : [ ],
      "templateHtml" : "<style>\r\n  .ai-widget-container {\r\n    position: relative;\r\n    width: 100%;\r\n    height: 100%;\r\n    box-sizing: border-box;\r\n    padding: 8px;\r\n    background: #0b1120;\r\n    color: #0a0a0a;\r\n    font-family: system-ui, -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\r\n  }\r\n\r\n  .ai-corner-button {\r\n    position: absolute;\r\n    top: 8px;\r\n    right: 8px;\r\n    border: none;\r\n    background: #1d4ed8;\r\n    color: #e5e7eb;\r\n    border-radius: 999px;\r\n    width: 36px;\r\n    height: 36px;\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    cursor: pointer;\r\n    box-shadow: 0 8px 16px rgba(15, 23, 42, 0.5);\r\n    transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;\r\n  }\r\n\r\n  .ai-corner-button:hover {\r\n    background: #2563eb;\r\n    transform: translateY(-1px);\r\n    box-shadow: 0 12px 24px rgba(15, 23, 42, 0.7);\r\n  }\r\n\r\n  .ai-corner-button:disabled {\r\n    opacity: 0.6;\r\n    cursor: default;\r\n    transform: none;\r\n    box-shadow: none;\r\n  }\r\n\r\n  .loading-overlay {\r\n    position: absolute;\r\n    inset: 0;\r\n    background: rgba(15, 23, 42, 0.85);\r\n    display: flex;\r\n    flex-direction: column;\r\n    align-items: center;\r\n    justify-content: center;\r\n    z-index: 10;\r\n    font-size: 13px;\r\n  }\r\n\r\n  .spinner {\r\n    width: 24px;\r\n    height: 24px;\r\n    border-radius: 999px;\r\n    border: 3px solid rgba(148, 163, 184, 0.4);\r\n    border-top-color: #38bdf8;\r\n    animation: spin 0.8s linear infinite;\r\n    margin-bottom: 8px;\r\n  }\r\n\r\n  @keyframes spin {\r\n    to {\r\n      transform: rotate(360deg);\r\n    }\r\n  }\r\n\r\n  .content-display {\r\n    position: absolute;\r\n    inset: 0;\r\n    padding: 12px;\r\n    padding-top: 16px;\r\n    overflow: auto;\r\n    box-sizing: border-box;\r\n  }\r\n\r\n  .content-display .placeholder {\r\n    font-size: 13px;\r\n    color: #6b7280;\r\n  }\r\n\r\n  .error-message {\r\n    background: rgba(220, 38, 38, 0.1);\r\n    border: 1px solid rgba(220, 38, 38, 0.6);\r\n    color: #fecaca;\r\n    padding: 8px 10px;\r\n    border-radius: 6px;\r\n    font-size: 12px;\r\n  }\r\n\r\n  .success-message {\r\n    background: rgba(34, 197, 94, 0.1);\r\n    border: 1px solid rgba(34, 197, 94, 0.6);\r\n    color: #bbf7d0;\r\n    padding: 6px 10px;\r\n    border-radius: 6px;\r\n    font-size: 11px;\r\n    margin-bottom: 6px;\r\n  }\r\n</style>\r\n\r\n<div class=\"ai-widget-container\">\r\n  <button id=\"ai-analyze-btn\" class=\"ai-corner-button\" title=\"Run AI Analysis\">\r\n    <!-- Refresh icon -->\r\n    <svg width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" stroke-width=\"2\"\r\n         fill=\"none\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\r\n      <path d=\"M3 4v6h6\"></path>\r\n      <path d=\"M5 10a7 7 0 0 1 12-4l2 2\"></path>\r\n      <path d=\"M21 20v-6h-6\"></path>\r\n      <path d=\"M19 14a7 7 0 0 1-12 4l-2-2\"></path>\r\n    </svg>\r\n  </button>\r\n\r\n  <div id=\"loading-indicator\" class=\"loading-overlay\" style=\"display:none;\">\r\n    <div class=\"spinner\"></div>\r\n    <p>Analyzing with AI...</p>\r\n  </div>\r\n\r\n  <div id=\"ai-content-display\" class=\"content-display\">\r\n    <div class=\"placeholder\">Click the refresh icon to run AI analysis for the current Job Card / Machine.</div>\r\n  </div>\r\n</div>\r\n",
      "templateCss" : ".ai-widget-container {\r\n    position: relative;\r\n    width: 100%;\r\n    height: 100%;\r\n    padding: 20px;\r\n    background: #ffffff;\r\n    overflow: auto;\r\n}\r\n\r\n.ai-corner-button {\r\n    position: absolute;\r\n    top: 10px;\r\n    right: 10px;\r\n    width: 50px;\r\n    height: 50px;\r\n    border-radius: 50%;\r\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n    border: none;\r\n    color: white;\r\n    cursor: pointer;\r\n    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);\r\n    transition: all 0.3s ease;\r\n    z-index: 100;\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n}\r\n\r\n.ai-corner-button:hover {\r\n    transform: scale(1.1);\r\n    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);\r\n}\r\n\r\n.ai-corner-button:active {\r\n    transform: scale(0.95);\r\n}\r\n\r\n.ai-corner-button:disabled {\r\n    opacity: 0.6;\r\n    cursor: not-allowed;\r\n    transform: scale(1);\r\n}\r\n\r\n.loading-overlay {\r\n    position: absolute;\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    background: rgba(255, 255, 255, 0.95);\r\n    display: flex;\r\n    flex-direction: column;\r\n    align-items: center;\r\n    justify-content: center;\r\n    z-index: 99;\r\n}\r\n\r\n.spinner {\r\n    border: 4px solid #f3f3f3;\r\n    border-top: 4px solid #667eea;\r\n    border-radius: 50%;\r\n    width: 50px;\r\n    height: 50px;\r\n    animation: spin 1s linear infinite;\r\n}\r\n\r\n@keyframes spin {\r\n    0% { transform: rotate(0deg); }\r\n    100% { transform: rotate(360deg); }\r\n}\r\n\r\n.loading-overlay p {\r\n    margin-top: 20px;\r\n    color: #667eea;\r\n    font-size: 16px;\r\n    font-weight: 500;\r\n}\r\n\r\n.content-display {\r\n    width: 100%;\r\n    height: calc(100% - 40px);\r\n    margin-top: 60px;\r\n    padding: 20px;\r\n    background: #f8f9fa;\r\n    border-radius: 8px;\r\n    border: 1px solid #e0e0e0;\r\n    overflow-y: auto;\r\n}\r\n\r\n.placeholder {\r\n    color: #999;\r\n    text-align: center;\r\n    padding: 40px 20px;\r\n    font-size: 14px;\r\n}\r\n\r\n.content-display h1, .content-display h2, .content-display h3 {\r\n    color: #333;\r\n    margin-top: 20px;\r\n    margin-bottom: 10px;\r\n}\r\n\r\n.content-display h1 { font-size: 24px; }\r\n.content-display h2 { font-size: 20px; }\r\n.content-display h3 { font-size: 16px; }\r\n\r\n.content-display p {\r\n    color: #555;\r\n    line-height: 1.6;\r\n    margin-bottom: 10px;\r\n}\r\n\r\n.content-display ul, .content-display ol {\r\n    margin-left: 20px;\r\n    margin-bottom: 10px;\r\n}\r\n\r\n.content-display li {\r\n    color: #555;\r\n    line-height: 1.6;\r\n    margin-bottom: 5px;\r\n}\r\n\r\n.content-display pre {\r\n    background: #2d2d2d;\r\n    color: #f8f8f2;\r\n    padding: 15px;\r\n    border-radius: 4px;\r\n    overflow-x: auto;\r\n    margin: 10px 0;\r\n}\r\n\r\n.content-display code {\r\n    background: #f4f4f4;\r\n    padding: 2px 6px;\r\n    border-radius: 3px;\r\n    font-family: 'Courier New', monospace;\r\n}\r\n\r\n.content-display blockquote {\r\n    border-left: 4px solid #667eea;\r\n    padding-left: 15px;\r\n    margin: 15px 0;\r\n    color: #666;\r\n    font-style: italic;\r\n}\r\n\r\n.error-message {\r\n    background: #fff3cd;\r\n    border: 1px solid #ffc107;\r\n    color: #856404;\r\n    padding: 15px;\r\n    border-radius: 4px;\r\n    margin: 10px 0;\r\n}\r\n\r\n.success-message {\r\n    background: #d4edda;\r\n    border: 1px solid #28a745;\r\n    color: #155724;\r\n    padding: 15px;\r\n    border-radius: 4px;\r\n    margin: 10px 0;\r\n}",
      "controllerScript" : "// === AI Analysis Widget (Job Card / Machine dynamic) ===\r\n//\r\n// - Uses targetEntitySource setting:\r\n//    * \"jobcard\": ASSET from stateParams.jobcard.entityId\r\n//    * \"machine\": DEVICE from stateParams.machineId,\r\n//                 or from jobcard.entityLabel (your pattern: deviceId stored in label)\r\n// - Fetches latest telemetry for that entity and sends it to n8n.\r\n// - Stores AI JSON/text response as an attribute on that same entity.\r\n\r\nlet currentTelemetryData = {};\r\nlet targetEntityInfo = null; // { id, entityType, name }\r\n\r\n// -------------------------\r\n// Lifecycle\r\n// -------------------------\r\n\r\nself.onInit = function() {\r\n    const analyzeBtn = document.getElementById('ai-analyze-btn');\r\n    if (analyzeBtn) {\r\n        analyzeBtn.addEventListener('click', runAIAnalysis);\r\n    }\r\n\r\n    updateTargetEntityFromState();\r\n    loadExistingAttribute();\r\n};\r\n\r\nself.onDataUpdated = function() {\r\n    const data = self.ctx.data;\r\n    if (data && data.length > 0) {\r\n        currentTelemetryData = {};\r\n        data.forEach(function(dataSource) {\r\n            if (dataSource.data && dataSource.data.length > 0) {\r\n                const latestPoint = dataSource.data[dataSource.data.length - 1];\r\n                currentTelemetryData[dataSource.dataKey.name] = latestPoint[1];\r\n            }\r\n        });\r\n    }\r\n\r\n    updateTargetEntityFromState();\r\n    loadExistingAttribute();\r\n};\r\n\r\n// -------------------------\r\n// Entity resolution helpers\r\n// -------------------------\r\n\r\n// Normalizes most TB-style state params into { id, entityType, name }\r\nfunction normalizeStateEntity(raw, defaultType, defaultName) {\r\n    if (!raw) return null;\r\n\r\n    // Shape 1: { id, entityType, name/label }\r\n    if (raw.id && raw.entityType) {\r\n        return {\r\n            id: raw.id,\r\n            entityType: raw.entityType,\r\n            name: raw.name || raw.label || defaultName\r\n        };\r\n    }\r\n\r\n    // Shape 2: { entityId: { entityType, id }, entityName, entityLabel }\r\n    if (raw.entityId && raw.entityId.id && raw.entityId.entityType) {\r\n        return {\r\n            id: raw.entityId.id,\r\n            entityType: raw.entityId.entityType,\r\n            name: raw.entityName || raw.entityLabel || defaultName\r\n        };\r\n    }\r\n\r\n    return null;\r\n}\r\n\r\n// Special: when in MACHINE mode but only jobcard is present,\r\n// treat jobcard.entityLabel as the DEVICE ID and entityName as the display name.\r\nfunction resolveMachineEntityFromState(stateParams) {\r\n    // 1) Proper machineId param if present\r\n    const machineParam = stateParams.machineId;\r\n    let entity = normalizeStateEntity(machineParam, 'DEVICE', 'Machine');\r\n    if (entity) {\r\n        return entity;\r\n    }\r\n\r\n    // 2) Fallback: derive device from jobcard param (your current pattern)\r\n    const jobcardParam = stateParams.jobcard;\r\n    if (jobcardParam && jobcardParam.entityLabel) {\r\n        return {\r\n            id: jobcardParam.entityLabel,          // DEVICE UUID hidden in label\r\n            entityType: 'DEVICE',\r\n            name: jobcardParam.entityName || 'Machine'\r\n        };\r\n    }\r\n\r\n    return null;\r\n}\r\n\r\nfunction updateTargetEntityFromState() {\r\n    const settings = self.ctx.settings || {};\r\n    const mode = settings.targetEntitySource || 'jobcard';\r\n\r\n    const stateParams =\r\n        (self.ctx.stateController &&\r\n         self.ctx.stateController.getStateParams &&\r\n         self.ctx.stateController.getStateParams()) ||\r\n        self.ctx.stateParams ||\r\n        {};\r\n\r\n    let entity = null;\r\n\r\n    if (mode === 'jobcard') {\r\n        // Pure job card: ASSET from jobcard.entityId\r\n        entity = normalizeStateEntity(stateParams.jobcard, 'ASSET', 'Job Card');\r\n    } else if (mode === 'machine') {\r\n        // Machine mode: DEVICE from machineId, or from jobcard.entityLabel\r\n        entity = resolveMachineEntityFromState(stateParams);\r\n    }\r\n\r\n    targetEntityInfo = entity;\r\n\r\n    console.log('[AI Widget] mode =', mode,\r\n        'stateParams =', stateParams,\r\n        'targetEntityInfo =', targetEntityInfo);\r\n}\r\n\r\nfunction requireTargetEntityOrError() {\r\n    if (!targetEntityInfo) {\r\n        updateTargetEntityFromState();\r\n    }\r\n\r\n    if (!targetEntityInfo) {\r\n        const settings = self.ctx.settings || {};\r\n        const mode = settings.targetEntitySource || 'jobcard';\r\n\r\n        if (mode === 'machine') {\r\n            displayError(\r\n                'AI target entity is set to \"Machine\", but no device could be resolved. ' +\r\n                'Expected either a \"machineId\" state parameter or a jobcard with entityLabel = device id.'\r\n            );\r\n        } else {\r\n            displayError(\r\n                'AI target entity is set to \"Job Card\", but no \"jobcard\" state parameter was found.'\r\n            );\r\n        }\r\n\r\n        console.error('[AI Widget] No entity resolved for mode =', mode);\r\n        return null;\r\n    }\r\n\r\n    return targetEntityInfo;\r\n}\r\n\r\n// -------------------------\r\n// Attribute load/save\r\n// -------------------------\r\n\r\nfunction loadExistingAttribute() {\r\n    const settings = self.ctx.settings || {};\r\n    const attributeName = settings.attributeName || 'ai_response';\r\n    const attributeScope = settings.attributeScope || 'SERVER_SCOPE';\r\n\r\n    const entity = requireTargetEntityOrError();\r\n    if (!entity) return;\r\n\r\n    self.ctx.attributeService.getEntityAttributes(\r\n        { entityType: entity.entityType, id: entity.id },\r\n        attributeScope,\r\n        [attributeName]\r\n    ).subscribe(\r\n        function(attributeData) {\r\n            if (attributeData && attributeData.length > 0) {\r\n                const content = attributeData[0].value;\r\n                displayContent(content);\r\n            }\r\n        },\r\n        function(error) {\r\n            console.error('Error loading existing attribute:', error);\r\n        }\r\n    );\r\n}\r\n\r\nfunction saveAttributeToEntity(entityType, entityId, attributeName, value, scope) {\r\n    const attributeData = [{\r\n        key: attributeName,\r\n        value: value\r\n    }];\r\n\r\n    return new Promise(function(resolve, reject) {\r\n        self.ctx.attributeService.saveEntityAttributes(\r\n            { entityType: entityType, id: entityId },\r\n            scope,\r\n            attributeData\r\n        ).subscribe(\r\n            function() {\r\n                console.log('AI attribute saved successfully on', entityType, entityId);\r\n                resolve();\r\n            },\r\n            function(error) {\r\n                console.error('Error saving attribute:', error);\r\n                reject(error);\r\n            }\r\n        );\r\n    });\r\n}\r\n\r\n// -------------------------\r\n// Telemetry fetch (generic entity)\r\n// -------------------------\r\n\r\nfunction fetchEntityTelemetry(entityType, entityId) {\r\n    return new Promise(function(resolve, reject) {\r\n        const url = '/api/plugins/telemetry/' + entityType + '/' + entityId + '/values/timeseries?keys=';\r\n\r\n        self.ctx.http.get(url).subscribe(\r\n            function(telemetryData) {\r\n                const flatData = {};\r\n                for (var key in telemetryData) {\r\n                    if (telemetryData.hasOwnProperty(key) && telemetryData[key].length > 0) {\r\n                        flatData[key] = telemetryData[key][0].value;\r\n                    }\r\n                }\r\n                resolve(flatData);\r\n            },\r\n            function(error) {\r\n                console.error('Error fetching telemetry:', error);\r\n                reject(error);\r\n            }\r\n        );\r\n    });\r\n}\r\n\r\n// -------------------------\r\n// AI call helpers\r\n// -------------------------\r\n\r\n// Helper: parse server text that might be JSON or a ```json fenced block\r\nfunction parsePossiblyFencedJSON(text) {\r\n    try { return { parsed: JSON.parse(text) }; } catch (_) {}\r\n\r\n    const cleaned = text.trim()\r\n        .replace(/^```(?:json)?\\s*/i, '')\r\n        .replace(/```$/, '');\r\n\r\n    try { return { parsed: JSON.parse(cleaned) }; } catch (_) {}\r\n\r\n    const match = cleaned.match(/\\{[\\s\\S]*\\}/);\r\n    if (match) {\r\n        try { return { parsed: JSON.parse(match[0]) }; } catch (_) {}\r\n    }\r\n    return { text };\r\n}\r\n\r\nfunction runAIAnalysis() {\r\n    const analyzeBtn = document.getElementById('ai-analyze-btn');\r\n    const loadingIndicator = document.getElementById('loading-indicator');\r\n\r\n    const settings = self.ctx.settings || {};\r\n    const n8nUrl = settings.n8nUrl;\r\n    const attributeName = settings.attributeName || 'ai_response';\r\n    const attributeScope = settings.attributeScope || 'SERVER_SCOPE';\r\n    const requestMethod = settings.requestMethod || 'POST';\r\n    const includePayload = settings.includePayload !== false;\r\n\r\n    if (!n8nUrl) {\r\n        displayError('n8n URL is not configured. Please configure the widget settings.');\r\n        return;\r\n    }\r\n\r\n    const entity = requireTargetEntityOrError();\r\n    if (!entity) return;\r\n\r\n    const entityId = entity.id;\r\n    const entityType = entity.entityType;\r\n\r\n    analyzeBtn.disabled = true;\r\n    loadingIndicator.style.display = 'flex';\r\n\r\n    fetchEntityTelemetry(entityType, entityId)\r\n        .then(function(telemetryData) {\r\n            var urlWithParams = n8nUrl;\r\n\r\n            if (requestMethod === 'GET' && includePayload) {\r\n                var params = new URLSearchParams();\r\n                for (var key in telemetryData) {\r\n                    if (telemetryData.hasOwnProperty(key)) {\r\n                        params.append(key, telemetryData[key]);\r\n                    }\r\n                }\r\n                urlWithParams = n8nUrl + '?' + params.toString();\r\n            }\r\n\r\n            const requestOptions = {\r\n                method: requestMethod,\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                    'Accept': 'application/json,text/plain;q=0.9,*/*;q=0.8'\r\n                }\r\n            };\r\n\r\n            if (requestMethod === 'POST' && includePayload) {\r\n                requestOptions.body = JSON.stringify({\r\n                    telemetry: telemetryData,\r\n                    timestamp: Date.now(),\r\n                    entityId: entityId,\r\n                    entityType: entityType\r\n                });\r\n            }\r\n\r\n            return fetch(urlWithParams, requestOptions);\r\n        })\r\n        .then(function(response) {\r\n            if (!response.ok) {\r\n                throw new Error('HTTP error! status: ' + response.status);\r\n            }\r\n            return response.text();\r\n        })\r\n        .then(function(text) {\r\n            const parsedResult = parsePossiblyFencedJSON(text);\r\n            const result = (parsedResult.parsed !== undefined) ? parsedResult.parsed : parsedResult.text;\r\n\r\n            var aiResponse;\r\n            if (typeof result === 'string') {\r\n                aiResponse = result;\r\n            } else if (result && typeof result === 'object') {\r\n                if (result.response) {\r\n                    aiResponse = result.response;\r\n                } else if (result.data) {\r\n                    aiResponse = result.data;\r\n                } else {\r\n                    aiResponse = JSON.stringify(result, null, 2);\r\n                }\r\n            } else {\r\n                aiResponse = String(result);\r\n            }\r\n\r\n            return saveAttributeToEntity(entityType, entityId, attributeName, aiResponse, attributeScope)\r\n                .then(function() { return aiResponse; });\r\n        })\r\n        .then(function(aiResponse) {\r\n            displayContent(aiResponse);\r\n            showSuccessMessage('AI analysis completed and saved successfully!');\r\n        })\r\n        .catch(function(error) {\r\n            console.error('Error during AI analysis:', error);\r\n            displayError('Failed to complete AI analysis: ' + error.message);\r\n        })\r\n        .finally(function() {\r\n            analyzeBtn.disabled = false;\r\n            loadingIndicator.style.display = 'none';\r\n        });\r\n}\r\n\r\n// -------------------------\r\n// Rendering helpers\r\n// -------------------------\r\n\r\nfunction escapeHtml(str) {\r\n    if (str === null || str === undefined) return '';\r\n    return String(str)\r\n        .replace(/&/g, '&amp;')\r\n        .replace(/</g, '&lt;')\r\n        .replace(/>/g, '&gt;')\r\n        .replace(/\"/g, '&quot;')\r\n        .replace(/'/g, '&#39;');\r\n}\r\n\r\nfunction formatList(items) {\r\n    if (!items || !items.length) {\r\n        return '<p style=\"margin: 4px 0 12px; font-size: 12px; color: #888;\">No data.</p>';\r\n    }\r\n    var html = '<ul style=\"margin: 4px 0 12px 18px; padding: 0; font-size: 13px;\">';\r\n    items.forEach(function(item) {\r\n        html += '<li>' + escapeHtml(item) + '</li>';\r\n    });\r\n    html += '</ul>';\r\n    return html;\r\n}\r\n\r\nfunction formatAnalysisHtml(result) {\r\n    var urgency = (result.urgencyLevel || '').toString().toUpperCase();\r\n    var urgencyColor = '#28a745';\r\n    if (urgency === 'MEDIUM') urgencyColor = '#ffc107';\r\n    else if (urgency === 'HIGH') urgencyColor = '#fd7e14';\r\n    else if (urgency === 'CRITICAL') urgencyColor = '#dc3545';\r\n\r\n    var metrics = result.metrics || {};\r\n\r\n    function row(label, value) {\r\n        if (!value) return '';\r\n        return '<tr>' +\r\n            '<td style=\"border: 1px solid #ddd; padding: 4px 8px; font-weight: 600;\">' +\r\n                escapeHtml(label) + '</td>' +\r\n            '<td style=\"border: 1px solid #ddd; padding: 4px 8px;\">' +\r\n                escapeHtml(value) + '</td>' +\r\n        '</tr>';\r\n    }\r\n\r\n    var metricsHtml =\r\n        '<table style=\"border-collapse: collapse; margin-top: 4px; margin-bottom: 12px; font-size: 12px;\">' +\r\n            row('Total downtime', metrics.totalDowntime) +\r\n            row('Most problematic alarm', metrics.mostProblematicAlarm) +\r\n            row('Estimated production loss', metrics.estimatedProductionLoss) +\r\n        '</table>';\r\n\r\n    var html =\r\n        '<div>' +\r\n            '<div style=\"margin-bottom: 10px; font-size: 13px;\">' +\r\n                '<span style=\"font-weight: 600;\">Urgency: </span>' +\r\n                '<span style=\"font-weight: 700; color: ' + urgencyColor + ';\">' +\r\n                    escapeHtml(urgency || 'N/A') +\r\n                '</span>' +\r\n            '</div>' +\r\n\r\n            '<h3 style=\"margin: 4px 0; font-size: 15px;\">‚öôÔ∏è Summary</h3>' +\r\n            '<p style=\"margin: 4px 0 12px; font-size: 13px;\">' +\r\n                escapeHtml(result.summary || 'No summary provided.') +\r\n            '</p>' +\r\n\r\n            '<h3 style=\"margin: 4px 0; font-size: 15px;\">üö® Critical issues</h3>' +\r\n            formatList(result.criticalIssues) +\r\n\r\n            '<h3 style=\"margin: 4px 0; font-size: 15px;\">üìä Key metrics</h3>' +\r\n            metricsHtml +\r\n\r\n            '<h3 style=\"margin: 4px 0; font-size: 15px;\">üõ† Recommendations</h3>' +\r\n            formatList(result.recommendations) +\r\n\r\n            '<h3 style=\"margin: 4px 0; font-size: 15px;\">üîÆ Predictions</h3>' +\r\n            '<p style=\"margin: 4px 0 12px; font-size: 13px;\">' +\r\n                escapeHtml(result.predictions || 'No predictions provided.') +\r\n            '</p>' +\r\n        '</div>';\r\n\r\n    return html;\r\n}\r\n\r\nfunction displayContent(content) {\r\n    const contentDisplay = document.getElementById('ai-content-display');\r\n\r\n    var bodyHtml = '';\r\n    var parsed = null;\r\n\r\n    if (typeof content === 'string') {\r\n        try {\r\n            parsed = JSON.parse(content);\r\n        } catch (e) {\r\n            parsed = null;\r\n        }\r\n    } else if (content && typeof content === 'object') {\r\n        parsed = content;\r\n    }\r\n\r\n    var looksLikeAnalysis =\r\n        parsed &&\r\n        typeof parsed === 'object' &&\r\n        (parsed.summary || parsed.metrics || parsed.criticalIssues || parsed.recommendations);\r\n\r\n    if (looksLikeAnalysis) {\r\n        bodyHtml = formatAnalysisHtml(parsed);\r\n    } else {\r\n        var formattedContent;\r\n        try {\r\n            const parsedFallback = JSON.parse(content);\r\n            formattedContent = '<pre>' + JSON.stringify(parsedFallback, null, 2) + '</pre>';\r\n        } catch (e) {\r\n            formattedContent = String(content)\r\n                .replace(/&/g, '&amp;')\r\n                .replace(/</g, '&lt;')\r\n                .replace(/>/g, '&gt;')\r\n                .replace(/\\n/g, '<br>')\r\n                .replace(/\\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');\r\n        }\r\n        bodyHtml = '<div>' + formattedContent + '</div>';\r\n    }\r\n\r\n    contentDisplay.innerHTML =\r\n        '<div style=\"color: #28a745; font-size: 12px; margin-bottom: 10px;\">' +\r\n            'Last updated: ' + new Date().toLocaleString() +\r\n        '</div>' +\r\n        bodyHtml;\r\n}\r\n\r\nfunction displayError(message) {\r\n    const contentDisplay = document.getElementById('ai-content-display');\r\n    contentDisplay.innerHTML =\r\n        '<div class=\"error-message\">' +\r\n        '<strong>Error:</strong> ' + escapeHtml(message) +\r\n        '</div>';\r\n}\r\n\r\nfunction showSuccessMessage(message) {\r\n    const contentDisplay = document.getElementById('ai-content-display');\r\n    const successDiv = document.createElement('div');\r\n    successDiv.className = 'success-message';\r\n    successDiv.textContent = message;\r\n    contentDisplay.insertBefore(successDiv, contentDisplay.firstChild);\r\n\r\n    setTimeout(function() {\r\n        successDiv.remove();\r\n    }, 3000);\r\n}\r\n",
      "settingsForm" : [ {
        "id" : "n8nUrl",
        "name" : "n8n Webhook URL",
        "type" : "text",
        "default" : "https://your-n8n-instance.com/webhook/ai-analysis"
      }, {
        "id" : "deviceId",
        "name" : "Device ID (for telemetry)",
        "type" : "text"
      }, {
        "id" : "assetId",
        "name" : "Asset ID (to save response)",
        "type" : "text"
      }, {
        "id" : "attributeName",
        "name" : "Attribute Name",
        "type" : "text",
        "default" : "ai_response"
      }, {
        "id" : "attributeScope",
        "name" : "Attribute Scope",
        "type" : "text",
        "default" : "SERVER_SCOPE"
      }, {
        "id" : "requestMethod",
        "name" : "Request Method",
        "type" : "text",
        "default" : "GET"
      }, {
        "id" : "includePayload",
        "name" : "Include Telemetry Data",
        "type" : "boolean",
        "default" : true
      }, {
        "id" : "targetEntitySource",
        "name" : "Target Source of data",
        "type" : "select",
        "default" : "jobcard",
        "items" : [ {
          "value" : "jobcard",
          "label" : "Job Card"
        }, {
          "value" : "machine",
          "label" : "Machine"
        } ]
      } ],
      "settingsDirective" : "",
      "defaultConfig" : "{\"datasources\":[{\"type\":\"static\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"rgb(255, 255, 255)\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{\"cardHtml\":\"<div class='card'>HTML code here</div>\",\"cardCss\":\".card {\\n    font-weight: bold;\\n    font-size: 32px;\\n    color: #999;\\n    width: 100%;\\n    height: 100%;\\n    display: flex;\\n    align-items: center;\\n    justify-content: center;\\n}\"},\"title\":\"HTML Card\",\"dropShadow\":true}"
    },
    "externalId" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "de3b6c10-b7e7-11f0-a460-01c0db8b26bf"
    },
    "resources" : null,
    "id" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "de3b6c10-b7e7-11f0-a460-01c0db8b26bf"
    },
    "scada" : false,
    "tags" : null
  },
  "relations" : [ ],
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}