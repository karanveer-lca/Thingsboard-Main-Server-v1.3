{
  "entityType" : "WIDGET_TYPE",
  "entity" : {
    "fqn" : "dynamic_param2",
    "name" : "Dynamic_param",
    "deprecated" : false,
    "image" : null,
    "description" : null,
    "descriptor" : {
      "type" : "static",
      "sizeX" : 7.5,
      "sizeY" : 3,
      "resources" : [ ],
      "templateCss" : "",
      "settingsForm" : [ ],
      "templateHtml" : "<div id=\"vm-root\" style=\"height:100%;display:flex;flex-direction:column;\">\r\n  <div style=\"display:flex;gap:8px;align-items:center;margin-bottom:8px;\">\r\n    <label>Meter:</label>\r\n    <input id=\"vm-meter\" type=\"number\" min=\"1\" step=\"1\" style=\"width:90px\" />\r\n    <button id=\"vm-apply\">Load</button>\r\n    <span id=\"vm-status\" style=\"opacity:.6;margin-left:8px;\"></span>\r\n  </div>\r\n\r\n  <table style=\"width:100%;border-collapse:collapse;\">\r\n    <thead>\r\n      <tr>\r\n        <th style=\"text-align:left;padding:6px;border-bottom:1px solid #ddd;\">Tag</th>\r\n        <th style=\"text-align:left;padding:6px;border-bottom:1px solid #ddd;\">Latest</th>\r\n      </tr>\r\n    </thead>\r\n    <tbody id=\"vm-body\"></tbody>\r\n  </table>\r\n</div>\r\n    ",
      "defaultConfig" : "{\"datasources\":[{\"type\":\"static\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"Random\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.15479322438769105,\"funcBody\":\"var value = prevValue + Math.random() * 100 - 50;\\nvar multiplier = Math.pow(10, 2 || 0);\\nvar value = Math.round(value * multiplier) / multiplier;\\nif (value < -1000) {\\n\\tvalue = -1000;\\n} else if (value > 1000) {\\n\\tvalue = 1000;\\n}\\nreturn value;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"rgb(255, 255, 255)\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{\"cardHtml\":\"<div class='card'>HTML code here</div>\",\"cardCss\":\".card {\\n    font-weight: bold;\\n    font-size: 32px;\\n    color: #999;\\n    width: 100%;\\n    height: 100%;\\n    display: flex;\\n    align-items: center;\\n    justify-content: center;\\n}\"},\"title\":\"Dynamic_param\",\"dropShadow\":true}",
      "controllerScript" : "// ===== Settings schema =====\r\nself.getSettingsSchema = function () {\r\n  return {\r\n    schema: {\r\n      type: 'object',\r\n      properties: {\r\n        deviceAliasName: { title: 'Device alias name', type: 'string', default: 'EMS Device' },\r\n        deviceId:        { title: 'Fallback Device ID (UUID)', type: 'string', default: '4d4d2300-6f90-11f0-85b0-a7bdbee2d4e9' },\r\n        prefix:          { title: 'Key prefix', type: 'string', default: '60E85B1B96ED' },\r\n        tagsCsv:         { title: 'Tag IDs (CSV)', type: 'string', default: '2001,2002,2003,5001,6001' },\r\n        initialMeter:    { title: 'Initial meter', type: 'number', default: 1 }\r\n      },\r\n      required: ['prefix','tagsCsv']\r\n    },\r\n    form: ['deviceAliasName','deviceId','prefix','tagsCsv','initialMeter']\r\n  };\r\n};\r\n\r\nself.typeParameters = function () {\r\n  return { maxDatasources: 0, datasourcesOptional: true, dataKeysOptional: true, hideDataSettings: true };\r\n};\r\n\r\n// ---------- helpers ----------\r\nfunction escapeHtml(s) {\r\n  s = String(s);\r\n  return s.replace(/[&<>\"']/g, function (c) {\r\n    var map = {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;'};\r\n    return map[c] || c;\r\n  });\r\n}\r\n\r\nfunction setStatus(t) {\r\n  var el = self.ctx.$container[0].querySelector('#vm-status');\r\n  if (el) el.textContent = t || '';\r\n}\r\n\r\nfunction buildDataKeys(prefix, meter, tags) {\r\n  var list = [];\r\n  for (var i=0; i<tags.length; i++) {\r\n    var tag = tags[i];\r\n    list.push({ name: prefix + '_' + meter + '_' + tag, label: String(tag), type: 'timeseries', settings: {} });\r\n  }\r\n  return list;\r\n}\r\n\r\nfunction renderLatest(data) {\r\n  var tbody = self.ctx.$container[0].querySelector('#vm-body');\r\n  var rows = [];\r\n  data = data || [];\r\n  for (var i=0; i<data.length; i++) {\r\n    var d = data[i];\r\n    var label = escapeHtml(d.dataKey && d.dataKey.label || '');\r\n    var pts = Array.isArray(d.data) ? d.data : [];\r\n    var latest = pts.length ? pts[pts.length-1][1] : '—';\r\n    rows.push('<tr><td style=\"padding:6px;border-bottom:1px solid #f0f0f0;\">' + label +\r\n              '</td><td style=\"padding:6px;border-bottom:1px solid #f0f0f0;\">' + escapeHtml(latest) + '</td></tr>');\r\n  }\r\n  tbody.innerHTML = rows.join('');\r\n  self.ctx.detectChanges();\r\n}\r\n\r\n// Try to resolve alias id by name across TB variants\r\nfunction findAliasIdByName(name) {\r\n  if (!name) return null;\r\n\r\n  // 1) Typical map: ctx.aliases[name].id\r\n  if (self.ctx.aliases && self.ctx.aliases[name] && self.ctx.aliases[name].id) {\r\n    return self.ctx.aliases[name].id;\r\n  }\r\n\r\n  // 2) Scan ctx.aliases for {alias/name}\r\n  if (self.ctx.aliases) {\r\n    for (var k in self.ctx.aliases) {\r\n      if (!self.ctx.aliases.hasOwnProperty(k)) continue;\r\n      var a = self.ctx.aliases[k];\r\n      if (a && (a.alias === name || a.name === name)) return a.id || k;\r\n    }\r\n  }\r\n\r\n  // 3) Dashboard configuration\r\n  var cfg = (self.ctx.dashboard && self.ctx.dashboard.configuration && self.ctx.dashboard.configuration.entityAliases) ||\r\n            (self.ctx.$scope && self.ctx.$scope.dashboardCtrl && self.ctx.$scope.dashboardCtrl.dashboard &&\r\n             self.ctx.$scope.dashboardCtrl.dashboard.configuration &&\r\n             self.ctx.$scope.dashboardCtrl.dashboard.configuration.entityAliases);\r\n  if (cfg) {\r\n    for (var id in cfg) {\r\n      if (!cfg.hasOwnProperty(id)) continue;\r\n      var ai = cfg[id];\r\n      if (ai && (ai.alias === name || ai.name === name)) return id;\r\n    }\r\n  }\r\n\r\n  // 4) Alias controller\r\n  if (self.ctx.aliasController && typeof self.ctx.aliasController.getEntityAliasId === 'function') {\r\n    try {\r\n      var id2 = self.ctx.aliasController.getEntityAliasId(name);\r\n      if (id2) return id2;\r\n    } catch (e) {}\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nfunction resolveDatasourceTarget(settings) {\r\n  var aliasName = settings.deviceAliasName || 'EMS Device';\r\n  var aliasId = findAliasIdByName(aliasName);\r\n  if (aliasId) return { byAlias: true, id: aliasId };\r\n\r\n  var deviceId = (settings.deviceId || '').trim();\r\n  if (deviceId) return { byAlias: false, id: deviceId };\r\n\r\n  return null;\r\n}\r\n\r\n// ---------- core ----------\r\nself.subscribeFor = function (meter) {\r\n  // remove old sub\r\n  if (self.subscription) {\r\n    self.ctx.subscriptionApi.removeSubscription(self.subscription.id);\r\n    self.subscription = null;\r\n  }\r\n\r\n  var s = self.ctx.settings || {};\r\n  var prefix = s.prefix || '60E85B1B96ED';\r\n  var tags = (s.tagsCsv || '2001,2002,2003,5001,6001').split(','); \r\n  for (var i=0;i<tags.length;i++) tags[i] = tags[i].trim();\r\n  tags = tags.filter(function(x){ return x.length; });\r\n\r\n  var target = resolveDatasourceTarget(s);\r\n  if (!target) {\r\n    setStatus('Alias not found: ' + (s.deviceAliasName || 'EMS Device') + ' (and no fallback Device ID set)');\r\n    return;\r\n  }\r\n\r\n  var datasource = { type: 'entity', dataKeys: buildDataKeys(prefix, meter, tags) };\r\n  if (target.byAlias) {\r\n    datasource.entityAliasId = target.id;\r\n  } else {\r\n    datasource.entityFilter = { type: 'singleEntity', singleEntity: { id: target.id, entityType: 'DEVICE' } };\r\n  }\r\n\r\n  var options = {\r\n    type: 'timeseries',\r\n    useDashboardTimewindow: true,\r\n    datasources: [ datasource ],\r\n    callbacks: {\r\n      onDataUpdated: function (sub) { self.subscription = sub; setStatus('Meter ' + meter + ' subscribed'); renderLatest(sub.data); },\r\n      onDataUpdateError: function () { setStatus('Subscription error'); },\r\n      timeWindowUpdated: function () { /* optional */ }\r\n    }\r\n  };\r\n\r\n  self.subscription = self.ctx.subscriptionApi.createSubscription(options, true);\r\n  self.ctx.widgetTitle = 'Meter ' + meter + ' — dynamic keys';\r\n  if (self.ctx.updateWidgetParams) self.ctx.updateWidgetParams();\r\n};\r\n\r\nself.onInit = function () {\r\n  var cont = self.ctx.$container[0];\r\n  var settings = self.ctx.settings || {};\r\n  var initMeter = Number(settings.initialMeter || 1);\r\n\r\n  cont.querySelector('#vm-meter').value = String(initMeter);\r\n  cont.querySelector('#vm-apply').addEventListener('click', function () {\r\n    var m = Number(cont.querySelector('#vm-meter').value || 1);\r\n    self.subscribeFor(m);\r\n  });\r\n\r\n  // Give TB a moment to expose aliases on first load\r\n  setTimeout(function(){ self.subscribeFor(initMeter); }, 250);\r\n};\r\n\r\nself.onDestroy = function () {\r\n  if (self.subscription) {\r\n    self.ctx.subscriptionApi.removeSubscription(self.subscription.id);\r\n    self.subscription = null;\r\n  }\r\n};\r\n",
      "settingsDirective" : "tb-html-card-widget-settings",
      "dataKeySettingsForm" : [ ]
    },
    "externalId" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "d79734a0-9282-11f0-8111-6db5412d1741"
    },
    "resources" : null,
    "id" : {
      "entityType" : "WIDGET_TYPE",
      "id" : "d79734a0-9282-11f0-8111-6db5412d1741"
    },
    "scada" : false,
    "tags" : null
  },
  "relations" : [ ],
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}